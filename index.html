<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D.Z. Mariposa NLP v8 - Critical Response Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --mariposa-pink: #ff85a2; --mariposa-hot: #d63384;
            --mariposa-black: #121212; --mariposa-dark-grey: #1e1e1e;
            --white: #ffffff; --critical: #ff4757; --pos: #2ed573; 
        }
        
        body { font-family: 'Inter', sans-serif; background: var(--mariposa-black); margin: 0; color: var(--white); overflow-x: hidden; }
        .full-width { max-width: 100% !important; margin: 0 !important; }
        
        /* Alert Pulse Animation */
        @keyframes criticalPulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(255, 71, 87, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
        }
        .critical-alert-active { animation: criticalPulse 1.5s infinite; border: 2px solid var(--critical) !important; }

        .navbar { 
            background: linear-gradient(90deg, #000 0%, var(--mariposa-dark-grey) 100%); 
            color: var(--mariposa-pink); padding: 15px 25px; display: flex; 
            justify-content: space-between; align-items: center; border-bottom: 2px solid var(--mariposa-hot);
            position: sticky; top: 0; z-index: 1000; 
        }

        .logo-area { display: flex; align-items: center; gap: 10px; font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 900; }
        .container { max-width: 1350px; margin: 20px auto; padding: 0 15px; }
        .dashboard-grid { display: grid; grid-template-columns: 450px 1fr; gap: 20px; }
        
        .card { 
            background: var(--mariposa-dark-grey); border-radius: 15px; padding: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 20px; 
            border: 1px solid rgba(255,133,162,0.1); transition: 0.3s;
        }

        textarea { 
            width: 100%; height: 140px; border: 1px solid #333; border-radius: 10px; 
            padding: 15px; background: #000; color: #fff; outline: none; font-size: 14px;
        }
        
        .btn { padding: 12px 20px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn-main { background: var(--mariposa-hot); color: white; width: 100%; margin-top: 10px; }

        .keyword-cloud { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; }
        .k-tag { background: #000; border: 1px solid var(--mariposa-hot); color: var(--mariposa-pink); padding: 5px 12px; border-radius: 20px; font-size: 11px; }

        .response-card { background: #000; border: 1px solid var(--mariposa-hot); padding: 15px; border-radius: 12px; margin-top: 15px; position: relative; }
        .conversion-badge { position: absolute; top: -10px; right: 15px; background: var(--mariposa-hot); color: #fff; font-size: 10px; padding: 4px 12px; border-radius: 20px; font-weight: 900; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #000; border-radius: 10px; overflow: hidden; }
        th { background: #222; color: var(--mariposa-pink); padding: 12px; font-size: 11px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #222; font-size: 13px; }

        .search-container { display: flex; gap: 10px; margin-bottom: 15px; }
        .search-box { flex-grow: 1; background: #000; border: 1px solid #333; color: white; padding: 10px; border-radius: 8px; }
        
        .alert-banner { display: none; background: var(--critical); color: white; padding: 10px; text-align: center; font-weight: bold; border-radius: 8px; margin-bottom: 15px; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo-area">üå∫ D.Z. MARIPOSA NLP</div>
        <div style="display:flex; gap:10px;">
            <button class="btn" style="background:var(--mariposa-dark-grey); color:white" onclick="toggleFit()">üì± Fit Screen</button>
            <button class="btn" style="background:var(--pos); color:black" onclick="exportToExcel()">üì• Export Report</button>
        </div>
    </nav>

    <div class="container" id="mainContainer">
        <div id="criticalBanner" class="alert-banner">‚ö†Ô∏è CRITICAL ISSUE DETECTED: ACTION REQUIRED IMMEDIATELY</div>
        
        <div class="dashboard-grid">
            <div class="sidebar">
                <div class="card" id="inputCard">
                    <h3 style="margin-top:0; color:var(--mariposa-pink)">Deep Sentiment Intake</h3>
                    <textarea id="reviewInput" placeholder="Paste reviews for real-time analysis..."></textarea>
                    <button class="btn btn-main" onclick="processAnalysis()">‚ú® ANALYZE INTENT</button>
                    <center><button class="btn" style="background:transparent; color:#666; font-size:11px; margin-top:10px;" onclick="clearDatabase()">Wipe History</button></center>
                </div>

                <div class="card">
                    <h3 style="margin:0; font-size: 16px; color:var(--mariposa-pink)">
                        Sentiment Trend
                        <span id="growthIndicator" style="font-size: 11px; margin-left:10px;"></span>
                    </h3>
                    <div style="height:200px;"><canvas id="lineChart"></canvas></div>
                </div>

                <div class="card">
                    <h3 style="margin:0; font-size: 14px; color:var(--mariposa-pink)">Trending Keywords</h3>
                    <div id="keywordCloud" class="keyword-cloud"></div>
                </div>
            </div>

            <div class="main-content">
                <div class="card">
                    <h3 style="margin:0 0 15px 0; color:var(--mariposa-pink)">Actionable Insights & Resolution Hub</h3>
                    <table>
                        <thead>
                            <tr>
                                <th width="30%">Painpoint Category</th>
                                <th style="text-align:center" width="10%">Freq</th>
                                <th>Root Cause Resolution Strategy</th>
                            </tr>
                        </thead>
                        <tbody id="insightBody"></tbody>
                    </table>
                </div>

                <div class="card">
                    <h3 style="margin:0 0 15px 0; color:var(--mariposa-pink)">Analyzed Sentiments Area</h3>
                    <div class="search-container">
                        <input type="text" id="search" class="search-box" placeholder="Filter by theme...">
                        <button class="btn" style="background:var(--mariposa-hot); color:white" onclick="render()">üîç Search</button>
                    </div>
                    <div id="historyList"></div>
                </div>
            </div>
        </div>
    </div>

<script>
    let db = JSON.parse(localStorage.getItem('dz_mariposa_v8')) || [];

    const lexicon = {
        positive: ['hiyang', 'glow', 'effective', 'legit', 'orig', 'kinis', 'smooth', 'mabait', 'dasurb', 'slay', 'ate chrue', 'bet', 'budol find', 'sulit', 'fast delivery', 'securely packed'],
        negative: ['hapdi', 'kirot', 'pimple', 'tigyawat', 'butlig', 'fake', 'peke', 'scam', 'sayang', 'mahal', 'bad', 'worst', 'nagsisi', 'sunog', 'irritation', 'dry', 'leaking', 'bawas', 'tampered', 'rude', 'suplado', 'attitude', 'overrated', 'mid', 'clownery', 'delulu', 'rash', 'itchy', 'allergic'],
        themes: [
            { id: 'clinical', label: 'Adverse Skin Reaction', keywords: ['hapdi', 'kirot', 'pimple', 'butlig', 'rash', 'itchy', 'hives', 'burning', 'redness'], fix: 'STOP USE NOTICE. Patch test protocols and allergen analysis required.' },
            { id: 'quality', label: 'Product Integrity', keywords: ['fake', 'peke', 'scam', 'separated', 'watery', 'metallic', 'foul', 'texture', 'oxidized'], fix: 'FDA Batch Audit triggered. Refund/Replacement offer authorized.' },
            { id: 'logistics', label: 'Logistics Friction', keywords: ['rider', 'tagal', 'suplado', 'bastos', 'delivery', 'thrown', 'damaged', 'leaking'], fix: 'Courier misconduct filed. Reinforced packing update.' }
        ]
    };

    function processAnalysis() {
        const text = document.getElementById('reviewInput').value.trim();
        if(!text) return;

        const words = text.toLowerCase().split(/\W+/);
        let posCount = words.filter(w => lexicon.positive.includes(w)).length;
        let negCount = words.filter(w => lexicon.negative.includes(w)).length;
        
        let score = (posCount - negCount) / (words.length / 5 + 1);
        score = Math.max(-1, Math.min(1, score));

        // Critical Alert Trigger
        if (score < -0.5) {
            triggerCriticalAlert();
        }

        let sentiment = score > 0.12 ? "Positive" : (score < -0.12 ? "Negative" : "Neutral");
        let foundThemes = lexicon.themes.filter(t => t.keywords.some(k => text.toLowerCase().includes(k)));

        const entry = {
            id: Date.now(),
            text: text,
            sentiment: sentiment,
            score: score,
            themes: foundThemes.map(t => t.label),
            timestamp: new Date().toLocaleString(),
            month: new Date().getMonth()
        };

        db.push(entry);
        localStorage.setItem('dz_mariposa_v8', JSON.stringify(db));
        document.getElementById('reviewInput').value = "";
        updateDashboard();
    }

    function triggerCriticalAlert() {
        const card = document.getElementById('inputCard');
        const banner = document.getElementById('criticalBanner');
        
        card.classList.add('critical-alert-active');
        banner.style.display = 'block';
        
        // Voice Alert
        const msg = new SpeechSynthesisUtterance("Critical negative review detected. Immediate action required.");
        window.speechSynthesis.speak(msg);

        setTimeout(() => {
            card.classList.remove('critical-alert-active');
            banner.style.display = 'none';
        }, 10000);
    }

    function updateDashboard() {
        render();
        updateCharts();
        updateKeywords();

        const classifier = {};
        db.forEach(entry => entry.themes.forEach(t => classifier[t] = (classifier[t] || 0) + 1));
        
        document.getElementById('insightBody').innerHTML = Object.keys(classifier).map(key => {
            const themeObj = lexicon.themes.find(t => t.label === key);
            return `<tr><td><b>#${key}</b></td><td align="center">${classifier[key]}</td><td>${themeObj.fix}</td></tr>`;
        }).join('');
    }

    function updateKeywords() {
        const wordFreq = {};
        db.forEach(entry => {
            entry.text.toLowerCase().split(/\W+/).forEach(w => {
                if(w.length > 3 && !lexicon.positive.includes(w) && !lexicon.negative.includes(w)) {
                    wordFreq[w] = (wordFreq[w] || 0) + 1;
                }
            });
        });
        const top5 = Object.entries(wordFreq).sort((a,b) => b[1] - a[1]).slice(0, 5);
        document.getElementById('keywordCloud').innerHTML = top5.map(w => `<span class="k-tag">${w[0]} (${w[1]})</span>`).join('');
    }

    let lineChart;
    function updateCharts() {
        const ctx = document.getElementById('lineChart').getContext('2d');
        if(lineChart) lineChart.destroy();
        const last10 = db.slice(-10);
        lineChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: last10.map(i => i.timestamp),
                datasets: [{
                    data: last10.map(i => i.score),
                    borderColor: '#ff85a2', backgroundColor: 'rgba(214, 51, 132, 0.2)',
                    fill: true, tension: 0.4, borderWidth: 3
                }]
            },
            options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    function render() {
        const s = document.getElementById('search').value.toLowerCase();
        document.getElementById('historyList').innerHTML = db.filter(i => i.text.toLowerCase().includes(s)).reverse().map(i => `
            <div class="item" style="border-bottom:1px solid #333; padding:15px 0;">
                <div style="display:flex; justify-content:space-between;">
                    <span class="tag" style="background:${i.score < -0.5 ? 'var(--critical)' : (i.sentiment==='Positive'?'var(--pos)':'#ffa502')}; color:#000; font-weight:900;">
                        ${i.score < -0.5 ? 'CRITICAL' : i.sentiment}
                    </span>
                    <small style="color:#666">${i.timestamp}</small>
                </div>
                <p style="color:#ccc; font-style:italic">"${i.text}"</p>
                <div class="response-card" style="${i.score < -0.5 ? 'border: 2px solid var(--critical)' : ''}">
                    <span class="conversion-badge">${i.score < -0.5 ? 'üö® URGENT RECOVERY' : 'üí∞ CONVERSION READY'}</span>
                    ${i.score < -0.5 ? '<strong>Fast-Track Protocol:</strong> Direct Manager intervention. Request product return for lab testing.' : 'Standard brand-voice recovery applied.'}
                </div>
            </div>
        `).join('');
    }

    function clearDatabase() { if(confirm("Clear all data?")) { localStorage.removeItem('dz_mariposa_v8'); db=[]; location.reload(); } }
    function toggleFit() { document.getElementById('mainContainer').classList.toggle('full-width'); }
    function exportToExcel() {
        const ws = XLSX.utils.json_to_sheet(db);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "DZ_Mariposa_Report");
        XLSX.writeFile(wb, "Mariposa_v8_Report.xlsx");
    }
    updateDashboard();
</script>
</body>
</html>
