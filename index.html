<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARIPOSA v38.0 - PINOY RESEARCH SYNC</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --m-pink: #ff85a2; --m-hot: #d63384; --m-black: #0a0a0a; 
            --white: #ffffff; --critical: #ff4757; --pos: #2ed573; 
            --neutral: #747d8c; --voucher: #3b82f6; --gold: #f1c40f;
            --bg: var(--m-black); --card-bg: #141414; --text: #ffffff;
        }
        /* Readability Fix for Light Mode */
        body.light-mode { --bg: #f8f9fa; --card-bg: #ffffff; --text: #1a1a1a; }
        body.light-mode .response-box { background: #f1f3f5; border: 1px solid #dee2e6; color: #1a1a1a; font-weight: 500; }
        body.light-mode textarea, body.light-mode input { background: #fff; color: #000; border: 1px solid #ced4da; }
        body.light-mode .kb-term { background: #e9ecef; color: #1a1a1a; border-left: 4px solid var(--m-hot); }

        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; color: var(--text); overflow-x: hidden; transition: 0.3s ease; }
        .container { width: 100%; padding: 15px; box-sizing: border-box; display: grid; gap: 20px; grid-template-columns: 1fr; }
        @media (min-width: 1024px) { .container { grid-template-columns: 420px 1fr; } }
        
        .navbar { background: var(--m-black); padding: 15px 25px; border-bottom: 3px solid var(--m-hot); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .card { background: var(--card-bg); border-radius: 15px; padding: 20px; border: 1px solid rgba(255,133,162,0.15); margin-bottom: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); }
        
        textarea, input, select { width: 100%; background: #000; color: #fff; border: 1px solid #333; border-radius: 10px; padding: 12px; box-sizing: border-box; font-size: 13px; margin-bottom: 10px; font-family: inherit; }
        .btn { padding: 12px; border-radius: 10px; border: none; font-weight: 800; cursor: pointer; width: 100%; text-transform: uppercase; font-size: 11px; transition: 0.2s; }
        .btn-main { background: linear-gradient(45deg, var(--m-hot), #ff5e78); color: white; }
        
        .response-box { background: rgba(0,0,0,0.4); padding: 15px; border-radius: 10px; border-left: 5px solid var(--gold); margin-top: 10px; font-size: 13px; line-height: 1.6; color: #fff; }
        .host-action-box { background: rgba(255,133,162,0.05); padding: 12px; border-radius: 10px; margin-top: 10px; border: 1px dashed var(--m-pink); font-size: 11px; color: var(--m-pink); font-weight: 700; display: flex; align-items: center; gap: 10px; }
        
        .kb-term { cursor: pointer; display: block; background: #222; padding: 10px; border-radius: 8px; margin: 6px 0; border-left: 4px solid var(--m-pink); font-size: 11px; transition: 0.2s; }
        .engine-status { font-size: 10px; font-weight: 900; color: var(--pos); letter-spacing: 1px; }
        .voucher-tag { background: var(--voucher); color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 900; }

        .charts-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        @media (min-width: 768px) { .charts-grid { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>

    <nav class="navbar">
        <div>
            <div style="font-family:'Playfair Display'; font-weight:900; color:var(--m-pink); font-size: 1.4rem;">üå∫ MARIPOSA v38.0</div>
            <div class="engine-status">‚óè PINOY BEAUTY MARKET SYNC ACTIVE (2020-2026)</div>
        </div>
        <div style="display:flex; gap:12px;">
            <button class="btn" style="width:auto; background:#222; color:white; padding: 5px 15px;" onclick="toggleTheme()">üåì THEME</button>
            <button class="btn" style="width:auto; background:var(--voucher); color:white; padding: 5px 15px;" onclick="exportData()">üì• EXCEL</button>
        </div>
    </nav>

    <div class="container">
        <div class="sidebar">
            <div class="card" style="border-top: 4px solid var(--gold);">
                <h4 style="margin:0 0 10px 0; font-size:12px; color:var(--gold);">üß† SENTENCE SYNC VAULT</h4>
                <textarea id="newWord" style="height:55px;" placeholder="Trigger sentence (e.g. 'Fake ito')"></textarea>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                    <select id="newWeight">
                        <option value="-50">Negative</option>
                        <option value="0">Neutral</option>
                        <option value="50">Positive</option>
                    </select>
                    <select id="newCat">
                        <option value="Skin">Skin/Clinical</option>
                        <option value="Logistics">Logistics</option>
                        <option value="Quality">Product Quality</option>
                        <option value="Rider">Rider Conduct</option>
                    </select>
                </div>
                <textarea id="sysResponse" style="height:55px; border-color:var(--pos);" placeholder="Suggested response..."></textarea>
                <button onclick="addKnowledge()" class="btn btn-main">üöÄ SYNC TO ENGINE</button>
                <div id="dictDisplay" style="max-height:130px; overflow-y:auto; margin-top:10px;"></div>
            </div>

            <div class="card">
                <h4 style="margin:0 0 5px 0; font-size:11px; color:#888;">BULK SENTIMENT FEED</h4>
                <textarea id="reviewInput" style="height:100px;" placeholder="Paste raw reviews..."></textarea>
                <button class="btn btn-main" style="background:var(--pos); color:black;" onclick="processIntake()">‚ö° TRIGGER RESEARCH ANALYSIS</button>
            </div>
        </div>

        <div class="main-content">
            <div class="charts-grid">
                <div class="card">
                    <h4 style="margin:0 0 15px 0; font-size:12px; color:var(--m-pink);">üìâ TREND LINE (SENTIMENT)</h4>
                    <div style="height:160px;"><canvas id="sentimentChart"></canvas></div>
                </div>
                <div class="card">
                    <h4 style="margin:0 0 15px 0; font-size:12px; color:var(--gold);">üìä PAINPOINT DISTRIBUTION</h4>
                    <div style="height:160px;"><canvas id="painChart"></canvas></div>
                </div>
            </div>
            <div id="historyList"></div>
        </div>
    </div>

<script>
    let db = JSON.parse(localStorage.getItem('m38_db')) || [];
    let knowledge = JSON.parse(localStorage.getItem('m38_kb')) || {
        "fake": {w: -50, c: "Quality", r: "Authenticity Guarantee: We ensure 100% LazMall/Shopee Mall certified items. Please check the Batch ID on the bottom. We can provide the FDA certificate for your peace of mind."},
        "itchy": {w: -50, c: "Skin", r: "Safety Alert: Please stop use immediately. Research shows some skin types react to actives. Wash with cold water. We are here to guide your recovery."}
    };
    let sentimentChart, painChart;

    // GLOBAL RESEARCH (2020-2026) HOST STRATEGY
    const GLOBAL_RESEARCH = {
        "Skin": { strat: "CLINICAL TRANSPARENCY", action: "Filipino users value FDA-compliance. Validate the irritant first, then offer a cooling sample/rebate." },
        "Logistics": { strat: "TRANSPARENT FRICTION", action: "Explain the 'Why' of the hub delay. 2025 data shows this restores trust faster than a generic 'Sorry'." },
        "Quality": { strat: "AUTH-CHECK PROTOCOL", action: "Showcase Batch IDs & QR Verification. Trust is the #1 beauty currency in PH markets." },
        "Rider": { strat: "BRAND INSULATION", action: "Apologize for the partner courier. Research shows the 'White-Glove' escalation is best for rider misconduct." },
        "General": { strat: "BUDOL RECOVERY", action: "Turn a bad purchase into a fan story. Use a personalized voucher to reset the customer journey." }
    };

    function toggleTheme() { document.body.classList.toggle('light-mode'); }

    function addKnowledge() {
        const word = document.getElementById('newWord').value.toLowerCase().trim();
        const weight = parseInt(document.getElementById('newWeight').value);
        const cat = document.getElementById('newCat').value;
        const resp = document.getElementById('sysResponse').value.trim();
        if(word && resp) {
            knowledge[word] = { w: weight, c: cat, r: resp };
            saveKB();
            document.getElementById('newWord').value = '';
            document.getElementById('sysResponse').value = '';
        }
    }

    function saveKB() { localStorage.setItem('m38_kb', JSON.stringify(knowledge)); renderKB(); }
    function renderKB() {
        document.getElementById('dictDisplay').innerHTML = Object.keys(knowledge).map(k => `
            <div class="kb-term" onmousedown="startHold('${k}')" onmouseup="clearHold()">
                <b>${k}</b> <small>[${knowledge[k].c}]</small>
            </div>
        `).join('');
    }

    let holdTimer;
    function startHold(k) { holdTimer = setTimeout(() => { if(confirm("Delete sync sentence?")) { delete knowledge[k]; saveKB(); } }, 800); }
    function clearHold() { clearTimeout(holdTimer); }

    function analyze(text) {
        const low = text.toLowerCase();
        let score = 0, cat = "General", suggest = "Thank you for reaching out. We are currently reviewing your concern based on our safety protocols.";
        
        // Pinoy Sarcasm Logic
        const sarcasm = ["wow", "galing", "salamat"].some(s => low.includes(s)) && ["sira", "tagal", "fake"].some(n => low.includes(n));
        if(sarcasm) score = -35;

        Object.keys(knowledge).forEach(k => { if(low.includes(k)) { score = knowledge[k].w; cat = knowledge[k].c; suggest = knowledge[k].r; } });

        // Restore Voucher Giving
        const voucher = (score < -20) ? "MARIPOSA-" + Math.random().toString(36).substr(2,5).toUpperCase() : null;
        if(voucher) suggest += ` [üéÅ VOUCHER: ${voucher}]`;

        const intel = GLOBAL_RESEARCH[cat] || GLOBAL_RESEARCH.General;
        return { text, score, cat, suggest, hostAction: intel.action, strat: intel.strat, voucher, id: Date.now() + Math.random() };
    }

    function processIntake() {
        const input = document.getElementById('reviewInput').value.trim();
        if(!input) return;
        input.split('\n').forEach(line => { if(line.trim()) db.push(analyze(line)); });
        document.getElementById('reviewInput').value = '';
        saveData();
    }

    function saveData() { localStorage.setItem('m38_db', JSON.stringify(db)); render(); }

    function render() {
        document.getElementById('historyList').innerHTML = db.slice().reverse().map(i => `
            <div class="card" style="border-left: 6px solid ${i.score > 10 ? 'var(--pos)' : i.score < -10 ? 'var(--critical)' : 'var(--neutral)'}">
                <div style="display:flex; justify-content:space-between;">
                    <span style="font-size:9px; font-weight:900; background:var(--m-pink); color:black; padding:2px 8px; border-radius:4px;">${i.cat.toUpperCase()}</span>
                    ${i.voucher ? `<span class="voucher-tag">${i.voucher}</span>` : ''}
                    <button onclick="del(${i.id})" style="background:none; border:none; color:#555;">‚úï</button>
                </div>
                <p style="font-weight:700; margin:12px 0;">"${i.text}"</p>
                <div class="response-box"><b>üõ°Ô∏è SUGGESTED REPLY:</b><br>${i.suggest}</div>
                <div class="host-action-box">üí° <b>${i.strat}:</b> ${i.hostAction}</div>
            </div>
        `).join('');
        updateCharts();
    }

    function updateCharts() {
        // Sentiment Line Graph (Extended)
        if(sentimentChart) sentimentChart.destroy();
        const data = db.map(i => i.score);
        sentimentChart = new Chart(document.getElementById('sentimentChart'), {
            type: 'line',
            data: { labels: db.map((_, i) => i + 1), datasets: [{ label: 'Sentiment', data, borderColor: '#ff85a2', tension: 0.3, fill: true, backgroundColor: 'rgba(255,133,162,0.1)' }] },
            options: { maintainAspectRatio: false, scales: { y: { display: true } } }
        });

        // Painpoint Bar Graph (Restored)
        if(painChart) painChart.destroy();
        const counts = { Skin: 0, Logistics: 0, Quality: 0, Rider: 0 };
        db.forEach(i => { if(counts[i.cat] !== undefined) counts[i.cat]++; });
        painChart = new Chart(document.getElementById('painChart'), {
            type: 'bar',
            data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts), backgroundColor: '#f1c40f' }] },
            options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    function del(id) { db = db.filter(i => i.id !== id); saveData(); }
    function exportData() {
        const ws = XLSX.utils.json_to_sheet(db);
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Retention_Report");
        XLSX.writeFile(wb, `Mariposa_v38_Report.xlsx`);
    }

    renderKB(); render();
</script>
</body>
</html>

