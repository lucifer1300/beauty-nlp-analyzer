<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D.Z. Mariposa NLP - Beauty Sentiment Analyzer v30 (Logistics Recovery)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --mariposa-pink: #ff85a2; --mariposa-hot: #d63384;
            --mariposa-black: #121212; --mariposa-dark-grey: #1e1e1e;
            --white: #ffffff; --critical: #ff4757; --pos: #2ed573; 
            --voucher-blue: #3b82f6; --expired: #555; --intel-gold: #f1c40f;
            --logistics-purple: #8e44ad;
        }
        
        body { font-family: 'Inter', sans-serif; background: var(--mariposa-black); margin: 0; color: var(--white); overflow-x: hidden; }
        .container { width: 95%; max-width: 1400px; margin: 10px auto; padding: 10px; box-sizing: border-box; }
        
        .navbar { 
            background: linear-gradient(90deg, #000 0%, var(--mariposa-dark-grey) 100%); 
            padding: 15px 25px; border-bottom: 2px solid var(--mariposa-hot);
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 1000;
        }

        .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 1024px) { .dashboard-grid { grid-template-columns: 420px 1fr; } }

        .card { background: var(--mariposa-dark-grey); border-radius: 12px; padding: 20px; border: 1px solid rgba(255,133,162,0.1); position: relative; margin-bottom: 20px; }
        
        .intel-chip { display: inline-block; padding: 4px 10px; border-radius: 20px; background: rgba(241, 196, 15, 0.1); color: var(--intel-gold); font-size: 11px; font-weight: 700; margin-right: 5px; border: 1px solid rgba(241, 196, 15, 0.3); margin-bottom: 5px; }

        .heatmap-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 10px; }
        .heatmap-cell { height: 40px; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 9px; font-weight: bold; background: #111; border: 1px solid #222; }
        .h-label { font-size: 8px; color: #666; margin-top: 2px; text-transform: uppercase; }

        .exposure-card { background: linear-gradient(135deg, #1e1e1e 0%, #000 100%); border: 1px solid var(--voucher-blue); }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .stat-box { background: #111; padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #222; }
        .stat-val { font-size: 20px; font-weight: 900; color: var(--voucher-blue); display: block; }
        .stat-lbl { font-size: 10px; color: #666; text-transform: uppercase; }

        .logistics-card { border: 1px solid var(--logistics-purple); background: rgba(142, 68, 173, 0.05); }

        .voucher-log-table { width: 100%; font-size: 10px; border-collapse: collapse; margin-top: 10px; }
        .voucher-log-table td { padding: 5px 0; border-bottom: 1px solid #333; }

        textarea { width: 100%; height: 100px; border: 1px solid #333; border-radius: 8px; padding: 12px; background: #000; color: #fff; font-size: 14px; box-sizing: border-box; resize: vertical; }
        
        .btn { padding: 12px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; width: 100%; margin-top: 10px; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-main { background: var(--mariposa-hot); color: white; }
        .btn-voucher { background: var(--voucher-blue); color: white; font-size: 11px; height: 35px; }
        .btn-stop { background: #444; color: #ff4757; font-size: 8px; padding: 2px 5px; border-radius: 4px; border: 1px solid #666; cursor: pointer; }
        .btn-copy { background: #333; color: var(--mariposa-pink); font-size: 10px; border: 1px solid var(--mariposa-pink); width: auto; padding: 5px 10px; cursor: pointer; border-radius: 5px; }

        .tactical-hub { background: #0b0b0b; border: 1px solid var(--mariposa-pink); border-radius: 10px; padding: 15px; margin-top: 15px; }
        .hub-label { font-size: 10px; color: var(--mariposa-pink); font-weight: 900; text-transform: uppercase; margin-bottom: 8px; display: block; }
        .response-box { color: #ddd; font-size: 13px; line-height: 1.6; border-bottom: 1px solid #222; padding-bottom: 12px; margin-bottom: 12px; white-space: pre-line; }
        
        #sentimentEmoji { font-size: 45px; margin-right: 15px; }
        .chart-container { height: 160px; margin-top: 10px; }
        
        .first-aid-tip { font-size: 11px; background: rgba(255, 71, 87, 0.1); border: 1px solid var(--critical); border-radius: 5px; padding: 10px; margin-top: 10px; color: #ff9f9f; }
        .logistics-tip { font-size: 11px; background: rgba(142, 68, 173, 0.1); border: 1px solid var(--logistics-purple); border-radius: 5px; padding: 10px; margin-top: 10px; color: #d7bde2; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div>
            <div style="font-family:'Playfair Display'; font-weight:900; color:var(--mariposa-pink); font-size: 1.2rem;">üå∫ D.Z. MARIPOSA NLP</div>
            <div style="font-size: 9px; color: #888; letter-spacing: 1px;">BEAUTY SENTIMENT INTELLIGENCE v30 (LOGISTICS RECOVERY)</div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
            <div id="liveClock" style="font-size: 11px; color: var(--pos); font-family: monospace;"></div>
            <button class="btn btn-export" onclick="exportData()" style="width: auto; padding: 5px 15px; font-size: 11px; background: #222; color: #fff; border: 1px solid #444;">üì• EXCEL</button>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-grid">
            <div class="sidebar">
                <div class="card logistics-card">
                    <h4 style="margin:0; color:var(--logistics-purple); font-size:12px; letter-spacing:1px;">üöö LOGISTICS HEALTH</h4>
                    <div class="stat-grid">
                        <div class="stat-box"><span class="stat-val" id="logFailCount" style="color:var(--logistics-purple)">0</span><span class="stat-lbl">Late/Damaged</span></div>
                        <div class="stat-box"><span class="stat-val" id="logResRate" style="color:var(--pos)">100%</span><span class="stat-lbl">Responded</span></div>
                    </div>
                </div>

                <div class="card">
                    <h4 style="margin:0; color:var(--mariposa-pink); font-size:12px; letter-spacing:1px;">üö® PAINPOINT DISTRIBUTION</h4>
                    <div class="chart-container" style="height: 180px;"><canvas id="painChart"></canvas></div>
                </div>

                <div class="card">
                    <h4 style="margin:0; color:var(--mariposa-pink); font-size:12px; letter-spacing:1px;">üïí REVIEW HEATMAP</h4>
                    <div class="heatmap-grid" id="heatmapGrid">
                        <div class="heatmap-cell" id="h-night">0<span class="h-label">Night</span></div>
                        <div class="heatmap-cell" id="h-morning">0<span class="h-label">Morn</span></div>
                        <div class="heatmap-cell" id="h-afternoon">0<span class="h-label">Aft</span></div>
                        <div class="heatmap-cell" id="h-evening">0<span class="h-label">Eve</span></div>
                    </div>
                </div>

                <div class="card exposure-card">
                    <h4 style="margin:0; color:var(--voucher-blue); font-size:12px; letter-spacing:1px;">üìä RECOVERY VOUCHERS</h4>
                    <div class="stat-grid">
                        <div class="stat-box"><span class="stat-val" id="totalVouchers">0</span><span class="stat-lbl">Active</span></div>
                        <div class="stat-box"><span class="stat-val" id="estExposure">‚Ç±0</span><span class="stat-lbl">Liability</span></div>
                    </div>
                    <table class="voucher-log-table">
                        <tbody id="voucherLogBody"></tbody>
                    </table>
                </div>

                <div class="card">
                    <div style="display:flex; align-items:center; margin-bottom:15px;">
                        <span id="sentimentEmoji">üòê</span>
                        <h3 style="margin:0; color:var(--mariposa-pink); font-size: 15px;">Advanced NLP Intake</h3>
                    </div>
                    <textarea id="reviewInput" placeholder="Paste Tagalog, Bisaya, Gen Z, or Logistics complaints..."></textarea>
                    <button class="btn btn-main" onclick="processAnalysis()">‚ö° RUN NLP ANALYSIS</button>
                    <button class="btn" style="background:transparent; color:#555; font-size:9px;" onclick="clearAll()">üóëÔ∏è RESET SYSTEM</button>
                </div>
            </div>

            <div class="main-content">
                <div id="smartSummaryUI"></div>
                <div id="historyList"></div>
                <div class="card">
                    <h4 style="margin:0; color:var(--mariposa-pink); font-size:12px; letter-spacing:1px;">üìà SENTIMENT TREND (ACCURACY v30)</h4>
                    <div class="chart-container"><canvas id="lineChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

<script>
    let db = JSON.parse(localStorage.getItem('mariposa_v30_db')) || [];
    let voucherLog = JSON.parse(localStorage.getItem('mariposa_v30_vouchers')) || [];
    let lineChart, painChart;

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playBeep() {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.frequency.setValueAtTime(880, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.1);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }

    const SLANG_DICT = {
        pos: ['ganda','glow','hiyang','effective','legit','dasurb','slay','ate','bussin','riz','estetik','chuy','imal','gwapa','lami','nindot','smooth','skibidi','bet','no cap'],
        neg: ['hapdi','kirot','fake','scam','late','sunog','dry','irritation','rashes','pimple','tagal','mid','chuzz','trash','liki','bati','ngil-ad','samok','hasula','peste'],
        sarcasm: ['edi wow','salamat sa lahat ha','ikaw na talaga','wow ha','very good seller','clapping hands','super bilis','nice product (ironic)','huy','grabe'],
        jejemon: [/e0w/i, /p0h/i, /mhu/i, /z4/i, /x/i, /3/i]
    };

    const logisticsProtocols = [
        "Recovery Step 1: Validate tracking via Courier Portal immediately.",
        "Recovery Step 2: File a formal dispute with the courier for 'Mishandled Parcel'.",
        "Recovery Step 3: Offer immediate reshipment or refund for damaged/leaked items.",
        "Recovery Step 4: Add 'Priority Shipping' tag to customer's future orders.",
        "Recovery Step 5: Report rider behavior if tagged as 'Bastos' or 'Vinalibag'."
    ];

    const firstAidKnowledge = [
        "Rule: STOP use immediately. Rinse with lukewarm water. Cool compress 15 mins. Use fragrance-free moisturizer."
    ];

    const posTemplates = ["Salamat po sa tiwala! üå∏ Dasurb ang glow!", "Legit na hiyang! ‚ú® Stay estetik, beshie!"];
    const negTemplates = ["Pasensya na po. DM us your Order ID for a quick fix.", "Naku, sorry po. Please message us para ma-refund or replace namin."];

    setInterval(() => {
        document.getElementById('liveClock').innerText = new Date().toLocaleString();
        updateTimers();
    }, 1000);

    function processAnalysis() {
        const text = document.getElementById('reviewInput').value.trim();
        if(!text) return;

        const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
        let totalScore = 0;
        let isJejemon = SLANG_DICT.jejemon.some(regex => regex.test(text));
        let isSarcastic = SLANG_DICT.sarcasm.some(sarc => text.toLowerCase().includes(sarc));
        
        let hasClinical = false;
        let hasLogistics = false;
        let hasAuth = false;

        sentences.forEach(s => {
            const cleanS = s.toLowerCase();
            totalScore += (SLANG_DICT.pos.filter(w => cleanS.includes(w)).length - SLANG_DICT.neg.filter(w => cleanS.includes(w)).length);
            if(isSarcastic) totalScore -= 5;

            if(/hapdi|kirot|butlig|rash|sunog|irritation|pimple|nangatol|hubag/i.test(s)) hasClinical = true;
            if(/rider|raider|tagal|deliver|shipping|bastos|dugay|basag|tapon|leak/i.test(s)) hasLogistics = true;
            if(/fake|scam|mura|iba|dili original/i.test(s)) hasAuth = true;
        });

        let sentiment = totalScore > 0 ? "Positive" : (totalScore < 0 ? "Negative" : "Neutral");
        if(isSarcastic) sentiment = "Negative (Sarcastic)";

        let painpoint = null;
        if (sentiment.includes("Negative") || totalScore < 0) {
            if (hasClinical) painpoint = "Skin Reaction";
            else if (hasLogistics) painpoint = "Logistics";
            else if (hasAuth) painpoint = "Authenticity";
            else painpoint = "Product Quality";
        }

        let tacticalReply = "";
        if(hasLogistics) {
            tacticalReply = "Pasensya na po sa delay/handling ng courier. üöö Inaksyunan na po namin ito sa main office. Paki-DM po ang Order ID para ma-refund o mapalitan agad ang item niyo.";
        } else if(hasClinical) {
            tacticalReply = "‚ö†Ô∏è CLINICAL ADVISORY: Stop use immediately. Rinse with lukewarm water. Apply cool compress. DM us for a full refund and medical assistance.";
        } else if(sentiment === "Positive") {
            tacticalReply = posTemplates[Math.floor(Math.random() * posTemplates.length)];
        } else {
            tacticalReply = negTemplates[Math.floor(Math.random() * negTemplates.length)];
        }

        db.push({
            id: Date.now(), text, sentiment, score: totalScore, 
            isClinical: hasClinical, isLogistics: hasLogistics, 
            tacticalReply, painpoint, voucherIssued: false,
            timestamp: new Date().toLocaleString(),
            isJejemon, isSarcastic
        });

        playBeep();
        saveData();
        document.getElementById('reviewInput').value = "";
    }

    function issueVoucher(id, isSerious) {
        const itemIdx = db.findIndex(i => i.id === id);
        if(db[itemIdx].voucherIssued) return;
        const val = isSerious ? 100 : 50;
        const code = (isSerious ? "RES-L-" : "SORRY-") + Math.floor(1000 + Math.random() * 9000);
        voucherLog.push({ id: Date.now(), parentId: id, code, value: val, expiresAt: Date.now() + (24 * 60 * 60 * 1000), status: 'Active' });
        db[itemIdx].voucherIssued = true;
        localStorage.setItem('mariposa_v30_vouchers', JSON.stringify(voucherLog));
        saveData();
    }

    function stopVoucher(vId) {
        const idx = voucherLog.findIndex(v => v.id === vId);
        if(idx !== -1) { voucherLog[idx].status = "Stopped"; localStorage.setItem('mariposa_v30_vouchers', JSON.stringify(voucherLog)); updateFinanceUI(); refreshVoucherTable(); }
    }

    function updateTimers() {
        const now = Date.now();
        let changed = false;
        voucherLog.forEach(v => { if (v.status === 'Active' && now > v.expiresAt) { v.status = 'Expired'; changed = true; } });
        if(changed) { localStorage.setItem('mariposa_v30_vouchers', JSON.stringify(voucherLog)); updateFinanceUI(); }
        refreshVoucherTable();
    }

    function refreshVoucherTable() {
        const now = Date.now();
        document.getElementById('voucherLogBody').innerHTML = voucherLog.slice(-5).reverse().map(v => {
            const timeLeft = v.expiresAt - now;
            let timerStr = v.status === 'Active' ? new Date(Math.max(0, timeLeft)).toISOString().substr(11, 8) : '00:00:00';
            return `<tr><td><b>${v.code}</b></td><td style="color:var(--mariposa-pink)">${timerStr}</td><td style="text-align:right">${v.status === 'Active' ? `<button class="btn-stop" onclick="stopVoucher(${v.id})">STOP</button>` : v.status}</td></tr>`;
        }).join('');
    }

    function updateFinanceUI() {
        const active = voucherLog.filter(v => v.status === 'Active');
        document.getElementById('totalVouchers').innerText = active.length;
        document.getElementById('estExposure').innerText = `‚Ç±${active.reduce((acc, curr) => acc + curr.value, 0)}`;
        
        const logFails = db.filter(i => i.isLogistics).length;
        document.getElementById('logFailCount').innerText = logFails;
        document.getElementById('logResRate').innerText = logFails > 0 ? "100%" : "---";
    }

    function updateHeatmap() {
        const slots = { Night:0, Morning:0, Afternoon:0, Evening:0 };
        db.forEach(e => {
            const h = new Date(e.id).getHours();
            let s = h < 6 ? "Night" : h < 12 ? "Morning" : h < 18 ? "Afternoon" : "Evening";
            slots[s]++;
        });
        Object.keys(slots).forEach(s => {
            const el = document.getElementById(`h-${s.toLowerCase()}`);
            if(el) el.innerHTML = `${slots[s]}<span class="h-label">${s.substr(0,4)}</span>`;
        });
    }

    function updatePainChart() {
        const ctx = document.getElementById('painChart').getContext('2d');
        const cats = ["Skin Reaction", "Logistics", "Authenticity", "Product Quality"];
        const counts = cats.map(c => db.filter(i => i.painpoint === c).length);
        if(painChart) painChart.destroy();
        painChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: ["Skin", "Log", "Auth", "Qual"], datasets: [{ data: counts, backgroundColor: ['#ff4757', '#3b82f6', '#f1c40f', '#ff85a2'] }] },
            options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    function updateChart() {
        const ctx = document.getElementById('lineChart').getContext('2d');
        if(lineChart) lineChart.destroy();
        const last15 = db.slice(-15);
        lineChart = new Chart(ctx, {
            type: 'line',
            data: { 
                labels: last15.map(i => i.timestamp.split(',')[1]), 
                datasets: [{ data: last15.map(i => i.score), borderColor: '#ff85a2', tension: 0.3 }] 
            },
            options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    function render() {
        document.getElementById('historyList').innerHTML = db.slice().reverse().map(i => `
            <div class="card" style="border-left: ${i.isLogistics ? '6px solid var(--logistics-purple)' : (i.sentiment.includes('Negative') ? '6px solid var(--critical)' : '6px solid var(--pos)')}">
                <button style="position:absolute; top:15px; right:15px; background:none; border:none; color:#ff4757; cursor:pointer;" onclick="deleteItem(${i.id})">üóëÔ∏è</button>
                <div style="margin-bottom:8px;">
                    <span class="intel-chip">${i.sentiment.toUpperCase()}</span>
                    ${i.isLogistics ? '<span class="intel-chip" style="background:var(--logistics-purple); color:white; border:none;">LOGISTICS FAIL</span>' : ''}
                    ${i.isJejemon ? '<span class="intel-chip" style="color:#00ffff; border-color:#00ffff">JEJEMON</span>' : ''}
                </div>
                <p style="font-size:14px; margin:10px 0;">"${i.text}"</p>
                
                ${i.isClinical ? `<div class="first-aid-tip"><b>üè• CLINICAL PROTOCOL:</b><br>${firstAidKnowledge[0]}</div>` : ''}
                ${i.isLogistics ? `<div class="logistics-tip"><b>üöö RECOVERY PROTOCOL:</b><br>${logisticsProtocols.slice(0,3).join('<br>')}</div>` : ''}

                <div class="tactical-hub">
                    <span class="hub-label">Tactical Response</span>
                    <div class="response-box">${i.tacticalReply}</div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-copy" onclick="navigator.clipboard.writeText(\`${i.tacticalReply}\`)">üìã Copy</button>
                        ${(i.sentiment.includes('Negative') && !i.voucherIssued) ? 
                            `<button class="btn btn-voucher" onclick="issueVoucher(${i.id}, ${i.isLogistics || i.isClinical})">üé´ GIVE VOUCHER</button>` : 
                            (i.voucherIssued ? '<span style="font-size:10px; color:#555">Voucher Issued ‚úÖ</span>' : '')}
                    </div>
                </div>
            </div>
        `).join('');
        updateFinanceUI();
        updateHeatmap();
    }

    function saveData() { 
        localStorage.setItem('mariposa_v30_db', JSON.stringify(db)); 
        render(); updateChart(); updatePainChart(); 
        const el = document.getElementById('sentimentEmoji');
        if(db.length) {
            const last = db[db.length-1].score;
            el.innerText = last > 0 ? "üòç" : (last < 0 ? "üòî" : "üòê");
        }
    }

    function deleteItem(id) { db = db.filter(i => i.id !== id); saveData(); }
    function clearAll() { if(confirm("Clear data?")) { localStorage.clear(); location.reload(); } }
    function exportData() {
        const ws = XLSX.utils.json_to_sheet(db.map(({timestamp, ...rest}) => rest));
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Sentiment_Report");
        XLSX.writeFile(wb, "Mariposa_NLP_v30.xlsx");
    }

    saveData();
</script>
</body>
</html>

