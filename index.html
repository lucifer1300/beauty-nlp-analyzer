<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARIPOSA SKINCARE NLP v50 - PREMIUM BATCH</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;600;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0a; --card: #141414; --text: #ffffff;
            --pink: #ff85a2; --hot: #d63384; --alert: #ff4757;
            --font: 'Inter', sans-serif;
        }
        [data-theme="light"] {
            --bg: #f8f9fa; --card: #ffffff; --text: #121212;
        }
        body { background: var(--bg); color: var(--text); font-family: var(--font); margin: 0; padding: 0; transition: 0.3s; }
        body.safety-alert-mode { background: #2c0b0e !important; }
        
        .navbar { padding: 15px 25px; border-bottom: 2px solid var(--pink); display: flex; justify-content: space-between; align-items: center; background: var(--card); sticky: top; z-index: 1000; }
        .logo { font-weight: 900; font-size: 1.4rem; color: var(--pink); letter-spacing: -1px; }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        @media(max-width: 600px) { .container { grid-template-columns: 1fr; } }

        .card { background: var(--card); padding: 25px; border-radius: 16px; border: 1px solid rgba(255,133,162,0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.3); height: fit-content; }
        
        textarea, input { width: 100%; padding: 15px; margin-bottom: 12px; border-radius: 10px; border: 1px solid #333; background: #000; color: #fff; font-family: inherit; box-sizing: border-box; }
        [data-theme="light"] input, [data-theme="light"] textarea { background: #f0f0f0; color: #000; border: 1px solid #ccc; }

        button { cursor: pointer; font-weight: 700; text-transform: uppercase; border: none; padding: 14px; border-radius: 10px; transition: 0.2s; }
        .btn-primary { background: var(--pink); color: #000; width: 100%; }
        .btn-batch { background: #3b82f6; color: white; width: 100%; margin-top: 10px; }
        .btn-danger { background: #333; color: #ff8a8a; font-size: 0.75rem; padding: 8px 15px; }
        
        .metric-box { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .metric { background: rgba(255,255,255,0.05); padding: 12px; text-align: center; border-radius: 12px; border-bottom: 2px solid var(--pink); }
        .metric span { font-size: 1.2rem; font-weight: 900; color: var(--pink); display: block; }
        .metric small { font-size: 0.65rem; text-transform: uppercase; opacity: 0.7; }

        .strategy-box { border-left: 4px solid var(--pink); padding: 15px; background: rgba(255,133,162,0.05); border-radius: 0 12px 12px 0; margin-top: 15px; }
        .alert-badge { background: var(--alert); color: white; padding: 8px 15px; border-radius: 30px; font-weight: 900; animation: pulse 1.5s infinite; margin-bottom: 15px; display: inline-block; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .activity-item { padding: 10px; border-bottom: 1px solid #222; font-size: 0.8rem; display: flex; justify-content: space-between; align-items: center; }
        .chart-container { height: 250px; margin-top: 15px; }
    </style>
</head>
<body data-theme="dark">

<nav class="navbar">
    <div class="logo">üå∫ MARIPOSA v50.PRO</div>
    <div style="display:flex; gap:10px; align-items:center;">
        <input type="text" id="serverId" placeholder="SERVER ID" style="width: 110px; margin:0; text-align:center;">
        <button onclick="toggleTheme()" style="background:none; border:1px solid var(--pink); color:var(--pink); padding:8px 12px;">üåó</button>
    </div>
</nav>

<div class="container">
    <div class="column">
        <div class="card">
            <h3 style="color:var(--pink); margin:0 0 15px 0;">üöÄ ENGINE (MAX 500 REVIEWS)</h3>
            <textarea id="reviewInput" rows="12" placeholder="Paste Taglish reviews here. Supports bulk analysis..."></textarea>
            
            <div id="progressContainer" style="display:none;">
                <progress id="batchProgress" style="width:100%;" value="0" max="100"></progress>
                <p id="progressText" style="font-size:0.8rem; text-align:center;">Analyzing Context...</p>
            </div>

            <button class="btn-primary" onclick="processSingle()">‚ö° ANALYZE & AUTO-CLEAR</button>
            <button class="btn-batch" onclick="processBatch()">üöÄ MASS BATCH RUN (500+)</button>
            <button class="btn-danger" style="margin-top:10px; width:100%;" onclick="document.getElementById('reviewInput').value=''">MANUAL CLEAR</button>

            <div id="resultPanel" style="display:none; margin-top:25px; border-top:1px solid #333; padding-top:20px;">
                <div id="safetyShield"></div>
                <h4 id="resCategory" style="margin:0; color:var(--pink);"></h4>
                <p id="resTranslation" style="font-style:italic; opacity:0.8; margin:10px 0;"></p>
                <div class="strategy-box">
                    <strong>HOST STRATEGY ACTION:</strong>
                    <p id="resStrategy"></p>
                    <div id="resVoucher"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="column">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">üìä DATA INSIGHTS</h3>
                <div style="display:flex; gap:5px;">
                    <button class="btn-danger" onclick="exportToExcel()">üì• XLSX</button>
                    <button class="btn-danger" onclick="wipeHistory()">üóëÔ∏è WIPE</button>
                </div>
            </div>

            <div class="metric-box">
                <div class="metric"><small>Pos</small><span id="statPos">0</span></div>
                <div class="metric"><small>Neu</small><span id="statNeu">0</span></div>
                <div class="metric"><small>Neg</small><span id="statNeg">0</span></div>
                <div class="metric"><small>Vouchers</small><span id="statVoucher">0</span></div>
            </div>

            <div class="chart-container">
                <canvas id="lineChart"></canvas>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
                <div class="chart-container" style="height:150px;"><canvas id="pieChart"></canvas></div>
                <div class="chart-container" style="height:150px;"><canvas id="barChart"></canvas></div>
            </div>
        </div>

        <div class="card" style="margin-top:20px;">
            <h4 style="margin:0 0 10px 0;">üïí PAINPOINT ACTIVITY LOG</h4>
            <div id="activityFeed" style="max-height: 200px; overflow-y: auto;"></div>
        </div>
    </div>
</div>

<script>
    const TAGLISH_DICT = {
        "hapdi": "stinging", "nangatol": "itchy", "namula": "redness", "sting": "stinging",
        "hulas": "melted_makeup", "budol": "impulse_buy", "tagal": "slow_delivery",
        "basag": "broken", "peke": "fake", "bango": "scented", "mahal": "expensive", "irritation": "irritated"
    };

    const STRATEGY_MAP = {
        "Skin": "CLINICAL TRIAGE: Acknowledge biological reaction. Suggest stopping use. Offer dermatologist credit.",
        "Logistics": "LOGISTICS RECOVERY: Acknowledge shipping friction. Provide real-time tracking + Rebate.",
        "Quality": "QUALITY ASSURANCE: 1-to-1 express replacement. Investigation of Batch ID initiated.",
        "Budol": "LOYALTY LOOP: Affirm choice. Cross-sell complementary soothing product.",
        "General": "EMPATHIC RESPONSE: Standard brand-voice validation."
    };

    let charts = {};
    let serverId = localStorage.getItem('mariposa_id') || "GB-" + Math.random().toString(36).substring(2, 6).toUpperCase();
    document.getElementById('serverId').value = serverId;

    function toggleTheme() {
        const body = document.body;
        body.setAttribute('data-theme', body.getAttribute('data-theme') === 'light' ? 'dark' : 'light');
    }

    function translate(text) {
        let eng = text.toLowerCase();
        Object.keys(TAGLISH_DICT).forEach(key => {
            eng = eng.replace(new RegExp(key, 'g'), TAGLISH_DICT[key]);
        });
        return eng;
    }

    function analyzeLogic(rawText) {
        const eng = translate(rawText);
        let score = 0;
        const neg = ['stinging', 'itchy', 'redness', 'slow', 'broken', 'fake', 'bad', 'hapdi', 'nangatol', 'sting', 'irritated'];
        const pos = ['good', 'nice', 'effective', 'bango', 'sulit', 'love', 'legit', 'budol', 'perfect'];
        
        neg.forEach(w => { if(eng.includes(w)) score -= 1.2; });
        pos.forEach(w => { if(eng.includes(w)) score += 0.8; });

        let cat = "General";
        if(eng.match(/skin|itchy|redness|face|stinging|hapdi|namula|sting|irritated/)) cat = "Skin";
        else if(eng.match(/ship|deliver|tagal|wait|rider/)) cat = "Logistics";
        else if(eng.match(/broken|fake|seal|basag/)) cat = "Quality";
        else if(eng.match(/budol|sulit|worth/)) cat = "Budol";

        const voucherCode = score < -0.5 ? `MP-${Math.random().toString(36).substring(2,6).toUpperCase()}` : null;

        return {
            id: Date.now() + Math.random(),
            text: rawText,
            eng: eng,
            cat: cat,
            score: score,
            safety: !!eng.match(/itchy|stinging|redness|burn|pain|nangatol|hapdi|namula|sting|irritated/),
            strategy: STRATEGY_MAP[cat],
            voucher: voucherCode,
            timestamp: new Date().getTime()
        };
    }

    async function processBatch() {
        const input = document.getElementById('reviewInput').value;
        const lines = input.split('\n').filter(l => l.trim() !== "");
        if(lines.length === 0) return;

        const container = document.getElementById('progressContainer');
        const bar = document.getElementById('batchProgress');
        container.style.display = 'block';
        bar.max = lines.length;
        
        let history = JSON.parse(localStorage.getItem(`mariposa_db_${serverId}`)) || [];

        for(let i = 0; i < lines.length; i++) {
            const entry = analyzeLogic(lines[i]);
            history.push(entry);
            bar.value = i + 1;
            if(i % 5 === 0) await new Promise(r => setTimeout(r, 10)); // Prevent UI lock for 500+ items
        }

        localStorage.setItem(`mariposa_db_${serverId}`, JSON.stringify(history));
        container.style.display = 'none';
        document.getElementById('reviewInput').value = ''; // AUTO CLEAR
        refreshDashboard();
    }

    function processSingle() {
        const text = document.getElementById('reviewInput').value;
        if(!text) return;
        const entry = analyzeLogic(text);
        let history = JSON.parse(localStorage.getItem(`mariposa_db_${serverId}`)) || [];
        history.push(entry);
        localStorage.setItem(`mariposa_db_${serverId}`, JSON.stringify(history));
        updateUI(entry);
        document.getElementById('reviewInput').value = ''; // AUTO CLEAR
        refreshDashboard();
    }

    function updateUI(data) {
        document.getElementById('resultPanel').style.display = 'block';
        document.getElementById('resCategory').innerText = `${data.cat.toUpperCase()} CATEGORY`;
        document.getElementById('resTranslation').innerText = `EN: "${data.eng}"`;
        document.getElementById('resStrategy').innerText = data.strategy;
        document.getElementById('resVoucher').innerHTML = data.voucher ? `<span style="color:#3b82f6; font-weight:900;">üéÅ VOUCHER ISSUED: ${data.voucher}</span>` : '';
        
        if(data.safety) {
            document.body.classList.add('safety-alert-mode');
            document.getElementById('safetyShield').innerHTML = `<div class="alert-badge">‚ö†Ô∏è SAFETY SHIELD: CLINICAL TRIGGER</div>`;
        } else {
            document.body.classList.remove('safety-alert-mode');
            document.getElementById('safetyShield').innerHTML = '';
        }
    }

    function refreshDashboard() {
        const history = JSON.parse(localStorage.getItem(`mariposa_db_${serverId}`)) || [];
        const stats = { pos: 0, neu: 0, neg: 0, v: 0 };
        const cats = { Skin: 0, Logistics: 0, Quality: 0, Budol: 0, General: 0 };
        const trendData = history.slice(-20).map(h => h.score);

        history.forEach(h => {
            if(h.score > 0.2) stats.pos++; 
            else if(h.score < -0.2) stats.neg++; 
            else stats.neu++;
            if(h.voucher) stats.v++;
            cats[h.cat]++;
        });

        document.getElementById('statPos').innerText = stats.pos;
        document.getElementById('statNeu').innerText = stats.neu;
        document.getElementById('statNeg').innerText = stats.neg;
        document.getElementById('statVoucher').innerText = stats.v;

        renderCharts(stats, cats, trendData);
        
        document.getElementById('activityFeed').innerHTML = history.reverse().slice(0, 20).map(h => `
            <div class="activity-item">
                <span style="color:${h.score < 0 ? 'var(--alert)' : '#2ed573'}">${h.safety ? 'üö©' : '‚úî'} ${h.text.substring(0,30)}...</span>
                <small>${h.cat}</small>
            </div>
        `).join('');
    }

    function renderCharts(stats, cats, trend) {
        const setup = (id, type, data, options = {}) => {
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), { type, data, options: { ...options, maintainAspectRatio: false } });
        };

        // Line Graph (Sentiment Trend)
        setup('lineChart', 'line', {
            labels: trend.map((_, i) => i + 1),
            datasets: [{ label: 'Sentiment Flow', data: trend, borderColor: '#ff85a2', tension: 0.4, fill: true, backgroundColor: 'rgba(255,133,162,0.1)' }]
        }, { plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { display: false } } });

        // Painpoint Distribution (Pie)
        setup('pieChart', 'doughnut', {
            labels: Object.keys(cats),
            datasets: [{ data: Object.values(cats), backgroundColor: ['#ff4757', '#3b82f6', '#f1c40f', '#ff85a2', '#747d8c'], borderWidth: 0 }]
        }, { plugins: { legend: { display: false } } });

        // Sentiment Bar
        setup('barChart', 'bar', {
            labels: ['Pos', 'Neu', 'Neg'],
            datasets: [{ data: [stats.pos, stats.neu, stats.neg], backgroundColor: ['#2ed573', '#747d8c', '#ff4757'] }]
        }, { plugins: { legend: { display: false } }, scales: { y: { display: false } } });
    }

    function wipeHistory() { if(confirm("Wipe storage for this ID?")) { localStorage.removeItem(`mariposa_db_${serverId}`); refreshDashboard(); } }
    
    function exportToExcel() {
        const history = JSON.parse(localStorage.getItem(`mariposa_db_${serverId}`)) || [];
        const ws = XLSX.utils.json_to_sheet(history);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "SentimentReport");
        XLSX.writeFile(wb, `Mariposa_v50_${serverId}.xlsx`);
    }

    refreshDashboard();
    document.getElementById('serverId').addEventListener('change', (e) => {
        serverId = e.target.value.toUpperCase();
        localStorage.setItem('mariposa_id', serverId);
        refreshDashboard();
    });
</script>
</body>
</html>

