<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARIPOSA Beauty NLP V500 - PERSISTENT ENGINE</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;600;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050505; --card: #0f0f0f; --text: #ffffff;
            --pink: #ff85a2; --gold: #d4af37; --alert: #ff4757;
            --success: #2ed573; --font: 'Inter', sans-serif;
            --neural: #3b82f6; --copy: #a855f7;
        }
        [data-theme="light"] { --bg: #f0f2f5; --card: #ffffff; --text: #121212; }
        
        body { background: var(--bg); color: var(--text); font-family: var(--font); margin: 0; transition: 0.3s; overflow-x: hidden; }
        
        .navbar { padding: 10px 20px; border-bottom: 2px solid var(--pink); display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; background: var(--card); position: sticky; top: 0; z-index: 1000; }
        .logo { font-weight: 900; font-size: 1.2rem; color: var(--pink); letter-spacing: -1px; }

        .container { 
            width: 100%; 
            max-width: 1400px; 
            margin: auto;
            padding: 15px; 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); 
            gap: 15px; 
            box-sizing: border-box; 
        }

        .card { background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid rgba(255,133,162,0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.5); position: relative; }
        
        textarea, input { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: 1px solid #333; background: #000; color: #fff; font-family: inherit; box-sizing: border-box; }
        
        button { cursor: pointer; font-weight: 700; text-transform: uppercase; border: none; padding: 12px; border-radius: 8px; transition: 0.2s; }
        .btn-primary { background: var(--pink); color: #000; width: 100%; margin-bottom: 5px; }
        .btn-batch { background: var(--neural); color: white; width: 100%; margin-bottom: 5px; }
        .btn-danger { background: #1a1a1a; color: #ff8a8a; font-size: 0.7rem; border: 1px solid #333; }

        .metric-box { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        @media (min-width: 768px) { .metric-box { grid-template-columns: repeat(4, 1fr); } }
        
        .metric { background: rgba(255,255,255,0.03); padding: 10px; text-align: center; border-radius: 10px; border-bottom: 2px solid var(--pink); }
        .metric span { font-size: 1.1rem; font-weight: 900; color: var(--pink); display: block; }
        .metric small { font-size: 0.55rem; text-transform: uppercase; opacity: 0.7; }

        .neural-feed { max-height: 500px; overflow-y: auto; margin-top: 15px; border-top: 1px solid #333; padding-top: 10px; }
        .feed-item { background: rgba(255,255,255,0.02); margin-bottom: 15px; padding: 12px; border-radius: 8px; border-left: 3px solid var(--pink); font-size: 0.85rem; }
        .translation-tag { font-size: 0.75rem; color: var(--neural); font-style: italic; display: block; margin: 5px 0; }
        
        /* New Risk Badges */
        .risk-badge { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: 900; margin-left: 8px; vertical-align: middle; }
        .risk-high { background: #ff4757; color: white; }
        .risk-med { background: #ffa502; color: black; }
        .risk-low { background: #2ed573; color: white; }

        .strategy-pill { background: rgba(212,175,55,0.1); border: 1px solid var(--gold); color: var(--gold); padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; display: inline-block; margin-top: 5px; }
        .response-text { background: #000; padding: 8px; border: 1px dashed #444; margin-top: 8px; border-radius: 5px; cursor: pointer; }

        table { width: 100%; border-collapse: collapse; font-size: 0.7rem; }
        th { text-align: left; padding: 8px; color: var(--pink); border-bottom: 1px solid #333; }
        td { padding: 8px; border-bottom: 1px solid #111; }
        .chart-container { height: 200px; }
    </style>
</head>
<body data-theme="dark">

<nav class="navbar">
    <div class="logo">üå∫ MARIPOSA V500 <span style="font-size: 0.6rem; color: var(--neural);">NEURAL SYNC ACTIVE</span></div>
    <div style="display:flex; gap:5px;">
        <input type="text" id="serverId" style="width: 100px; margin:0; font-size:0.6rem; padding:5px;">
        <button onclick="toggleTheme()" style="background:none; border:1px solid var(--pink); color:var(--pink); padding: 5px 10px;">üåó</button>
    </div>
</nav>

<div class="container">
    <div class="card">
        <h3 style="color:var(--pink); margin:0 0 10px 0;">üß¨ NEURAL INPUT</h3>
        <textarea id="reviewInput" rows="5" placeholder="Paste single or multiple reviews..."></textarea>
        <button class="btn-primary" onclick="processBatch()">‚ö° ANALYZE BATCH</button>
        <button class="btn-batch" style="background: var(--copy);" onclick="copyBulkSentiments()">üìã COPY ALL RESPONSES</button>
        
        <div class="neural-feed" id="neuralFeed"></div>
    </div>

    <div class="card">
        <h3 style="margin:0 0 15px 0;">üìà PAINPOINT DATA</h3>
        <div class="metric-box">
            <div class="metric"><small>Skin</small><span id="statSkin">0</span></div>
            <div class="metric"><small>Logistics</small><span id="statLog">0</span></div>
            <div class="metric"><small>Riders</small><span id="statRider">0</span></div>
            <div class="metric"><small>Quality</small><span id="statQual">0</span></div>
        </div>
        <div class="chart-container"><canvas id="pieChart"></canvas></div>
        <div style="display:flex; gap:5px; margin-top:15px;">
            <button class="btn-danger" style="flex:1; background:var(--success); color:black; font-weight:bold;" onclick="exportToExcel()">üì• EXPORT XLSX</button>
            <button class="btn-danger" style="flex:1" onclick="wipeHistory()">üóëÔ∏è WIPE HISTORY</button>
        </div>
    </div>

    <div class="card">
        <h3 style="margin:0 0 15px 0;">üéüÔ∏è VOUCHER LOG</h3>
        <div style="max-height: 400px; overflow-y: auto;">
            <table id="voucherTable">
                <thead>
                    <tr><th>CODE</th><th>TYPE</th><th>STATUS</th></tr>
                </thead>
                <tbody id="voucherTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const DIALECT_MAP = {
        "hapdi": "stinging", "nangatol": "itching", "budol": "impulse buy",
        "hulas": "melting", "tagal": "delayed", "basag": "damaged",
        "sungit": "rude", "bastos": "unprofessional", "peke": "fake",
        "sulit": "worth it", "mura": "cheap", "inis": "annoyed", "pula": "redness"
    };

    const STRATEGY_MAP = {
        "Skin": "CLINICAL TRIAGE: Halt use. Issue medical credit.",
        "Logistics": "LOGISTICS RECOVERY: Escalation & shipping rebate.",
        "Quality": "QC PROTOCOL: 1-to-1 replacement dispatched.",
        "Riders' Conduct": "SERVICE RECOVERY: Formal report & apology voucher.",
        "General": "RETENTION: Standard engagement protocol."
    };

    const RESPONSE_MAP = {
        "Skin": "We're so sorry to hear about your skin reaction. Please stop use immediately. Our specialist will DM you to assist.",
        "Logistics": "We apologize for the delay. We are tracking your parcel and have credited a small rebate to your account.",
        "Quality": "Quality is our priority. This shouldn't have happened. We are sending a fresh replacement to you today!",
        "Riders' Conduct": "We apologize for the rider's behavior. We've filed a report with the hub to ensure this is addressed.",
        "General": "Thank you for your feedback! We're constantly working to improve the Mariposa experience."
    };

    let charts = {};
    let serverId = localStorage.getItem('mariposa_v500_id') || "NODE_" + Math.random().toString(36).substring(2, 6).toUpperCase();
    document.getElementById('serverId').value = serverId;

    function deepTranslate(text) {
        let translated = text.toLowerCase();
        Object.keys(DIALECT_MAP).forEach(key => {
            translated = translated.replace(new RegExp(key, 'g'), `[${DIALECT_MAP[key]}]`);
        });
        return translated;
    }

    // New Risk Assessment Logic
    function getRiskLevel(translation, category) {
        if (category !== "Skin") return { label: "N/A", class: "" };
        if (translation.match(/stinging|allergy|burn|breakout|hapdi/)) return { label: "HIGH RISK", class: "risk-high" };
        if (translation.match(/itching|redness|pula|nangatol/)) return { label: "MED RISK", class: "risk-med" };
        return { label: "LOW RISK", class: "risk-low" };
    }

    function analyzeLogic(text) {
        const eng = deepTranslate(text);
        let cat = "General";
        if(eng.match(/stinging|itching|skin|breakout|sting|allergy|pula|red/)) cat = "Skin";
        else if(eng.match(/delayed|ship|deliver|arrival|late|tagal/)) cat = "Logistics";
        else if(eng.match(/damaged|leak|broken|fake|expired|basag|peke/)) cat = "Quality";
        else if(eng.match(/rude|unprofessional|behavior|rider|driver|sungit|bastos/)) cat = "Riders' Conduct";

        let isNegative = eng.match(/stinging|damaged|late|fake|rude|itching|basag|peke|bastos/) ? true : false;
        const risk = getRiskLevel(eng, cat);
        
        return {
            id: Date.now() + Math.random(),
            text: text,
            translation: eng,
            cat: cat,
            riskLevel: risk.label,
            riskClass: risk.class,
            strategy: STRATEGY_MAP[cat],
            response: RESPONSE_MAP[cat],
            voucher: isNegative ? "MV500-" + Math.random().toString(36).substring(2, 7).toUpperCase() : null,
            timestamp: new Date().toLocaleString()
        };
    }

    function processBatch() {
        const input = document.getElementById('reviewInput').value;
        const lines = input.split('\n').filter(l => l.trim() !== "");
        if(!lines.length) return;

        let currentHistory = JSON.parse(localStorage.getItem(`db_${serverId}`)) || [];
        lines.forEach(line => {
            const analysis = analyzeLogic(line);
            currentHistory.unshift(analysis);
        });

        localStorage.setItem(`db_${serverId}`, JSON.stringify(currentHistory));
        document.getElementById('reviewInput').value = "";
        refreshDashboard();
    }

    function refreshDashboard() {
        const history = JSON.parse(localStorage.getItem(`db_${serverId}`)) || [];
        const feed = document.getElementById('neuralFeed');
        const voucherBody = document.getElementById('voucherTableBody');
        
        feed.innerHTML = "";
        voucherBody.innerHTML = "";

        let counts = { "Skin": 0, "Logistics": 0, "Quality": 0, "Riders' Conduct": 0, "General": 0 };

        history.forEach(item => {
            counts[item.cat]++;

            const itemEl = document.createElement('div');
            itemEl.className = "feed-item";
            const riskHtml = item.cat === "Skin" ? `<span class="risk-badge ${item.riskClass}">${item.riskLevel}</span>` : "";
            
            itemEl.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <strong>[${item.cat}]</strong>
                    <small style="opacity:0.5">${item.timestamp}</small>
                </div>
                "${item.text}" ${riskHtml}
                <span class="translation-tag">Translation: ${item.translation}</span>
                <div class="strategy-pill">Action: ${item.strategy}</div>
                <div class="response-text" onclick="copyText('${item.response}')">
                    <small style="color:var(--pink)">Suggested Response (Click to Copy):</small><br>${item.response}
                </div>
            `;
            feed.appendChild(itemEl);

            if(item.voucher) {
                voucherBody.innerHTML += `<tr><td>${item.voucher}</td><td>${item.cat}</td><td style="color:var(--success)">ACTIVE</td></tr>`;
            }
        });

        document.getElementById('statSkin').innerText = counts["Skin"];
        document.getElementById('statLog').innerText = counts["Logistics"];
        document.getElementById('statRider').innerText = counts["Riders' Conduct"];
        document.getElementById('statQual').innerText = counts["Quality"];

        updateChart(counts);
    }

    // New Excel Export Engine
    function exportToExcel() {
        const history = JSON.parse(localStorage.getItem(`db_${serverId}`)) || [];
        if(!history.length) return alert("No data to export!");

        const excelData = history.map(item => ({
            "Date/Time": item.timestamp,
            "Painpoint Category": item.cat,
            "Risk Level": item.riskLevel,
            "Customer Feedback": item.text,
            "NLP Translation": item.translation,
            "Business Strategy": item.strategy,
            "Suggested Response": item.response,
            "Voucher Code": item.voucher || "N/A"
        }));

        const worksheet = XLSX.utils.json_to_sheet(excelData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Analysis_Report");
        
        // Auto-size columns logic
        const max_width = excelData.reduce((w, r) => Math.max(w, r["Customer Feedback"].length), 10);
        worksheet["!cols"] = [ {wch: 20}, {wch: 15}, {wch: 12}, {wch: 50}, {wch: 30}, {wch: 30}, {wch: 40}, {wch: 15} ];

        XLSX.writeFile(workbook, `Mariposa_NLP_Export_${serverId}.xlsx`);
    }

    function updateChart(counts) {
        if(charts.pie) charts.pie.destroy();
        const ctx = document.getElementById('pieChart').getContext('2d');
        charts.pie = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(counts),
                datasets: [{
                    data: Object.values(counts),
                    backgroundColor: ['#ff4757', '#3b82f6', '#2ed573', '#f1c40f', '#747d8c'],
                    borderWidth: 0
                }]
            },
            options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    function copyBulkSentiments() {
        const history = JSON.parse(localStorage.getItem(`db_${serverId}`)) || [];
        if(!history.length) return alert("No history to copy.");
        const text = history.map(h => `Customer: ${h.text}\nAI: ${h.response}\n---`).join('\n');
        copyText(text);
        alert("All responses copied to clipboard!");
    }

    function wipeHistory() {
        if(confirm("Are you sure? This will delete all saved data.")) {
            localStorage.removeItem(`db_${serverId}`);
            refreshDashboard();
        }
    }

    function copyText(txt) { navigator.clipboard.writeText(txt); }
    function toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); }

    refreshDashboard();
</script>

</body>
</html>

