<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mariposa NLP Pro | Collab v9.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f8fafc; --surface: #ffffff; --border: #e2e8f0;
            --text: #0f172a; --text-light: #64748b;
            --primary: #0f172a; --primary-hover: #334155;
            --accent: #8b5cf6; 
            --danger: #ef4444; --danger-bg: #fef2f2;
            --success: #10b981; --success-bg: #f0fdf4;
            --warning: #f59e0b; --warning-bg: #fffbeb;
            --radius: 8px;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        [data-theme="dark"] {
            --bg: #09090b; --surface: #18181b; --border: #27272a;
            --text: #fafafa; --text-light: #a1a1aa;
            --primary: #fafafa; --primary-hover: #d4d4d8;
            --danger-bg: rgba(239,68,68,0.1);
            --success-bg: rgba(16,185,129,0.1);
            --warning-bg: rgba(245,158,11,0.1);
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; font-size: 14px; line-height: 1.5; transition: 0.2s; }
        
        .layout { display: grid; grid-template-columns: 280px 1fr; gap: 24px; max-width: 1600px; margin: 0 auto; height: 95vh; }
        .sidebar { display: flex; flex-direction: column; gap: 16px; }
        .main { display: flex; flex-direction: column; gap: 16px; overflow: hidden; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); }

        h1 { font-size: 1.1rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 8px; }
        .brand-dot { width: 10px; height: 10px; background: var(--accent); border-radius: 50%; }
        
        .card { background: var(--surface); padding: 16px; border-radius: var(--radius); border: 1px solid var(--border); }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-item { padding: 10px; background: var(--bg); border-radius: 6px; }
        .stat-val { font-size: 1.2rem; font-weight: 700; display: block; }
        .stat-lbl { font-size: 0.7rem; color: var(--text-light); text-transform: uppercase; font-weight: 600; }

        .btn { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid transparent; font-weight: 500; font-size: 0.85rem; cursor: pointer; transition: 0.15s; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: var(--bg); }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-outline { background: transparent; border-color: var(--border); color: var(--text); }
        .btn-outline:hover { background: var(--bg); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-ghost { background: transparent; color: var(--text-light); padding: 4px; width: auto; }
        .btn-ghost:hover { color: var(--text); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Server Box */
        .server-box { border: 1px dashed var(--accent); background: rgba(139, 92, 246, 0.05); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-light); display: inline-block; }
        .status-on { background: var(--success); box-shadow: 0 0 8px var(--success); }

        .feed-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg); }
        .feed-scroll { overflow-y: auto; flex: 1; padding: 0 16px; }
        
        .review-item { padding: 16px 0; border-bottom: 1px solid var(--border); display: grid; grid-template-columns: 60px 1fr 220px; gap: 20px; animation: slideIn 0.2s ease; }
        .review-item:last-child { border-bottom: none; }
        
        .avatar { width: 40px; height: 40px; background: var(--bg); border-radius: 50%; display: grid; place-items: center; font-size: 0.8rem; font-weight: 700; color: var(--text-light); border: 1px solid var(--border); }
        
        .meta-tags { display: flex; gap: 6px; margin-bottom: 6px; }
        .tag { font-size: 0.7rem; padding: 2px 8px; border-radius: 99px; font-weight: 600; border: 1px solid transparent; }
        .tag-high { background: var(--danger-bg); color: var(--danger); border-color: rgba(239,68,68,0.2); }
        .tag-mid { background: var(--warning-bg); color: var(--warning); border-color: rgba(245,158,11,0.2); }
        .tag-safe { background: var(--success-bg); color: var(--success); border-color: rgba(16,185,129,0.2); }
        
        .ai-response { background: var(--bg); padding: 12px; border-radius: 6px; font-size: 0.85rem; margin-top: 8px; border-left: 3px solid var(--accent); }
        
        /* Editable Content */
        .editable-text { border-bottom: 1px dashed transparent; cursor: text; }
        .editable-text:hover { border-bottom-color: var(--text-light); }
        .editable-text:focus { background: var(--warning-bg); border-bottom: 1px solid var(--warning); }

        .actions { display: flex; flex-direction: column; gap: 6px; justify-content: flex-start; }

        input, select, textarea { width: 100%; padding: 10px; background: var(--surface); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: inherit; font-size: 0.9rem; }
        input:focus { border-color: var(--text-light); }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; place-items: center; z-index: 50; backdrop-filter: blur(2px); }
        .modal-box { background: var(--surface); width: 800px; max-width: 95%; padding: 24px; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); border: 1px solid var(--border); display: flex; flex-direction: column; height: 80vh; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="layout">
    <div class="sidebar">
        <div class="card" style="display: flex; justify-content: space-between; align-items: center;">
            <h1><span class="brand-dot"></span> Mariposa v9</h1>
        </div>

        <div class="card server-box">
            <h3 style="margin: 0 0 10px 0; font-size: 0.75rem; color: var(--accent); letter-spacing: 0.5px;">üì° SERVER LINK</h3>
            <div style="display: flex; gap: 5px; margin-bottom: 8px;">
                <input type="text" id="serverInput" placeholder="Enter Server ID (e.g. TEAM-A)" style="padding: 6px; font-size: 0.8rem;">
                <button class="btn btn-primary" style="width: auto; padding: 6px 12px;" onclick="app.connectServer()">Join</button>
            </div>
            <div style="font-size: 0.75rem; color: var(--text-light); display: flex; align-items: center; gap: 6px;">
                <span id="serverDot" class="status-dot"></span> 
                <span id="serverStatus">Offline (Local Only)</span>
            </div>
            <div style="margin-top: 12px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="safetyLock" checked onchange="app.toggleLock()" style="width: auto;">
                <span style="font-size: 0.8rem; font-weight: 600;">Safety Lock (Prevent Deletion)</span>
            </div>
        </div>

        <div class="card">
            <h3 style="margin: 0 0 12px 0; font-size: 0.8rem; color: var(--text-light);">REAL-TIME METRICS</h3>
            <div class="stat-grid">
                <div class="stat-item"><span class="stat-val" id="st-total">0</span><span class="stat-lbl">Processed</span></div>
                <div class="stat-item"><span class="stat-val" id="st-risk" style="color:var(--danger)">0</span><span class="stat-lbl">Critical</span></div>
                <div class="stat-item"><span class="stat-val" id="st-leads" style="color:var(--success)">0</span><span class="stat-lbl">Leads</span></div>
                <div class="stat-item"><span class="stat-val" id="st-skin" style="color:var(--accent)">0</span><span class="stat-lbl">Clinical</span></div>
            </div>
        </div>

        <div class="card" style="flex: 1; display: flex; flex-direction: column; gap: 10px;">
            <button class="btn btn-primary" onclick="ui.modal('importModal')">üì• Batch Import</button>
            <button class="btn btn-outline" onclick="io.exportExcel()">üìä Export Report</button>
            <div style="height: 1px; background: var(--border); margin: 5px 0;"></div>
            <button class="btn btn-outline" onclick="io.syncTeam()">‚òÅÔ∏è Download Server Data</button>
            <input type="file" id="teamFile" hidden onchange="io.mergeTeam(this)">
            <button class="btn btn-outline" onclick="document.getElementById('teamFile').click()">üìÇ Upload/Merge Data</button>
            <div style="flex: 1;"></div>
            <button class="btn btn-ghost delete-btn" onclick="app.wipe()" style="color: var(--danger);">Reset Database</button>
            <button class="btn btn-ghost" onclick="ui.theme()">Toggle Theme</button>
        </div>
    </div>

    <div class="main">
        <div class="feed-header">
            <div style="display: flex; gap: 12px; align-items: center; flex: 1;">
                <input type="text" id="search" placeholder="Search by symptom, product, or ID..." style="max-width: 300px;" onkeyup="ui.render()">
                <label style="font-size: 0.8rem; display: flex; align-items: center; gap: 6px; cursor: pointer;">
                    <input type="checkbox" id="showArchive" onchange="ui.render()" style="width: auto;"> View Archived
                </label>
            </div>
            <div class="org-badge" style="font-size: 0.75rem; font-family: 'JetBrains Mono'; color: var(--text-light);">
                BRAIN: <span id="brainCount">0</span> NODES
            </div>
        </div>

        <div class="feed-scroll" id="feed">
            </div>
    </div>
</div>

<div id="importModal" class="modal">
    <div class="modal-box">
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <h2 style="margin: 0;">Bulk Sentiment Import</h2>
            <button class="btn btn-ghost" style="width: auto;" onclick="document.getElementById('importModal').style.display='none'">‚úï</button>
        </div>
        <p style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 10px;">Paste unlimited reviews below. The Omni-Lexicon Engine will analyze context, medical risks, and sentiment intent.</p>
        <textarea id="rawInput" style="flex: 1; resize: none; font-family: 'JetBrains Mono', monospace;" placeholder="Paste reviews here..."></textarea>
        <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 20px;">
            <span id="charCount" style="font-size: 0.8rem; color: var(--text-light); align-self: center;">0 chars</span>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-outline" style="width: auto;" onclick="document.getElementById('rawInput').value=''">Clear</button>
                <button class="btn btn-primary" style="width: auto;" onclick="nlp.process()">Analyze & Import</button>
            </div>
        </div>
    </div>
</div>

<div id="teachModal" class="modal">
    <div class="modal-box" style="max-width: 400px; height: auto;">
        <h2 style="margin-top: 0;">üß† Train Logic</h2>
        <input type="text" id="t-word" placeholder="Word/Phrase" style="margin-bottom: 10px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
            <select id="t-sent"><option value="Positive">Positive</option><option value="Negative">Negative</option><option value="Neutral">Neutral</option></select>
            <select id="t-risk"><option value="Low">Low Risk</option><option value="Mid">Mid Risk</option><option value="High">High Risk</option></select>
        </div>
        <select id="t-cat" style="margin-bottom: 20px;">
            <option value="Skin">Skin/Clinical</option>
            <option value="Quality">Product Quality</option>
            <option value="Logistics">Logistics/Shipping</option>
        </select>
        <button class="btn btn-primary" onclick="nlp.saveRule()">Save Rule</button>
    </div>
</div>

<script>
/**
 * MARIPOSA v9.0 COLLAB EDITION
 * Includes BroadcastChannel for local sync & Simulated Server ID
 */

const DB_KEY_PREFIX = "MP_V9_DATA_";
const BRAIN_KEY = "MP_V9_BRAIN";
const CONFIG_KEY = "MP_V9_CONFIG";

// --- 1. OMNI-LEXICON ---
const LEXICON = {
    negators: ['hindi', 'di', 'ayaw', 'wala', 'not', 'no', 'stop', 'dont', 'wag', 'huwag'],
    flippers: ['pero', 'kaso', 'but', 'however', 'sayang', 'although'],
    dict: {
        'pumutok': { c:'Skin', r:'High', s:-5, advice:'Clean wound immediately. Stop use.' },
        'sugat': { c:'Skin', r:'High', s:-5, advice:'Do not use on open wounds.' },
        'namaga': { c:'Skin', r:'High', s:-5, advice:'Cold compress. Take antihistamine.' },
        'swollen': { c:'Skin', r:'High', s:-5, advice:'Cold compress immediately.' },
        'burn': { c:'Skin', r:'High', s:-5, advice:'Treat as chemical burn.' },
        'blister': { c:'Skin', r:'High', s:-5, advice:'Do not pop blisters.' },
        'mahapdi': { c:'Skin', r:'Mid', s:-3, advice:'Rinse with cold water.' },
        'hapdi': { c:'Skin', r:'Mid', s:-3, advice:'Rinse with cold water.' },
        'kati': { c:'Skin', r:'Mid', s:-2, advice:'Avoid scratching. Apply moisturizer.' },
        'breakout': { c:'Skin', r:'Mid', s:-3, advice:'Pause active ingredients.' },
        'butlig': { c:'Skin', r:'Mid', s:-2, advice:'Observe if allergic reaction.' },
        'init': { c:'Skin', r:'Low', s:-1, advice:'Slight heat is normal.' },
        'tagal': { c:'Logistics', r:'Low', s:-2 },
        'bagal': { c:'Logistics', r:'Low', s:-2 },
        'yupi': { c:'Logistics', r:'Low', s:-2 },
        'spill': { c:'Logistics', r:'Low', s:-3 },
        'rude': { c:'Rider', r:'Low', s:-4 },
        'fake': { c:'Quality', r:'High', s:-5 }, 
        'scam': { c:'Quality', r:'High', s:-5 },
        'expired': { c:'Quality', r:'High', s:-5 },
        'baho': { c:'Quality', r:'Low', s:-3 },
        'effective': { c:'Skin', r:'Low', s:4 },
        'glow': { c:'Skin', r:'Low', s:4 },
        'hiyang': { c:'Skin', r:'Low', s:5, tag:'LEAD' },
        'legit': { c:'Quality', r:'Low', s:4 },
        'love': { c:'Quality', r:'Low', s:4 }
    }
};

const app = {
    serverID: 'LOCAL',
    data: [],
    rules: JSON.parse(localStorage.getItem(BRAIN_KEY)) || {},
    channel: null,
    locked: true,

    init: () => {
        // Load Config
        const savedConfig = JSON.parse(localStorage.getItem(CONFIG_KEY)) || {};
        if(savedConfig.serverID) {
            document.getElementById('serverInput').value = savedConfig.serverID;
            app.connectServer();
        } else {
            app.loadData();
        }
        app.toggleLock(); // Initialize UI state
        document.getElementById('brainCount').innerText = Object.keys(app.rules).length;
    },

    connectServer: () => {
        const input = document.getElementById('serverInput').value.trim().toUpperCase();
        if(!input) return;

        // Disconnect old
        if(app.channel) app.channel.close();

        app.serverID = input;
        
        // Setup Broadcast for Multi-Tab Sync
        app.channel = new BroadcastChannel('MP_SYNC_' + app.serverID);
        app.channel.onmessage = (ev) => {
            if(ev.data.type === 'UPDATE') {
                app.data = ev.data.payload;
                ui.render();
            }
        };

        // UI Updates
        document.getElementById('serverStatus').innerText = `Connected: ${app.serverID}`;
        document.getElementById('serverDot').classList.add('status-on');
        
        // Persist Config
        localStorage.setItem(CONFIG_KEY, JSON.stringify({ serverID: app.serverID }));
        
        app.loadData();
    },

    loadData: () => {
        const key = DB_KEY_PREFIX + app.serverID;
        app.data = JSON.parse(localStorage.getItem(key)) || [];
        ui.render();
    },

    save: () => {
        const key = DB_KEY_PREFIX + app.serverID;
        localStorage.setItem(key, JSON.stringify(app.data));
        // Broadcast change to other tabs
        if(app.channel) app.channel.postMessage({ type: 'UPDATE', payload: app.data });
        ui.render();
    },

    toggleLock: () => {
        app.locked = document.getElementById('safetyLock').checked;
        const deleteBtns = document.querySelectorAll('.delete-btn');
        deleteBtns.forEach(btn => btn.disabled = app.locked);
    },

    wipe: () => {
        if(app.locked) return alert("Unlock Safety Lock first.");
        if(confirm(`Delete ALL data for Server: ${app.serverID}?`)) { 
            app.data = []; 
            app.save(); 
        }
    },

    updateText: (id, newText) => {
        const item = app.data.find(i => i.id === id);
        if(item) {
            item.text = newText;
            app.save();
        }
    }
};

// --- 2. NLP LOGIC ---
const nlp = {
    process: () => {
        const raw = document.getElementById('rawInput').value;
        if(!raw.trim()) return;
        const lines = raw.split('\n').filter(l => l.length > 2);
        
        lines.forEach(text => {
            let cleanText = text.replace(/(\+63|0)9\d{9}/g, '[PHONE]').replace(/[a-zA-Z0-9._-]+@[a-z]+\.[a-z]+/g, '[EMAIL]');
            let lower = cleanText.toLowerCase();
            let tokens = lower.split(/[\s.,!?]+/);
            
            let score = 0;
            let cat = 'General';
            let risk = 'Low';
            let advice = null;
            let detected = [];
            let flipperActive = false; 

            for(let i=0; i<tokens.length; i++) {
                let w = tokens[i];
                let prev = i>0 ? tokens[i-1] : '';
                
                if (LEXICON.flippers.includes(w)) { flipperActive = true; continue; }

                let isNegated = LEXICON.negators.includes(prev);
                let multiplier = isNegated ? -1 : 1;
                if (flipperActive) multiplier *= 1.5; 

                let rule = app.rules[w] || LEXICON.dict[w];
                if(!rule) {
                    let key = Object.keys(LEXICON.dict).find(k => w.includes(k)); 
                    if(key) rule = LEXICON.dict[key];
                }

                if(rule) {
                    if(isNegated && rule.s < 0) {
                        score += 2; 
                    } else {
                        score += (rule.s * multiplier);
                        detected.push(w);
                        if(rule.c === 'Skin' || rule.c === 'Quality') cat = rule.c;
                        if(rule.c === 'Logistics') cat = 'Logistics';
                        if(rule.r === 'High') risk = 'High';
                        else if(rule.r === 'Mid' && risk !== 'High') risk = 'Mid';
                        if(rule.advice && !isNegated) advice = rule.advice;
                    }
                }
            }

            let sent = score > 0 ? 'Positive' : (score < 0 ? 'Negative' : 'Neutral');
            
            let response = "";
            if(risk === 'High') response = `üö® <strong>CRITICAL:</strong> Stop use immediately. ${advice || 'Contact Support.'}`;
            else if(risk === 'Mid') response = `ü©∫ <strong>ADVICE:</strong> "${advice || 'Pause use for 2-3 days.'}"`;
            else if(cat === 'Logistics' && sent === 'Negative') response = `üöö <strong>LOGISTICS:</strong> Apologize for delay.`;
            else if(sent === 'Positive') response = `üíñ <strong>ENGAGEMENT:</strong> Thank customer!`;
            else response = `üí¨ <strong>SUPPORT:</strong> Acknowledge feedback.`;

            app.data.unshift({
                id: 'T-' + Math.random().toString(36).substr(2,5).toUpperCase(),
                text: cleanText,
                sent, cat, risk, score,
                tags: detected,
                response,
                archived: false,
                date: new Date().toISOString()
            });
        });

        app.save();
        document.getElementById('importModal').style.display = 'none';
        document.getElementById('rawInput').value = '';
    },

    saveRule: () => {
        let w = document.getElementById('t-word').value.toLowerCase();
        if(!w) return;
        app.rules[w] = {
            c: document.getElementById('t-cat').value,
            r: document.getElementById('t-risk').value,
            s: document.getElementById('t-sent').value === 'Positive' ? 4 : -4
        };
        localStorage.setItem(BRAIN_KEY, JSON.stringify(app.rules));
        alert("Brain Updated! Future imports will use this logic.");
        document.getElementById('teachModal').style.display = 'none';
        document.getElementById('brainCount').innerText = Object.keys(app.rules).length;
    }
};

// --- 3. UI & IO ---
const ui = {
    modal: (id) => document.getElementById(id).style.display = 'grid',
    
    render: () => {
        const list = document.getElementById('feed');
        const search = document.getElementById('search').value.toLowerCase();
        const showArchived = document.getElementById('showArchive').checked;
        
        list.innerHTML = '';
        let stats = { total:0, risk:0, leads:0, skin:0 };

        app.data.forEach(item => {
            if(item.archived && !showArchived) return;
            if(!item.archived && showArchived) return;
            if(search && !item.text.toLowerCase().includes(search)) return;

            stats.total++;
            if(item.risk === 'High') stats.risk++;
            if(item.sent === 'Positive') stats.leads++;
            if(item.cat === 'Skin' && item.risk !== 'Low') stats.skin++;

            let btns = '';
            if(item.risk === 'High') {
                btns += `<button class="btn btn-danger btn-ghost" onclick="alert('Refund Processed')">üí∏ Refund</button>`;
            } 

            let div = document.createElement('div');
            div.className = 'review-item';
            div.innerHTML = `
                <div style="text-align:center">
                    <div class="avatar">${item.score}</div>
                    <small style="color:var(--text-light)">${item.id}</small>
                </div>
                <div>
                    <div class="meta-tags">
                        <span class="tag tag-${item.risk === 'High' ? 'high' : (item.risk === 'Mid' ? 'mid' : 'safe')}">${item.risk} Risk</span>
                        <span class="tag" style="background:var(--bg); border:1px solid var(--border)">${item.cat}</span>
                        <span class="tag" style="color:var(--text-light)">${item.sent}</span>
                    </div>
                    <div class="editable-text" contenteditable="true" 
                         onblur="app.updateText('${item.id}', this.innerText)" 
                         style="font-size:0.95rem; font-weight:500; padding:4px 0;">${item.text}</div>
                    <div class="ai-response">${item.response}</div>
                </div>
                <div class="actions">
                    ${btns}
                    <button class="btn btn-primary" onclick="ui.teach('${item.id}')">üéì Teach AI</button>
                    <button class="btn btn-ghost delete-btn" onclick="io.archive('${item.id}')" ${app.locked ? 'disabled' : ''}>${item.archived ? 'Unarchive' : 'Archive'}</button>
                </div>
            `;
            list.appendChild(div);
        });

        document.getElementById('st-total').innerText = stats.total;
        document.getElementById('st-risk').innerText = stats.risk;
        document.getElementById('st-leads').innerText = stats.leads;
        document.getElementById('st-skin').innerText = stats.skin;
    },

    teach: (id) => {
        const item = app.data.find(i => i.id === id);
        if(item && item.tags[0]) document.getElementById('t-word').value = item.tags[0];
        ui.modal('teachModal');
    },

    theme: () => {
        const b = document.body;
        b.setAttribute('data-theme', b.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
    }
};

const io = {
    archive: (id) => {
        if(app.locked) return;
        let i = app.data.find(x => x.id === id);
        if(i) { i.archived = !i.archived; app.save(); }
    },
    exportExcel: () => {
        let csv = "ID,Text,Sentiment,Risk,Category,Advice\n" + app.data.map(i => 
            `${i.id},"${i.text.replace(/"/g,'""')}",${i.sent},${i.risk},${i.cat},"${i.response.replace(/<[^>]*>/g,'')}"`
        ).join('\n');
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([csv], {type: 'text/csv'}));
        a.download = `Mariposa_${app.serverID}_Report.csv`;
        a.click();
    },
    syncTeam: () => {
        const blob = new Blob([JSON.stringify(app.data)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Mariposa_Backup_${app.serverID}.json`;
        a.click();
    },
    mergeTeam: (input) => {
        if(app.locked) return alert("Please unlock Safety Lock to import data.");
        const reader = new FileReader();
        reader.onload = (e) => {
            const income = JSON.parse(e.target.result);
            let count = 0;
            income.forEach(i => { 
                if(!app.data.find(d => d.id === i.id)) {
                    app.data.push(i); 
                    count++;
                }
            });
            app.save(); 
            alert(`Merged ${count} records into Server ${app.serverID}.`);
        };
        reader.readAsText(input.files[0]);
    }
};

document.getElementById('rawInput').addEventListener('input', function() {
    document.getElementById('charCount').innerText = this.value.length + " chars";
});

app.init();
</script>
</body>
</html>

