<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D.Z. MARIPOSA NLP v32.0 - NEURAL CONVERSION</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --m-pink: #ff85a2; --m-hot: #d63384; --m-black: #121212; 
            --white: #ffffff; --critical: #ff4757; --pos: #2ed573; 
            --neutral: #747d8c; --voucher: #3b82f6; --gold: #f1c40f;
            --bg: var(--m-black); --card-bg: #1e1e1e; --text: var(--white);
        }
        body.light-mode { --bg: #f5f6fa; --card-bg: #ffffff; --text: #2f3640; }

        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; color: var(--text); overflow-x: hidden; }
        .container { width: 100%; padding: 15px; box-sizing: border-box; display: grid; gap: 20px; grid-template-columns: 1fr; }
        @media (min-width: 1024px) { .container { grid-template-columns: 420px 1fr; } }
        
        .navbar { background: var(--m-black); padding: 15px 25px; border-bottom: 2px solid var(--m-hot); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 18px; border: 1px solid rgba(255,133,162,0.1); margin-bottom: 15px; }
        
        textarea, input, select { width: 100%; background: #000; color: var(--text); border: 1px solid #333; border-radius: 8px; padding: 10px; box-sizing: border-box; font-size: 12px; margin-bottom: 8px; }
        .btn { padding: 10px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; width: 100%; text-transform: uppercase; font-size: 10px; transition: 0.2s; }
        .btn-main { background: var(--m-hot); color: white; }
        
        .response-box { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; border-left: 5px solid var(--gold); margin-top: 10px; font-size: 13px; line-height: 1.5; }
        .host-action-box { background: rgba(255,133,162,0.1); padding: 10px; border-radius: 8px; margin-top: 8px; border: 1px dashed var(--m-pink); font-size: 11px; color: var(--m-pink); font-weight: 700; }
        
        .kb-term { cursor: pointer; display: block; background: #333; padding: 8px; border-radius: 4px; margin: 4px 0; border-left: 3px solid var(--m-pink); user-select: none; }
        .kb-term:active { background: var(--critical); }
        .sync-active { font-size: 9px; color: var(--pos); font-weight: bold; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div>
            <div style="font-family:'Playfair Display'; font-weight:900; color:var(--m-pink); font-size: 1.3rem;">üå∫ MARIPOSA NLP v32.0</div>
            <div class="sync-active">‚óè GKS AUTO-PROTOCOL ACTIVE</div>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn" style="width:auto; background:#333; color:white;" onclick="toggleTheme()">üåì THEME</button>
            <button class="btn" style="width:auto; background:var(--voucher); color:white;" onclick="exportData()">üì• EXPORT</button>
        </div>
    </nav>

    <div class="container">
        <div class="sidebar">
            <div class="card">
                <h4 style="margin:0 0 10px 0; font-size:12px; color:var(--gold);">üß† SENTENCE SYNC PRECISION</h4>
                <textarea id="newWord" style="height:50px;" placeholder="Identify Customer Sentence..."></textarea>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                    <select id="newWeight">
                        <option value="-50">Negative</option>
                        <option value="0">Neutral</option>
                        <option value="50">Positive</option>
                    </select>
                    <select id="newCat" onchange="toggleOptional()">
                        <option value="Skin">Skin/Clinical</option>
                        <option value="Logistics">Logistics</option>
                        <option value="Quality">Quality</option>
                        <option value="Rider">Rider Problem</option>
                        <option value="Optional">Optional (Custom)</option>
                    </select>
                </div>
                <input type="text" id="customCat" style="display:none;" placeholder="Define Custom Painpoint...">
                
                <textarea id="sysResponse" style="height:50px;" placeholder="Systematic Response Template..."></textarea>
                
                <button onclick="addKnowledge()" class="btn btn-main">+ SYNC TO ANALYZER</button>
                <div id="dictDisplay" style="max-height:120px; overflow-y:auto; margin-top:10px; font-size:10px;"></div>
                <small style="color:#666; font-size:8px;">Hold item to delete</small>
            </div>

            <div class="card">
                <h4 style="margin:0 0 5px 0; font-size:11px; color:#888;">BULK DATA INTAKE</h4>
                <textarea id="reviewInput" placeholder="Paste reviews for conversion analysis..."></textarea>
                <button class="btn btn-main" style="background:var(--pos); color:black;" onclick="processIntake()">‚ö° ANALYZE & CONVERT</button>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <h4 style="margin:0 0 10px 0; font-size:12px; color:var(--m-pink);">üìä PAINPOINT DISTRIBUTION (CONVERSION TARGETS)</h4>
                <div style="height:150px;"><canvas id="painChart"></canvas></div>
            </div>
            <div id="historyList"></div>
        </div>
    </div>

<script>
    let db = JSON.parse(localStorage.getItem('m_v32_db')) || [];
    let knowledge = JSON.parse(localStorage.getItem('m_kb_v32')) || {
        "nangatol": {w: -50, c: "Skin", r: "Safety First: Please stop application. Wash with cool water. Our clinical lead will assist you in 5 mins."},
        "rider": {w: -30, c: "Rider", r: "We apologize for the courier's behavior. We are filing a formal report with the hub manager."}
    };
    let painChart;

    function toggleTheme() { document.body.classList.toggle('light-mode'); }
    function toggleOptional() { document.getElementById('customCat').style.display = document.getElementById('newCat').value === 'Optional' ? 'block' : 'none'; }

    // GKS GLOBAL PROTOCOLS
    const GKS_PROTOCOLS = {
        "Skin": { strat: "CLINICAL RECOVERY", action: "Identify ingredient sensitivity. Send dermatological-safe alternative or refund." },
        "Logistics": { strat: "SPEED RECOVERY", action: "Carrier KPI failure. Expedite next delivery and waive shipping fees." },
        "Quality": { strat: "TRUST REINFORCEMENT", action: "Batch verification active. Provide lab certificate to restore brand confidence." },
        "Rider": { strat: "PARTNER CONDUCT", action: "Logistics partner escalation. Offer discount for the inconvenience." },
        "Inquiry": { strat: "KNOWLEDGE CONVERSION", action: "Answer technical specs based on global clinical standards to close the sale." }
    };

    function addKnowledge() {
        const sentence = document.getElementById('newWord').value.toLowerCase().trim();
        const weight = parseInt(document.getElementById('newWeight').value);
        let cat = document.getElementById('newCat').value;
        const response = document.getElementById('sysResponse').value;
        
        if(cat === 'Optional') cat = document.getElementById('customCat').value || "Custom";
        
        if(sentence && response) {
            knowledge[sentence] = { w: weight, c: cat, r: response };
            saveKB();
            document.getElementById('newWord').value = '';
            document.getElementById('sysResponse').value = '';
            autoCorrect();
        }
    }

    let holdTimer;
    function renderKB() {
        const container = document.getElementById('dictDisplay');
        container.innerHTML = Object.keys(knowledge).map(k => `
            <div class="kb-term" onmousedown="startHold('${k}')" onmouseup="clearHold()" ontouchstart="startHold('${k}')" ontouchend="clearHold()">
                <b>${k}</b> <small>[${knowledge[k].c}]</small>
            </div>
        `).join('');
    }

    function startHold(k) { holdTimer = setTimeout(() => { if(confirm("Delete pattern?")) { delete knowledge[k]; saveKB(); autoCorrect(); } }, 700); }
    function clearHold() { clearTimeout(holdTimer); }

    function analyze(text) {
        const low = text.toLowerCase();
        let score = 0;
        let cat = "General";
        let suggest = "Thank you for your feedback. How can we help you today?";
        let isInquiry = text.includes('?') || text.toLowerCase().includes('how') || text.toLowerCase().includes('ano');

        // Systematic Match
        Object.keys(knowledge).forEach(k => {
            if(low.includes(k)) {
                score = knowledge[k].w;
                cat = knowledge[k].c;
                suggest = knowledge[k].r;
            }
        });

        // GKS Layer
        const gks = GKS_PROTOCOLS[cat] || GKS_PROTOCOLS["Inquiry"];
        if(isInquiry && score === 0) {
            suggest = "AUTO-GKS: " + suggest + " (Clinical Standard: Product is pH balanced and tested for 2026 safety norms).";
        }

        return { text, score, cat, suggest, hostAction: gks.action, strat: gks.strat, timestamp: new Date().toLocaleString() };
    }

    function processIntake() {
        const input = document.getElementById('reviewInput').value.trim();
        if(!input) return;
        input.split('\n').forEach(line => {
            if(line.trim()) db.push({ ...analyze(line), id: Date.now() + Math.random() });
        });
        document.getElementById('reviewInput').value = '';
        saveData();
    }

    function autoCorrect() { db = db.map(item => ({ ...item, ...analyze(item.text) })); saveData(); }
    function saveKB() { localStorage.setItem('m_kb_v32', JSON.stringify(knowledge)); renderKB(); }
    function saveData() { localStorage.setItem('m_v32_db', JSON.stringify(db)); render(); }

    function render() {
        document.getElementById('historyList').innerHTML = db.slice().reverse().map(i => `
            <div class="card" style="border-left: 5px solid ${i.score > 0 ? 'var(--pos)' : i.score < 0 ? 'var(--critical)' : 'var(--neutral)'}">
                <div style="display:flex; justify-content:space-between; align-items:start;">
                    <span class="btn" style="width:auto; background:var(--m-pink); color:black; padding:2px 8px;">${i.cat}</span>
                    <button onclick="deleteItem(${i.id})" style="background:none; border:none; color:#555;">üóëÔ∏è</button>
                </div>
                <p style="font-weight:700; margin:10px 0;">"${i.text}"</p>
                <div class="response-box"><b>üìã SYSTEMATIC REPLY:</b><br>${i.suggest}</div>
                <div class="host-action-box">üí° CONVERSION STRATEGY [${i.strat}]: ${i.hostAction}</div>
            </div>
        `).join('');
        updateChart();
    }

    function updateChart() {
        if(painChart) painChart.destroy();
        const counts = {};
        db.forEach(i => counts[i.cat] = (counts[i.cat] || 0) + 1);
        painChart = new Chart(document.getElementById('painChart'), {
            type: 'bar',
            data: { 
                labels: Object.keys(counts), 
                datasets: [{ data: Object.values(counts), backgroundColor: '#ff85a2' }] 
            },
            options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#333' } } } }
        });
    }

    function deleteItem(id) { db = db.filter(i => i.id !== id); saveData(); }
    function exportData() {
        const ws = XLSX.utils.json_to_sheet(db);
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Mariposa_Analysis");
        XLSX.writeFile(wb, "Mariposa_Conversion_Report.xlsx");
    }

    renderKB(); render();
</script>
</body>
</html>

