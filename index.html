<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D.Z. Mariposa NLP v14 - Full Control Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --mariposa-pink: #ff85a2; --mariposa-hot: #d63384;
            --mariposa-black: #121212; --mariposa-dark-grey: #1e1e1e;
            --white: #ffffff; --critical: #ff4757; --pos: #2ed573; 
        }
        
        body { font-family: 'Inter', sans-serif; background: var(--mariposa-black); margin: 0; color: var(--white); }
        .container { width: 95%; max-width: 1400px; margin: 10px auto; padding: 10px; box-sizing: border-box; }
        
        .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 1024px) { .dashboard-grid { grid-template-columns: 400px 1fr; } }

        .navbar { 
            background: linear-gradient(90deg, #000 0%, var(--mariposa-dark-grey) 100%); 
            padding: 15px; border-bottom: 2px solid var(--mariposa-hot);
            display: flex; justify-content: space-between; align-items: center;
        }

        .card { background: var(--mariposa-dark-grey); border-radius: 12px; padding: 18px; border: 1px solid rgba(255,133,162,0.1); position: relative; }
        
        textarea { 
            width: 100%; height: 120px; border: 1px solid #333; border-radius: 8px; 
            padding: 12px; background: #000; color: #fff; font-size: 14px; box-sizing: border-box;
        }

        .btn { padding: 12px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; width: 100%; margin-top: 10px; transition: 0.3s; }
        .btn-main { background: var(--mariposa-hot); color: white; }
        .btn-wipe { background: transparent; color: #ff4757; border: 1px solid #ff4757; margin-top: 15px; font-size: 11px; }
        .btn-wipe:hover { background: #ff4757; color: white; }

        .delete-item-btn { 
            position: absolute; top: 15px; right: 15px; 
            background: transparent; color: #666; border: 1px solid #333; 
            padding: 5px 8px; border-radius: 5px; cursor: pointer; font-size: 10px;
        }
        .delete-item-btn:hover { color: var(--critical); border-color: var(--critical); }

        .tactical-hub { background: #000; border: 1px solid var(--mariposa-pink); border-radius: 10px; padding: 15px; margin-top: 15px; }
        .hub-label { font-size: 10px; color: var(--mariposa-pink); font-weight: 900; text-transform: uppercase; margin-bottom: 8px; display: block; }
        
        .response-box { color: #ddd; font-size: 13px; line-height: 1.5; border-bottom: 1px solid #222; padding-bottom: 10px; margin-bottom: 10px; }
        .manager-box { background: rgba(214, 51, 132, 0.1); border-left: 3px solid var(--mariposa-pink); padding: 10px; font-size: 12px; color: #ffc2d1; }

        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
        th { text-align: left; padding: 8px; background: #222; color: var(--mariposa-pink); }
        td { padding: 8px; border-bottom: 1px solid #333; }

        #sentimentEmoji { font-size: 35px; margin-right: 10px; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div style="font-family:'Playfair Display'; font-weight:900; color:var(--mariposa-pink);">üå∫ MARIPOSA v14</div>
        <button class="btn" style="width:auto; margin:0; background:var(--pos); font-size:12px; color:black;" onclick="exportToExcel()">üì• Export Report</button>
    </nav>

    <div class="container">
        <div class="dashboard-grid">
            <div class="sidebar">
                <div class="card">
                    <h3 style="margin:0 0 10px 0; color:var(--mariposa-pink);">Analysis Intake</h3>
                    <textarea id="reviewInput" placeholder="Paste reviews here..."></textarea>
                    <button class="btn btn-main" onclick="processAnalysis()">‚ö° ANALYZE REVIEW</button>
                    <button class="btn btn-wipe" onclick="clearDB()">üóëÔ∏è WIPE ALL HISTORY</button>
                </div>
                <div class="card" style="margin-top:20px;">
                    <h4 style="margin:0; color:var(--mariposa-pink);">Sentiment Trend</h4>
                    <div style="height:180px;"><canvas id="lineChart"></canvas></div>
                </div>
            </div>

            <div class="main-content">
                <div class="card">
                    <div style="display:flex; align-items:center;">
                        <span id="sentimentEmoji">üôÇ</span>
                        <h3 style="margin:0; color:var(--mariposa-pink);">Resolution Hub</h3>
                    </div>
                    <table id="insightTable">
                        <thead><tr><th>Category</th><th>Count</th><th>Seller Strategy</th></tr></thead>
                        <tbody id="insightBody"></tbody>
                    </table>
                </div>

                <div id="historyList"></div>
            </div>
        </div>
    </div>

<script>
    let db = JSON.parse(localStorage.getItem('mariposa_v14')) || [];

    const lexicon = {
        positive: ['ganda', 'galing', 'hiyang', 'glow', 'effective', 'legit', 'orig', 'kinis', 'smooth', 'mabait', 'dasurb', 'slay', 'bet', 'budol', 'sulit', 'fast', 'secure', 'satisfied'],
        negative: ['hapdi', 'kirot', 'pimple', 'tigyawat', 'butlig', 'fake', 'peke', 'scam', 'sayang', 'mahal', 'bad', 'worst', 'nagsisi', 'sunog', 'irritation', 'dry', 'leaking', 'bawas', 'tampered', 'rude', 'suplado', 'attitude', 'overrated', 'mid', 'rash', 'itchy', 'late', 'failed', 'misplaced', 'charges'],
        themes: [
            { id: 'clinical', label: 'Skin Reaction', keywords: ['hapdi', 'kirot', 'pimple', 'butlig', 'rash', 'itchy', 'sunog'], action: 'Stop use immediately. Request skin photos. Verify if user is pregnant/using retinol.' },
            { id: 'quality', label: 'Product Issue', keywords: ['fake', 'peke', 'scam', 'leaking', 'bawas', 'watery', 'oxidized', 'expired'], action: 'Check batch manufacturing date. Offer refund or warehouse replacement.' },
            { id: 'logistics', label: 'Logistics', keywords: ['rider', 'tagal', 'suplado', 'bastos', 'delivery', 'late', 'charges', 'failed'], action: 'File dispute with Courier (J&T/Flash). Re-verify shipping address.' }
        ]
    };

    function processAnalysis() {
        const text = document.getElementById('reviewInput').value.trim();
        if(!text) return;

        const words = text.toLowerCase().split(/\W+/);
        let posCount = words.filter(w => lexicon.positive.includes(w)).length;
        let negCount = words.filter(w => lexicon.negative.includes(w)).length;
        
        if(text.toLowerCase().includes("ganda")) posCount += 2;

        let score = (posCount - negCount) / (words.length / 5 + 1);
        score = Math.max(-1, Math.min(1, score));

        let sentiment = score > 0.1 ? "Positive" : (score < -0.1 ? "Negative" : "Neutral");
        let foundThemes = lexicon.themes.filter(t => t.keywords.some(k => text.toLowerCase().includes(k)));

        const entry = {
            id: Date.now(),
            text: text,
            sentiment: sentiment,
            score: score,
            themes: foundThemes.map(t => t.label),
            tacticalReply: generateTacticalReply(text, sentiment, foundThemes),
            managerAction: foundThemes.length > 0 ? foundThemes[0].action : "Monitor for customer follow-up.",
            timestamp: new Date().toLocaleString()
        };

        db.push(entry);
        saveAndRefresh();
        document.getElementById('reviewInput').value = "";
    }

    function generateTacticalReply(text, sentiment, themes) {
        if(sentiment === "Positive") return "Maraming salamat sa tiwala! üå∏ We're so happy na hiyang ka sa product. Stay glowing! ‚ú®";
        let reply = "Pasensya na po sa naging experience niyo. ";
        if(themes.some(t => t.id === 'clinical')) reply += "Safety niyo po ang priority namin. Paki-stop po muna ang pag-gamit at i-message kami sa DM para matulungan namin kayo sa refund.";
        else if(themes.some(t => t.id === 'logistics')) reply += "Iimbestigahan po namin ang rider na ito sa hub nila. Hindi po namin pinapayagan ang ganitong klaseng service.";
        else reply += "Gusto po namin itong ayusin. Paki-send po ang Order ID niyo sa amin via private message.";
        return reply;
    }

    function deleteItem(id) {
        if(confirm("Delete this specific sentiment?")) {
            db = db.filter(item => item.id !== id);
            saveAndRefresh();
        }
    }

    function saveAndRefresh() {
        localStorage.setItem('mariposa_v14', JSON.stringify(db));
        updateDashboard();
    }

    function updateDashboard() {
        const pos = db.filter(i => i.sentiment === 'Positive').length;
        const neg = db.filter(i => i.sentiment === 'Negative').length;
        document.getElementById('sentimentEmoji').innerText = pos > neg ? "üòç" : (neg > pos ? "üòî" : "üôÇ");

        const classifier = {};
        db.forEach(entry => entry.themes.forEach(t => classifier[t] = (classifier[t] || 0) + 1));
        document.getElementById('insightBody').innerHTML = Object.keys(classifier).map(key => `
            <tr><td><b>${key}</b></td><td align="center">${classifier[key]}</td><td>${lexicon.themes.find(t => t.label === key).action}</td></tr>
        `).join('');

        render();
        updateCharts();
    }

    function render() {
        document.getElementById('historyList').innerHTML = db.slice().reverse().map(i => `
            <div class="card" style="margin-top:15px; background:#111;">
                <button class="delete-item-btn" onclick="deleteItem(${i.id})">üóëÔ∏è Delete</button>
                <div style="display:flex; justify-content:space-between; padding-right: 60px;">
                    <span style="font-size:10px; color:var(--mariposa-pink); font-weight:900;">${i.sentiment}</span>
                    <small style="color:#555;">${i.timestamp}</small>
                </div>
                <p style="font-size:14px; margin:10px 0;">"${i.text}"</p>
                
                <div class="tactical-hub">
                    <span class="hub-label">Suggested Tactical Response</span>
                    <div class="response-box">${i.tacticalReply}</div>
                    
                    <span class="hub-label">Managerial/Seller Action</span>
                    <div class="manager-box">üõ†Ô∏è ${i.managerAction}</div>
                </div>
            </div>
        `).join('');
    }

    let lineChart;
    function updateCharts() {
        const ctx = document.getElementById('lineChart').getContext('2d');
        if(lineChart) lineChart.destroy();
        const last10 = db.slice(-10);
        lineChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: last10.map(i => i.timestamp),
                datasets: [{
                    data: last10.map(i => i.score),
                    borderColor: '#ff85a2', tension: 0.4, fill: false
                }]
            },
            options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    function clearDB() { if(confirm("Permanent Wipe: Are you sure you want to delete ALL data?")) { localStorage.removeItem('mariposa_v14'); db=[]; location.reload(); } }
    function exportToExcel() {
        const ws = XLSX.utils.json_to_sheet(db);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Sentiment_Report");
        XLSX.writeFile(wb, "Mariposa_v14_Full.xlsx");
    }
    updateDashboard();
</script>
</body>
</html>

