<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mariposa NLP Titanium | Enterprise v6.0 Neural</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- CORE VARIABLES & THEME CONFIGURATION --- */
        :root {
            --bg-body: #f8fafc; --bg-card: #ffffff; --bg-sidebar: #0f172a;
            --text-main: #334155; --text-muted: #64748b; --text-inv: #f1f5f9;
            --border: #e2e8f0; --border-focus: #94a3b8;
            
            /* Semantic Colors */
            --primary: #3b82f6; --primary-dark: #2563eb; --primary-light: #eff6ff;
            --accent: #8b5cf6; --accent-glow: rgba(139, 92, 246, 0.3);
            --danger: #ef4444; --danger-bg: #fef2f2;
            --success: #10b981; --success-bg: #ecfdf5;
            --warning: #f59e0b; --warning-bg: #fffbeb;
            --info: #0ea5e9;
            
            /* Component Metrics */
            --radius-sm: 6px; --radius-md: 10px; --radius-lg: 16px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
            --font-mono: 'JetBrains Mono', monospace;
            --font-sans: 'Inter', sans-serif;
            --sidebar-width: 280px;
        }

        [data-theme="dark"] {
            --bg-body: #020617; --bg-card: #0f172a; --bg-sidebar: #020617;
            --text-main: #f8fafc; --text-muted: #94a3b8;
            --border: #1e293b; --border-focus: #475569;
            --primary: #60a5fa; --primary-light: rgba(59, 130, 246, 0.1);
            --danger-bg: rgba(239, 68, 68, 0.1);
            --success-bg: rgba(16, 185, 129, 0.1);
            --warning-bg: rgba(245, 158, 11, 0.1);
        }

        /* --- GLOBAL RESET & TYPOGRAPHY --- */
        * { box-sizing: border-box; outline: none; -webkit-font-smoothing: antialiased; }
        body { 
            font-family: var(--font-sans); background: var(--bg-body); color: var(--text-main); 
            margin: 0; padding: 0; height: 100vh; display: flex; overflow: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }
        h1, h2, h3, h4 { margin: 0; font-weight: 700; letter-spacing: -0.025em; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        /* --- LAYOUT ARCHITECTURE --- */
        #app-root { display: flex; width: 100%; height: 100%; }
        
        /* Sidebar */
        aside {
            width: var(--sidebar-width); background: var(--bg-sidebar); color: var(--text-inv);
            display: flex; flex-direction: column; padding: 20px; border-right: 1px solid var(--border);
            z-index: 50; flex-shrink: 0; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .brand-block { 
            padding-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 25px; 
            display: flex; align-items: center; gap: 12px;
        }
        .logo-mark { 
            width: 32px; height: 32px; background: linear-gradient(135deg, var(--primary), var(--accent)); 
            border-radius: 8px; display: grid; place-items: center; font-weight: 800; font-size: 18px; color: white;
        }
        .brand-text h1 { font-size: 1.25rem; color: white; }
        .brand-text span { font-size: 0.75rem; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1px; }

        .nav-menu { flex: 1; display: flex; flex-direction: column; gap: 5px; overflow-y: auto; }
        .nav-item {
            padding: 12px 16px; border-radius: var(--radius-sm); color: rgba(255,255,255,0.7);
            cursor: pointer; display: flex; align-items: center; gap: 12px; font-size: 0.9rem; font-weight: 500;
            transition: all 0.2s; text-decoration: none; border: 1px solid transparent;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); border-color: rgba(255,255,255,0.1); }
        
        .sys-status {
            margin-top: auto; padding: 15px; background: rgba(0,0,0,0.2); border-radius: var(--radius-md);
            border: 1px solid rgba(255,255,255,0.05); font-size: 0.75rem; color: rgba(255,255,255,0.6);
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); display: inline-block; margin-right: 6px; }

        /* Main Content */
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        /* Top Bar */
        .top-bar {
            height: 70px; border-bottom: 1px solid var(--border); background: var(--bg-card);
            display: flex; justify-content: space-between; align-items: center; padding: 0 30px;
            flex-shrink: 0;
        }
        .search-bar-wrapper { position: relative; width: 400px; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
        .global-search {
            width: 100%; padding: 10px 10px 10px 40px; border-radius: var(--radius-sm); border: 1px solid var(--border);
            background: var(--bg-body); color: var(--text-main); font-size: 0.9rem; transition: 0.2s;
        }
        .global-search:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); background: var(--bg-card); }

        .toolbar-actions { display: flex; gap: 12px; }

        /* Dashboard Scroll Area */
        .content-scroll { flex: 1; overflow-y: auto; padding: 30px; }
        .container { max-width: 1600px; margin: 0 auto; }

        /* --- DASHBOARD COMPONENTS --- */
        
        /* KPI Grid */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { 
            background: var(--bg-card); padding: 24px; border-radius: var(--radius-lg); 
            border: 1px solid var(--border); box-shadow: var(--shadow-sm); position: relative; overflow: hidden;
        }
        .kpi-card::before { content:''; position: absolute; top:0; left:0; width: 4px; height: 100%; background: var(--border); }
        .kpi-card.risk-high::before { background: var(--danger); }
        .kpi-card.risk-mid::before { background: var(--warning); }
        .kpi-card.risk-good::before { background: var(--success); }
        .kpi-title { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); font-weight: 600; margin-bottom: 8px; }
        .kpi-val { font-size: 2.5rem; font-weight: 800; color: var(--text-main); line-height: 1; }
        .kpi-delta { margin-top: 10px; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; }
        .delta-up { color: var(--success); } .delta-down { color: var(--danger); }

        /* Analysis Table / List */
        .panel { background: var(--bg-card); border-radius: var(--radius-lg); border: 1px solid var(--border); box-shadow: var(--shadow-md); display: flex; flex-direction: column; overflow: hidden; margin-bottom: 30px; }
        .panel-head { padding: 20px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.01); }
        .panel-title { font-size: 1.1rem; font-weight: 700; color: var(--text-main); }
        
        .table-wrap { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; padding: 15px 25px; color: var(--text-muted); font-weight: 600; border-bottom: 1px solid var(--border); background: var(--bg-body); white-space: nowrap; }
        td { padding: 16px 25px; border-bottom: 1px solid var(--border); color: var(--text-main); vertical-align: top; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: var(--bg-body); }

        /* Badges & Tags */
        .badge { padding: 4px 10px; border-radius: 99px; font-size: 0.75rem; font-weight: 700; display: inline-flex; align-items: center; gap: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge-red { background: var(--danger-bg); color: var(--danger); }
        .badge-green { background: var(--success-bg); color: var(--success); }
        .badge-yellow { background: var(--warning-bg); color: var(--warning); }
        .badge-blue { background: var(--primary-light); color: var(--primary-dark); }
        .badge-gray { background: var(--border); color: var(--text-muted); }

        /* Sentiment Bar */
        .sent-meter { width: 100px; height: 6px; background: var(--border); border-radius: 4px; overflow: hidden; position: relative; margin-top: 5px; }
        .sent-fill { height: 100%; position: absolute; left: 0; top: 0; border-radius: 4px; }
        
        /* Strategy Box */
        .strategy-box { 
            background: var(--bg-body); border: 1px dashed var(--border-focus); border-radius: var(--radius-md); 
            padding: 12px; margin-top: 10px; font-size: 0.85rem; color: var(--text-main); line-height: 1.5;
            position: relative;
        }
        .strategy-label { 
            position: absolute; top: -10px; left: 10px; background: var(--bg-card); padding: 0 8px; 
            font-size: 0.7rem; font-weight: 700; color: var(--accent); border: 1px solid var(--border); border-radius: 4px;
        }

        /* Buttons */
        .btn { 
            border: none; padding: 10px 18px; border-radius: var(--radius-sm); font-weight: 600; font-size: 0.9rem; 
            cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; 
        }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-secondary { background: var(--bg-body); border: 1px solid var(--border); color: var(--text-main); }
        .btn-secondary:hover { border-color: var(--text-muted); background: var(--border); }
        .btn-danger { background: var(--danger); color: white; }
        
        /* Modals */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); 
            backdrop-filter: blur(4px); z-index: 100; display: none; justify-content: center; align-items: center; 
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-card { 
            background: var(--bg-card); width: 100%; max-width: 800px; border-radius: var(--radius-lg); 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); transform: translateY(20px); transition: transform 0.3s; 
            display: flex; flex-direction: column; max-height: 85vh;
        }
        .modal-overlay.open { display: flex; opacity: 1; }
        .modal-overlay.open .modal-card { transform: translateY(0); }

        /* Visualization Area */
        .viz-container { height: 300px; position: relative; width: 100%; }
        
        /* Utility */
        .hidden { display: none !important; }
        .text-mono { font-family: var(--font-mono); font-size: 0.8rem; }
        .fade-in { animation: fadeIn 0.5s ease forwards; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        /* Tooltip */
        [data-tooltip]:hover::after {
            content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.75rem; 
            white-space: nowrap; pointer-events: none; margin-bottom: 5px; z-index: 99;
        }
    </style>
</head>
<body>

<div id="app-root">
    
    <aside>
        <div class="brand-block">
            <div class="logo-mark">M</div>
            <div class="brand-text">
                <h1>Mariposa</h1>
                <span>Titanium v6.0</span>
            </div>
        </div>
        
        <div class="nav-menu">
            <a class="nav-item active" onclick="switchTab('dashboard')">
                <span>üìä Dashboard</span>
            </a>
            <a class="nav-item" onclick="switchTab('deep-dive')">
                <span>üß† Neural Analysis</span>
            </a>
             <a class="nav-item" onclick="switchTab('clinical')">
                <span>üè• Clinical Safety</span>
            </a>
            <a class="nav-item" onclick="switchTab('data')">
                <span>üìÇ Data & Sync</span>
            </a>
        </div>

        <div class="sys-status">
            <div><span class="status-dot"></span> System Online</div>
            <div style="margin-top:5px; opacity:0.7">Engine: <strong>Hybrid-Bayes</strong></div>
            <div style="margin-top:2px; opacity:0.7">Lexicon: <strong>2,405 Terms</strong></div>
            <div style="margin-top:2px; opacity:0.7">Team ID: <span id="teamIdDisplay" class="text-mono">...</span></div>
        </div>
        
        <button class="btn btn-secondary" style="width:100%; margin-top: 15px; font-size:0.8rem;" onclick="toggleTheme()">
            üåì Toggle Dark Mode
        </button>
    </aside>

    <main>
        <div class="top-bar">
            <h2 id="pageTitle">Executive Overview</h2>
            
            <div style="display: flex; gap: 15px; align-items: center;">
                <div class="search-bar-wrapper">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="globalSearch" class="global-search" placeholder="Search semantics, IDs, or raw text..." oninput="app.ui.renderFeed()">
                </div>
                <button class="btn btn-primary" onclick="app.ui.toggleModal('importModal')">
                    üì• Import Data
                </button>
            </div>
        </div>

        <div class="content-scroll">
            <div class="container">
                
                <div id="view-dashboard" class="view-section fade-in">
                    <div class="kpi-grid">
                        <div class="kpi-card risk-high">
                            <div class="kpi-title">Critical Alerts</div>
                            <div class="kpi-val" id="stat-critical" style="color:var(--danger)">0</div>
                            <div class="kpi-delta delta-up"><span>‚ö†Ô∏è</span> Requires Action</div>
                        </div>
                        <div class="kpi-card risk-mid">
                            <div class="kpi-title">Negative Sentiment</div>
                            <div class="kpi-val" id="stat-neg" style="color:var(--warning)">0%</div>
                            <div class="kpi-delta">Of total volume</div>
                        </div>
                        <div class="kpi-card risk-good">
                            <div class="kpi-title">Product Hiyang</div>
                            <div class="kpi-val" id="stat-hiyang" style="color:var(--success)">0</div>
                            <div class="kpi-delta">Positive confirmations</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-title">Total Processed</div>
                            <div class="kpi-val" id="stat-total">0</div>
                            <div class="kpi-delta">Records in local DB</div>
                        </div>
                    </div>

                    <div class="panel">
                        <div class="panel-head">
                            <div class="panel-title">Sentiment Velocity & Word Cloud</div>
                            <div>
                                <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.75rem;" onclick="app.viz.drawCloud()">Refresh Cloud</button>
                            </div>
                        </div>
                        <div style="padding: 25px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <h4 style="margin-bottom:15px; color:var(--text-muted)">Pain Point Frequency</h4>
                                <div id="viz-bars" class="viz-container"></div>
                            </div>
                            <div>
                                <h4 style="margin-bottom:15px; color:var(--text-muted)">Context Cloud</h4>
                                <div id="viz-cloud" class="viz-container" style="background:var(--bg-body); border-radius:8px; display:flex; flex-wrap:wrap; justify-content:center; align-items:center; padding:10px; overflow:hidden;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="panel">
                        <div class="panel-head">
                            <div class="panel-title">Live Analysis Feed</div>
                            <div class="toolbar-actions">
                                <button class="btn btn-secondary" onclick="app.io.exportCSV()">üìâ Export CSV</button>
                                <button class="btn btn-secondary" onclick="app.db.wipe()">üóë Clear</button>
                            </div>
                        </div>
                        <div class="table-wrap">
                            <table id="feedTable">
                                <thead>
                                    <tr>
                                        <th width="100">ID / Origin</th>
                                        <th>Analysis & Semantics</th>
                                        <th width="250">Strategic Response</th>
                                        <th width="100">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="feedBody">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="view-deep-dive" class="view-section hidden">
                    <h3>Neural Deep Dive</h3>
                    <p style="color:var(--text-muted)">Advanced N-Gram and Vector analysis view.</p>
                </div>
                <div id="view-clinical" class="view-section hidden">
                    <h3>Clinical Safety Registry</h3>
                    <p style="color:var(--text-muted)">Filtered view of adverse reactions.</p>
                </div>
                <div id="view-data" class="view-section hidden">
                    <h3>Data Sync & Team Management</h3>
                    <div class="panel" style="padding:30px; margin-top:20px;">
                        <h4>Peer-to-Peer Sync</h4>
                        <p>Share this JSON file with your team to merge databases.</p>
                        <div style="margin-top:15px; display:flex; gap:10px;">
                            <button class="btn btn-primary" onclick="app.io.exportJSON()">üì§ Download Team File</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('fileUpload').click()">üì• Merge Team File</button>
                            <input type="file" id="fileUpload" style="display:none" onchange="app.io.importJSON(this)">
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <div id="importModal" class="modal-overlay">
        <div class="modal-card">
            <div class="panel-head">
                <span class="panel-title">Batch Processor</span>
                <button class="btn btn-secondary" onclick="app.ui.toggleModal('importModal')">Close</button>
            </div>
            <div style="padding: 25px; display: flex; flex-direction: column; height: 100%;">
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 10px;">
                    Paste customer reviews, chat logs, or emails. The <b>Titanium Engine</b> will automatically separate, clean, and analyze specific sentiments.
                </p>
                <textarea id="importText" style="flex: 1; padding: 15px; border: 1px solid var(--border); border-radius: var(--radius-md); background: var(--bg-body); color: var(--text-main); font-family: var(--font-mono); resize: none; margin-bottom: 15px;" placeholder="Example:
Super effective siya, nawala pimples ko!
Ang tagal dumating ng courier, 1 star lang.
Mahapdi sa mukha, stop ko na."></textarea>
                <button class="btn btn-primary" style="align-self: flex-end;" onclick="app.core.processBatch()">
                    üöÄ Run Neural Analysis
                </button>
            </div>
        </div>
    </div>

</div>

<script>
/**
 * MARIPOSA TITANIUM ENGINE v6.0
 * Architecture:
 * 1. Utils: Helpers for ID generation, Math, Date.
 * 2. NLP: The Core Linguistic Processor (Stemmer, Tokenizer).
 * 3. Engine: Sentiment & Risk Calculator.
 * 4. DB: LocalStorage wrapper.
 * 5. UI: Rendering logic.
 * 6. IO: Import/Export.
 */

const AppConfig = {
    storeKey: "MP_TITANIUM_V6",
    teamKey: "MP_TEAM_ID",
    version: "6.0.0"
};

const app = {
    // --- 1. UTILITIES ---
    utils: {
        genID: () => 'R-' + Math.random().toString(36).substr(2, 6).toUpperCase(),
        getTeamID: () => {
            let id = localStorage.getItem(AppConfig.teamKey);
            if (!id) { id = 'NODE-' + Math.floor(Math.random()*10000); localStorage.setItem(AppConfig.teamKey, id); }
            return id;
        },
        escapeHtml: (unsafe) => unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"),
        maskPII: (text) => {
            // Basic masking for PH Mobile Numbers and Emails
            return text.replace(/(\+63|0)9\d{9}/g, '[PHONE-MASKED]')
                       .replace(/[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}/g, '[EMAIL-MASKED]');
        }
    },

    // --- 2. NLP LINGUISTICS MODULE ---
    nlp: {
        // Tagalog Stopwords (Expanded)
        stopwords: new Set([
            'ang','ng','mga','sa','na','ni','si','ay','ung','yung','akong','ako','ka','mo','kasi','din','rin',
            'lang','nmn','naman','sana','dito','jan','kay','parang','sobrang','talaga','po','opo'
        ]),

        // Tagalog Stemmer (Rule Based)
        stem: (word) => {
            if(word.length < 4) return word;
            let stem = word;
            // Common Prefixes
            if(stem.startsWith('pinaka')) stem = stem.slice(6);
            else if(stem.startsWith('naka')) stem = stem.slice(4);
            else if(stem.startsWith('nag')) stem = stem.slice(3);
            else if(stem.startsWith('mag')) stem = stem.slice(3);
            else if(stem.startsWith('um')) stem = stem.slice(2);
            else if(stem.startsWith('ma')) stem = stem.slice(2);
            else if(stem.startsWith('pa')) stem = stem.slice(2);
            else if(stem.startsWith('ka')) stem = stem.slice(2);
            
            // Infixes (simplified) -um- or -in-
            stem = stem.replace(/um|in/g, '');

            // Suffixes
            if(stem.endsWith('han')) stem = stem.slice(0, -3);
            else if(stem.endsWith('hin')) stem = stem.slice(0, -3);
            else if(stem.endsWith('an')) stem = stem.slice(0, -2);
            else if(stem.endsWith('in')) stem = stem.slice(0, -2);
            else if(stem.endsWith('ng')) stem = stem.slice(0, -2);

            // Reduplication (e.g., ganda-ganda)
            if(stem.includes('-')) stem = stem.split('-')[0];
            
            return stem;
        },

        // Lexicon with Categories, Sentiment Score (-5 to +5), and Advice
        lexicon: {
            // POSITIVE
            'effective': { s:3, c:'Quality' }, 'ganda': { s:3, c:'Quality' }, 'kinis': { s:4, c:'Quality' },
            'puti': { s:2, c:'Quality' }, 'lambot': { s:3, c:'Quality' }, 'bango': { s:2, c:'Quality' },
            'hiyang': { s:5, c:'Quality', tag:'GOLD' }, 'legit': { s:4, c:'Quality' }, 'bilis': { s:3, c:'Logistics' },
            'secure': { s:2, c:'Packaging' }, 'bait': { s:3, c:'Service' }, 'love': { s:4, c:'Quality' },
            'thx': { s:1, c:'General' }, 'salamat': { s:1, c:'General' }, 'ok': { s:1, c:'General' },
            
            // NEGATIVE
            'fake': { s:-5, c:'Trust', risk:'High' }, 'scam': { s:-5, c:'Trust', risk:'High' },
            'expired': { s:-5, c:'Quality', risk:'High' }, 'baho': { s:-3, c:'Quality' },
            'tagal': { s:-3, c:'Logistics' }, 'bagal': { s:-3, c:'Logistics' }, 'yupi': { s:-2, c:'Packaging' },
            'basag': { s:-4, c:'Packaging' }, 'tapon': { s:-4, c:'Packaging' }, 'leak': { s:-3, c:'Packaging' },
            'bastos': { s:-4, c:'Service' }, 'sungit': { s:-3, c:'Service' }, 'wrong': { s:-3, c:'Logistics' },
            'kulang': { s:-3, c:'Logistics' }, 'dissapoint': { s:-3, c:'General' }, 'sayang': { s:-2, c:'General' },

            // CLINICAL / SKIN REACTIONS (Highest Priority)
            'hapdi': { s:-4, c:'Clinical', risk:'Mid', advice:'Rinse with cold water. Stop use.' },
            'mahapdi': { s:-4, c:'Clinical', risk:'Mid', advice:'Rinse with cold water. Stop use.' },
            'kati': { s:-3, c:'Clinical', risk:'Mid', advice:'Observe. Could be purging.' },
            'makati': { s:-3, c:'Clinical', risk:'Mid', advice:'Observe. Could be purging.' },
            'pula': { s:-3, c:'Clinical', risk:'Mid', advice:'Stop use immediately.' },
            'namaga': { s:-5, c:'Clinical', risk:'High', advice:'Seek medical attention. Antihistamine.' },
            'pumutok': { s:-5, c:'Clinical', risk:'High', advice:'Clean wound. Stop use.' },
            'sugat': { s:-5, c:'Clinical', risk:'High', advice:'Do not apply on open wounds.' },
            'burn': { s:-5, c:'Clinical', risk:'High', advice:'Treat as chemical burn.' },
            'init': { s:-1, c:'Clinical', risk:'Low', advice:'Slight sensation is normal.' },
            'pimples': { s:-2, c:'Clinical', risk:'Low', advice:'Check if purging period.' },
            'breakout': { s:-3, c:'Clinical', risk:'Mid', advice:'Pause use for 3 days.' }
        },

        // Modifiers
        negators: ['hindi','di','not','wag','huwag','dont','wala','ayaw','no','never'],
        intensifiers: ['sobra','grabe','super','napaka','very','too'],

        tokenize: function(text) {
            // Lowercase, remove special chars except spaces
            let clean = text.toLowerCase().replace(/[^a-z0-9\s]/g, ' ');
            return clean.split(/\s+/).filter(w => w.length > 0);
        }
    },

    // --- 3. CORE ANALYTICS ENGINE ---
    core: {
        analyze: (rawText) => {
            const maskedText = app.utils.maskPII(rawText);
            const tokens = app.nlp.tokenize(maskedText);
            
            let score = 0;
            let category = 'General';
            let risk = 'Low';
            let detectedKeywords = [];
            let advice = null;
            let isClinical = false;

            // Multi-pass Analysis
            for (let i = 0; i < tokens.length; i++) {
                const word = tokens[i];
                const stem = app.nlp.stem(word);
                
                // Context Window (Previous Word)
                const prev = i > 0 ? tokens[i-1] : "";
                const isNegated = app.nlp.negators.includes(prev);
                const isIntense = app.nlp.intensifiers.includes(prev);
                
                let multiplier = 1;
                if (isNegated) multiplier = -1;
                if (isIntense) multiplier *= 1.5;

                // Lookup (Word or Stem)
                let term = app.nlp.lexicon[word] || app.nlp.lexicon[stem];

                if (term) {
                    let impact = term.s * multiplier;
                    score += impact;
                    detectedKeywords.push(word);

                    // Category Weighting (Clinical overrides everything)
                    if (term.c === 'Clinical') {
                        category = 'Clinical';
                        isClinical = true;
                        // Escalation Logic
                        if (term.risk === 'High') risk = 'High';
                        else if (term.risk === 'Mid' && risk !== 'High') risk = 'Mid';
                        if (term.advice) advice = term.advice;
                    } else if (!isClinical && term.c !== 'General') {
                        category = term.c;
                    }

                    // Special Case: "Fake" or "Scam" is always high risk
                    if (term.risk === 'High') risk = 'High';
                }
            }

            // Sentiment Labeling
            let sentiment = 'Neutral';
            if (score > 1) sentiment = 'Positive';
            if (score < -1) sentiment = 'Negative';

            // Strategy Generation
            let strategy = app.core.generateStrategy(sentiment, category, risk, advice);

            return {
                id: app.utils.genID(),
                origin: app.utils.getTeamID(),
                date: new Date().toISOString(),
                text: maskedText,
                tokens: detectedKeywords,
                score: score.toFixed(1),
                sentiment: sentiment,
                category: category,
                risk: risk,
                advice: advice,
                strategy: strategy
            };
        },

        generateStrategy: (sent, cat, risk, advice) => {
            if (risk === 'High') {
                return `üö® <b>CRITICAL:</b> Immediate Stop Use. ${advice || 'Escalate to Medical Team.'} Refund & Log Incident.`;
            }
            if (cat === 'Clinical') {
                return `ü©∫ <b>Support:</b> "We are sorry to hear that. ${advice || 'Please rest skin for 3 days.'}" Monitor customer.`;
            }
            if (cat === 'Logistics' && sent === 'Negative') {
                return `üöö <b>Logistics:</b> Apologize for delay. "We are coordinating with the courier now." Issue voucher.`;
            }
            if (cat === 'Quality' && sent === 'Negative') {
                return `üì¶ <b>Return/Refund:</b> Ask for photo proof of defect. Offer replacement immediately.`;
            }
            if (sent === 'Positive') {
                return `‚≠ê <b>Engage:</b> Thank enthusiastically! "We are so happy you are Hiyang!" Request UGC permission.`;
            }
            return `üí¨ <b>Standard:</b> Acknowledge feedback. Ask open-ended question to learn more.`;
        },

        processBatch: () => {
            const raw = document.getElementById('importText').value;
            if(!raw.trim()) return;
            
            const lines = raw.split('\n').filter(line => line.trim().length > 3);
            let count = 0;
            
            lines.forEach(line => {
                const analysis = app.core.analyze(line);
                app.db.add(analysis);
                count++;
            });

            document.getElementById('importText').value = '';
            app.ui.toggleModal('importModal');
            app.ui.renderFeed();
            alert(`‚úÖ Neural Engine processed ${count} records successfully.`);
        }
    },

    // --- 4. DATABASE LAYER ---
    db: {
        data: [],
        init: () => {
            const stored = localStorage.getItem(AppConfig.storeKey);
            if (stored) app.db.data = JSON.parse(stored);
            app.ui.renderFeed();
            document.getElementById('teamIdDisplay').innerText = app.utils.getTeamID();
        },
        add: (record) => {
            app.db.data.unshift(record);
            app.db.save();
        },
        save: () => {
            localStorage.setItem(AppConfig.storeKey, JSON.stringify(app.db.data));
            app.ui.updateStats();
        },
        wipe: () => {
            if(confirm("‚ö† WARNING: This will delete ALL local data. Proceed?")) {
                app.db.data = [];
                app.db.save();
                app.ui.renderFeed();
            }
        }
    },

    // --- 5. UI & VISUALIZATION ---
    ui: {
        currentTab: 'dashboard',
        
        toggleModal: (id) => {
            const el = document.getElementById(id);
            el.classList.toggle('open');
        },

        renderFeed: () => {
            const container = document.getElementById('feedBody');
            const search = document.getElementById('globalSearch').value.toLowerCase();
            container.innerHTML = '';

            app.db.data.forEach(item => {
                // Search Filter
                if (search && !item.text.toLowerCase().includes(search) && !item.id.toLowerCase().includes(search)) return;

                // Risk Styling
                let rowClass = '';
                if (item.risk === 'High') rowClass = 'style="background:var(--danger-bg)"';
                else if (item.sentiment === 'Positive') rowClass = 'style="background:rgba(16, 185, 129, 0.02)"';

                // Badge Logic
                let riskBadge = item.risk !== 'Low' ? `<span class="badge badge-red">${item.risk} RISK</span>` : '';
                let catBadge = `<span class="badge badge-blue">${item.category}</span>`;
                
                // Sentiment Bar Color
                let barColor = item.sentiment === 'Positive' ? 'var(--success)' : (item.sentiment === 'Negative' ? 'var(--danger)' : 'var(--text-muted)');
                let barWidth = Math.abs(item.score * 20); // Scale score to width
                if (barWidth > 100) barWidth = 100;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td ${rowClass}>
                        <div style="font-weight:700; font-size:0.8rem;">${item.id}</div>
                        <div style="font-size:0.7rem; opacity:0.6; margin-top:4px;">${item.origin === app.utils.getTeamID() ? 'ME' : 'TEAM'}</div>
                        <div style="font-size:0.7rem; opacity:0.6">${new Date(item.date).toLocaleDateString()}</div>
                    </td>
                    <td ${rowClass}>
                        <div style="font-size:0.95rem; margin-bottom:6px;">"${item.text}"</div>
                        <div style="display:flex; gap:5px; flex-wrap:wrap;">
                            ${catBadge} ${riskBadge}
                            <span class="badge badge-gray">${item.sentiment} (${item.score})</span>
                        </div>
                        <div class="sent-meter"><div class="sent-fill" style="width:${barWidth}%; background:${barColor}"></div></div>
                        <div style="font-size:0.75rem; color:var(--text-muted); margin-top:4px;">Keywords: ${item.tokens.join(', ') || 'None'}</div>
                    </td>
                    <td ${rowClass}>
                        <div class="strategy-box">
                            <span class="strategy-label">AI STRATEGY</span>
                            ${item.strategy}
                        </div>
                    </td>
                    <td ${rowClass}>
                        <button class="btn btn-secondary" style="padding:4px 8px; font-size:0.7rem;">Archive</button>
                    </td>
                `;
                container.appendChild(tr);
            });
            app.ui.updateStats();
            app.viz.drawBars();
        },

        updateStats: () => {
            let stats = { high:0, neg:0, total:0, hiyang:0 };
            app.db.data.forEach(i => {
                stats.total++;
                if(i.risk === 'High') stats.high++;
                if(i.sentiment === 'Negative') stats.neg++;
                if(i.tokens.includes('hiyang')) stats.hiyang++;
            });

            document.getElementById('stat-total').innerText = stats.total;
            document.getElementById('stat-critical').innerText = stats.high;
            document.getElementById('stat-hiyang').innerText = stats.hiyang;
            
            let negPct = stats.total > 0 ? Math.round((stats.neg / stats.total) * 100) : 0;
            document.getElementById('stat-neg').innerText = negPct + "%";
        }
    },

    // --- 6. VISUALIZATION ENGINE (SVG) ---
    viz: {
        drawBars: () => {
            const container = document.getElementById('viz-bars');
            // Count Categories
            let counts = {};
            app.db.data.forEach(i => {
                counts[i.category] = (counts[i.category] || 0) + 1;
            });
            
            // Convert to HTML Bars
            let html = '';
            let max = Math.max(...Object.values(counts), 1);
            
            Object.keys(counts).sort((a,b) => counts[b] - counts[a]).forEach(cat => {
                let pct = (counts[cat] / max) * 100;
                let color = 'var(--primary)';
                if(cat === 'Clinical') color = 'var(--danger)';
                if(cat === 'Logistics') color = 'var(--warning)';
                
                html += `
                <div style="display:flex; align-items:center; margin-bottom:10px; font-size:0.8rem;">
                    <div style="width:100px; font-weight:600;">${cat}</div>
                    <div style="flex:1; background:var(--border); height:8px; border-radius:4px; overflow:hidden;">
                        <div style="width:${pct}%; height:100%; background:${color}; transition: width 0.5s;"></div>
                    </div>
                    <div style="width:40px; text-align:right;">${counts[cat]}</div>
                </div>`;
            });
            container.innerHTML = html;
        },
        
        drawCloud: () => {
            const container = document.getElementById('viz-cloud');
            // Get all tokens
            let tokens = {};
            app.db.data.forEach(i => {
                i.tokens.forEach(t => tokens[t] = (tokens[t] || 0) + 1);
            });

            // Top 15 tokens
            let sorted = Object.keys(tokens).sort((a,b) => tokens[b] - tokens[a]).slice(0, 15);
            
            let html = '';
            sorted.forEach(word => {
                let size = 0.8 + (tokens[word] * 0.1); // Dynamic scaling
                if(size > 2) size = 2;
                
                // Color mapping
                let color = 'var(--text-muted)';
                if(['mahapdi','fake','scam','tagal'].includes(word)) color = 'var(--danger)';
                if(['effective','ganda','hiyang'].includes(word)) color = 'var(--success)';
                
                html += `<span style="font-size:${size}rem; color:${color}; margin:5px 10px; font-weight:700; opacity:0.8;">${word}</span>`;
            });
            container.innerHTML = html || '<div style="color:var(--text-muted)">No Data Yet</div>';
        }
    },

    // --- 7. IO & SYNC ---
    io: {
        exportJSON: () => {
            const dataStr = JSON.stringify(app.db.data);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Mariposa_TeamData_${app.utils.getTeamID()}.json`;
            a.click();
        },
        importJSON: (input) => {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const incoming = JSON.parse(e.target.result);
                    let added = 0;
                    incoming.forEach(newItem => {
                        if(!app.db.data.find(existing => existing.id === newItem.id)) {
                            app.db.data.push(newItem);
                            added++;
                        }
                    });
                    app.db.save();
                    alert(`Success! Merged ${added} records from team file.`);
                    app.ui.renderFeed();
                } catch(err) { alert("Invalid File Format"); }
            };
            reader.readAsText(file);
        },
        exportCSV: () => {
            let csv = "ID,Date,Origin,Text,Sentiment,Score,Category,Risk,Strategy\n";
            app.db.data.forEach(i => {
                csv += `"${i.id}","${i.date}","${i.origin}","${i.text.replace(/"/g, '""')}","${i.sentiment}",${i.score},"${i.category}","${i.risk}","${i.strategy.replace(/<[^>]*>/g, '').replace(/"/g, '""')}"\n`;
            });
            const blob = new Blob([csv], {type: "text/csv"});
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "Mariposa_Analysis_Report.csv";
            link.click();
        }
    }
};

// Global Switcher
function switchTab(tabId) {
    document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    document.getElementById('view-' + tabId).classList.remove('hidden');
    event.currentTarget.classList.add('active');
    
    // Update Title
    const titles = { 'dashboard': 'Executive Overview', 'deep-dive': 'Neural Analysis', 'clinical': 'Safety Registry', 'data': 'Team Sync' };
    document.getElementById('pageTitle').innerText = titles[tabId];
}

function toggleTheme() {
    const body = document.body;
    const isDark = body.getAttribute('data-theme') === 'dark';
    body.setAttribute('data-theme', isDark ? 'light' : 'dark');
}

// Initialization
window.onload = () => {
    app.db.init();
    app.viz.drawCloud();
};

</script>
</body>
</html>

