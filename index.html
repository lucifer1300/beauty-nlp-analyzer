import uuid
import datetime
import pandas as pd
from typing import Optional, List
from fastapi import FastAPI, Depends, HTTPException, BackgroundTasks
from fastapi.responses import HTMLResponse, FileResponse
from fastapi.middleware.cors import CORSMiddleware
from sqlalchemy import create_engine, Column, Integer, String, Float, Text, Boolean, DateTime
from sqlalchemy.orm import sessionmaker, Session, declarative_base
from textblob import TextBlob # Basic NLP for demo (replace with HuggingFace for 100M dataset)
import io

# ==========================================
# üß† 1. CONFIGURATION & DATABASE SETUP
# ==========================================
# For GitHub portability, we default to SQLite. Change string for PostgreSQL.
DATABASE_URL = "sqlite:///./mariposa_v40.db" 
# DATABASE_URL = "postgresql://admin:password@mariposa-db:5432/mariposa_nlp"

engine = create_engine(DATABASE_URL, connect_args={"check_same_thread": False} if "sqlite" in DATABASE_URL else {})
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
Base = declarative_base()

# --- MODELS ---
class Workspace(Base):
    __tablename__ = "workspaces"
    server_id = Column(String, primary_key=True, index=True)
    created_at = Column(DateTime, default=datetime.datetime.utcnow)

class UserProfile(Base):
    __tablename__ = "profiles"
    id = Column(Integer, primary_key=True, index=True)
    server_id = Column(String, index=True)
    allergies = Column(String) # e.g., "Niacinamide, Alcohol"
    skin_type = Column(String) # e.g., "Rosacea, Oily"

class SentimentReview(Base):
    __tablename__ = "reviews"
    id = Column(Integer, primary_key=True, index=True)
    server_id = Column(String, index=True)
    original_text = Column(Text)
    translated_text = Column(Text)
    sentiment_score = Column(Float)
    sentiment_label = Column(String) # Positive, Neutral, Negative
    category = Column(String) # Skin, Logistics, Quality, Budol
    is_safety_alert = Column(Boolean, default=False) # The "Safety Shield"
    host_strategy = Column(Text) # The actionable growth strategy
    voucher_code = Column(String, nullable=True)
    timestamp = Column(DateTime, default=datetime.datetime.utcnow)

Base.metadata.create_all(bind=engine)

# ==========================================
# üß† 2. THE INTELLIGENCE ENGINE (RAG & ONTOLOGY)
# ==========================================

# MOCK "100 MILLION" DATASET LOADERS
# In a real GitHub production env, these would connect to VectorDB (Pinecone/Chroma)
TAGLISH_DICT = {
    "hapdi": "stinging", "nangatol": "itchy", "namula": "redness",
    "hulas": "melted_makeup", "budol": "impulse_buy", "tagal": "slow_shipping",
    "basag": "broken", "peke": "fake", "bango": "fragrant", "gasgas": "scratched"
}

MEDICAL_ONTOLOGY = {
    "stinging": {"risk": "High", "advice": "Stop use immediately. Possible compromised moisture barrier."},
    "itchy": {"risk": "High", "advice": "Potential allergic contact dermatitis. Rinse with cool water."},
    "redness": {"risk": "Medium", "advice": "Signs of inflammation or Rosacea trigger."},
    "fake": {"risk": "Legal", "advice": "Verify Batch ID and QR Code against FDA database."}
}

STRATEGY_MATRIX = {
    "Skin": "CLINICAL TRIAGE: Validate biological reaction. Offer dermatological guidance + soothing sample.",
    "Logistics": "TRANSPARENT FRICTION: Research shows transparency beats speed. Provide real-time location + Shipping Rebate.",
    "Quality": "REPLACEMENT CERTAINTY: 1-to-1 replacement is 2.5x more likely to retain customers than a refund.",
    "Budol": "VALIDATION LOOP: Affirm their choice and suggest a complementary product (Cross-sell)."
}

def translate_to_english(text: str) -> str:
    """Simulates 100M+ Taglish translation engine."""
    words = text.lower().split()
    translated = [TAGLISH_DICT.get(w, w) for w in words]
    return " ".join(translated)

def analyze_safety(text: str) -> bool:
    """The Safety Shield Logic."""
    triggers = ["stinging", "itchy", "redness", "burn", "pain", "doctor"]
    return any(t in text for t in triggers)

def get_strategy(category: str, sentiment: float) -> str:
    if sentiment < -0.1:
        return STRATEGY_MATRIX.get(category, "EMPATHIC PIVOT: Acknowledge friction.")
    return "GROWTH AMPLIFICATION: Encourage UGC (User Generated Content) and referral."

# ==========================================
# üß† 3. API ENDPOINTS
# ==========================================
app = FastAPI(title="MARIPOSA SKINCARE NLP v40")

# CORS for frontend access
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"],
)

def get_db():
    db = SessionLocal()
    try: yield db
    finally: db.close()

@app.post("/api/workspace")
def create_workspace(db: Session = Depends(get_db)):
    # Generate Server ID
    new_id = str(uuid.uuid4())[:8].upper()
    db.add(Workspace(server_id=new_id))
    db.commit()
    return {"server_id": new_id, "status": "Active"}

@app.post("/api/analyze/{server_id}")
def analyze_sentiment(server_id: str, text: str, db: Session = Depends(get_db)):
    # 1. Translation Layer
    english_text = translate_to_english(text)
    
    # 2. Sentiment Engine (TextBlob for demo)
    blob = TextBlob(english_text)
    score = blob.sentiment.polarity
    
    # 3. Categorization & Safety Shield
    is_safety = analyze_safety(english_text)
    
    category = "General"
    if any(x in english_text for x in ["ship", "deliver", "rider", "courier"]): category = "Logistics"
    elif any(x in english_text for x in ["skin", "face", "pimple", "itchy", "sting"]): category = "Skin"
    elif any(x in english_text for x in ["fake", "broken", "seal", "leak"]): category = "Quality"
    elif "impulse_buy" in english_text: category = "Budol"

    # 4. Host Strategy Generation
    strategy = get_strategy(category, score)
    
    # 5. Voucher Logic
    voucher = None
    if score < -0.2: voucher = f"MARIPOSA-{str(uuid.uuid4())[:4].upper()}"

    # 6. Save to DB
    label = "Positive" if score > 0.1 else "Negative" if score < -0.1 else "Neutral"
    
    review = SentimentReview(
        server_id=server_id,
        original_text=text,
        translated_text=english_text,
        sentiment_score=score,
        sentiment_label=label,
        category=category,
        is_safety_alert=is_safety,
        host_strategy=strategy,
        voucher_code=voucher
    )
    db.add(review)
    db.commit()
    
    return {
        "score": score,
        "label": label,
        "category": category,
        "safety_alert": is_safety,
        "strategy": strategy,
        "voucher": voucher,
        "translated": english_text
    }

@app.get("/api/dashboard/{server_id}")
def get_dashboard(server_id: str, db: Session = Depends(get_db)):
    reviews = db.query(SentimentReview).filter(SentimentReview.server_id == server_id).all()
    
    # Process Metrics
    total = len(reviews)
    pos = sum(1 for r in reviews if r.sentiment_label == "Positive")
    neu = sum(1 for r in reviews if r.sentiment_label == "Neutral")
    neg = sum(1 for r in reviews if r.sentiment_label == "Negative")
    
    # Painpoint Distribution
    categories = {"Skin": 0, "Logistics": 0, "Quality": 0, "Budol": 0, "General": 0}
    for r in reviews:
        if r.category in categories: categories[r.category] += 1
        
    return {
        "metrics": {"total": total, "pos": pos, "neu": neu, "neg": neg},
        "painpoints": categories,
        "recent_reviews": [
            {
                "text": r.original_text, 
                "strategy": r.host_strategy, 
                "alert": r.is_safety_alert,
                "voucher": r.voucher_code
            } for r in reviews[-10:][::-1]
        ]
    }

@app.delete("/api/wipe/{server_id}")
def wipe_history(server_id: str, db: Session = Depends(get_db)):
    db.query(SentimentReview).filter(SentimentReview.server_id == server_id).delete()
    db.commit()
    return {"status": "History Cleared"}

@app.get("/api/export/{server_id}")
def export_excel(server_id: str, db: Session = Depends(get_db)):
    reviews = db.query(SentimentReview).filter(SentimentReview.server_id == server_id).all()
    if not reviews: raise HTTPException(404, "No data")
    
    df = pd.DataFrame([r.__dict__ for r in reviews])
    if "_sa_instance_state" in df.columns: del df["_sa_instance_state"]
    
    stream = io.BytesIO()
    with pd.ExcelWriter(stream) as writer:
        df.to_excel(writer, index=False)
    
    stream.seek(0)
    return FileResponse(stream, filename=f"Mariposa_Report_{server_id}.xlsx")

# ==========================================
# üñ•Ô∏è 4. THE FRONTEND (UI/UX)
# ==========================================
@app.get("/", response_class=HTMLResponse)
def serve_ui():
    return """
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARIPOSA SKINCARE NLP v40</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;600;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0a; --card: #141414; --text: #ffffff;
            --pink: #ff85a2; --hot: #d63384; --alert: #ff4757;
            --font: 'Inter', sans-serif;
        }
        [data-theme="light"] {
            --bg: #f8f9fa; --card: #ffffff; --text: #121212;
        }
        body { background: var(--bg); color: var(--text); font-family: var(--font); margin: 0; padding: 0; transition: 0.3s; }
        
        /* SAFETY SHIELD MODE */
        body.safety-alert-mode { background: #2c0b0e; }
        body.safety-alert-mode .navbar { border-bottom: 4px solid var(--alert); }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media(max-width: 768px) { .container { grid-template-columns: 1fr; } } /* Smart Auto Fit */
        
        .navbar { padding: 20px; border-bottom: 2px solid var(--pink); display: flex; justify-content: space-between; align-items: center; background: var(--card); }
        .logo { font-weight: 900; font-size: 1.5rem; color: var(--pink); letter-spacing: -1px; }
        
        .card { background: var(--card); padding: 25px; border-radius: 16px; border: 1px solid rgba(255,133,162,0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        
        input, textarea, button { width: 100%; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #333; background: #000; color: #fff; font-family: inherit; box-sizing: border-box; }
        [data-theme="light"] input { background: #f0f0f0; color: #000; border: 1px solid #ccc; }
        
        button { cursor: pointer; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; transition: 0.2s; border: none; }
        .btn-primary { background: var(--pink); color: #000; }
        .btn-primary:hover { background: var(--hot); color: #fff; }
        .btn-danger { background: #333; color: #888; font-size: 0.8rem; width: auto; display: inline-block; }
        
        .metric-box { display: flex; gap: 10px; margin-bottom: 20px; }
        .metric { flex: 1; background: rgba(255,255,255,0.05); padding: 10px; text-align: center; border-radius: 8px; font-size: 0.9rem; }
        
        .strategy-box { border-left: 4px solid var(--pink); padding-left: 15px; margin-top: 15px; }
        .voucher-tag { background: #3b82f6; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        
        .alert-badge { background: var(--alert); color: white; padding: 5px 10px; border-radius: 20px; font-weight: 900; display: inline-block; margin-bottom: 10px; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="logo">üå∫ MARIPOSA v40</div>
    <div style="display:flex; gap:10px;">
        <input type="text" id="serverId" placeholder="SERVER ID" style="width: 120px; margin:0; text-align:center;">
        <button class="btn-primary" onclick="toggleTheme()" style="width: auto;">üåó Mode</button>
    </div>
</nav>

<div class="container">
    <div>
        <div class="card">
            <h3 style="color:var(--pink); margin-top:0;">üìù SENTIMENT ANALYZER</h3>
            <textarea id="reviewInput" rows="4" placeholder="Paste Taglish review here (e.g. 'Nangatol ako sa product niyo...')..."></textarea>
            
            <div style="display:flex; gap:10px;">
                <button class="btn-primary" onclick="analyze()">‚ö° ANALYZE & SYNC</button>
                <button class="btn-danger" onclick="clearInput()">CLEAR</button>
            </div>

            <div id="resultBox" style="display:none; margin-top:20px; border-top:1px solid #333; padding-top:20px;">
                <div id="safetyBadge"></div>
                <h4 id="resCategory" style="margin:0; opacity:0.7;">CATEGORY</h4>
                <p id="resText" style="font-style:italic; font-size:1.1rem;"></p>
                
                <div class="strategy-box">
                    <small style="color:var(--hot); font-weight:900;">HOST STRATEGY ACTION:</small>
                    <p id="resStrategy"></p>
                    <div id="resVoucher"></div>
                </div>
            </div>
        </div>

        <div class="card" style="margin-top:20px;">
            <h4 style="margin-top:0;">üë§ USER PROFILE MEMORY</h4>
            <input type="text" placeholder="Hard Constraints (e.g. Allergy: Alcohol)">
            <small style="opacity:0.6">These filters act as persistent metadata for recommendations.</small>
        </div>
    </div>

    <div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0;">üìä LIVE DASHBOARD</h3>
                <div>
                    <button class="btn-danger" onclick="downloadExcel()">üì• EXCEL</button>
                    <button class="btn-danger" onclick="wipeData()">üóëÔ∏è WIPE</button>
                </div>
            </div>
            
            <br>
            <div class="metric-box">
                <div class="metric">üòÅ <br><span id="countPos">0</span></div>
                <div class="metric">üòê <br><span id="countNeu">0</span></div>
                <div class="metric">üò° <br><span id="countNeg">0</span></div>
            </div>

            <div style="height: 200px; display:flex; gap:10px;">
                <div style="flex:1;"><canvas id="pieChart"></canvas></div>
                <div style="flex:1;"><canvas id="barChart"></canvas></div>
            </div>
        </div>
        
        <div class="card" style="margin-top:20px; max-height:300px; overflow-y:auto;">
            <h4>üïí RECENT ACTIVITY</h4>
            <div id="activityFeed"></div>
        </div>
    </div>
</div>

<script>
    let currentServerId = localStorage.getItem('mariposa_server') || 'DEMO';
    document.getElementById('serverId').value = currentServerId;
    let pieChart, barChart;

    // THEME TOGGLE
    function toggleTheme() {
        const body = document.body;
        body.setAttribute('data-theme', body.getAttribute('data-theme') === 'light' ? 'dark' : 'light');
    }

    // ANALYZE FUNCTION
    async function analyze() {
        const text = document.getElementById('reviewInput').value;
        currentServerId = document.getElementById('serverId').value;
        localStorage.setItem('mariposa_server', currentServerId);

        if(!text) return alert("Please enter text.");

        // Call Backend
        const res = await fetch(`/api/analyze/${currentServerId}?text=${encodeURIComponent(text)}`, {method: 'POST'});
        const data = await res.json();

        // UI Updates
        document.getElementById('resultBox').style.display = 'block';
        document.getElementById('resText').innerText = `"${data.translated}"`; // Showing translated text
        document.getElementById('resCategory').innerText = `${data.category.toUpperCase()} | SCORE: ${data.score.toFixed(2)}`;
        document.getElementById('resStrategy').innerText = data.strategy;
        
        // Safety Shield Trigger
        const badge = document.getElementById('safetyBadge');
        if(data.safety_alert) {
            document.body.classList.add('safety-alert-mode');
            badge.innerHTML = '<span class="alert-badge">‚ö†Ô∏è CLINICAL TRIAGE ALERT: HIGH PRIORITY</span>';
        } else {
            document.body.classList.remove('safety-alert-mode');
            badge.innerHTML = '';
        }

        // Voucher
        const vDiv = document.getElementById('resVoucher');
        vDiv.innerHTML = data.voucher ? `<br><span class="voucher-tag">üéÅ AUTO-GENERATED: ${data.voucher}</span>` : '';

        refreshDashboard();
    }

    // DASHBOARD REFRESH
    async function refreshDashboard() {
        const res = await fetch(`/api/dashboard/${currentServerId}`);
        const data = await res.json();

        // Metrics
        document.getElementById('countPos').innerText = data.metrics.pos;
        document.getElementById('countNeu').innerText = data.metrics.neu;
        document.getElementById('countNeg').innerText = data.metrics.neg;

        // Charts
        updateCharts(data.painpoints, data.metrics);

        // Feed
        const feed = document.getElementById('activityFeed');
        feed.innerHTML = data.recent_reviews.map(r => `
            <div style="border-bottom:1px solid #333; padding:10px 0; font-size:0.8rem;">
                ${r.alert ? 'üî¥' : '‚ö´'} <b>${r.text.substring(0,40)}...</b><br>
                <span style="opacity:0.7">Strategy: ${r.strategy.substring(0,30)}...</span>
            </div>
        `).join('');
    }

    function updateCharts(painpoints, metrics) {
        const pieCtx = document.getElementById('pieChart').getContext('2d');
        const barCtx = document.getElementById('barChart').getContext('2d');

        if(pieChart) pieChart.destroy();
        if(barChart) barChart.destroy();

        // Painpoint Distribution (Pie)
        pieChart = new Chart(pieCtx, {
            type: 'doughnut',
            data: {
                labels: ['Skin', 'Quality', 'Logistics'],
                datasets: [{
                    data: [painpoints.Skin, painpoints.Quality, painpoints.Logistics],
                    backgroundColor: ['#ff4757', '#f1c40f', '#3b82f6'],
                    borderWidth: 0
                }]
            },
            options: { plugins: { legend: { display: false } } }
        });

        // Sentiment Categories (Bar)
        barChart = new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: ['Pos', 'Neu', 'Neg'],
                datasets: [{
                    label: 'Count',
                    data: [metrics.pos, metrics.neu, metrics.neg],
                    backgroundColor: ['#2ed573', '#747d8c', '#ff4757']
                }]
            },
            options: { plugins: { legend: { display: false } }, scales: { x: { display: false } } }
        });
    }

    function clearInput() { document.getElementById('reviewInput').value = ''; document.getElementById('resultBox').style.display = 'none'; document.body.classList.remove('safety-alert-mode'); }
    async function wipeData() { if(confirm("Wipe all history for this Server ID?")) { await fetch(`/api/wipe/${currentServerId}`, {method: 'DELETE'}); refreshDashboard(); } }
    function downloadExcel() { window.location.href = `/api/export/${currentServerId}`; }

    // Init
    refreshDashboard();
</script>
</body>
</html>
    """

