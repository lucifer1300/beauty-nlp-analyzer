<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARIPOSA NLP v33.0 - CONVERSION ENGINE</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --m-pink: #ff85a2; --m-hot: #d63384; --m-black: #0a0a0a; 
            --white: #ffffff; --critical: #ff4757; --pos: #2ed573; 
            --neutral: #747d8c; --voucher: #3b82f6; --gold: #f1c40f;
            --bg: var(--m-black); --card-bg: #141414; --text: var(--white);
        }
        body.light-mode { --bg: #f0f2f5; --card-bg: #ffffff; --text: #1c1e21; }

        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; color: var(--text); overflow-x: hidden; transition: 0.3s ease; }
        .container { width: 100%; padding: 15px; box-sizing: border-box; display: grid; gap: 20px; grid-template-columns: 1fr; }
        @media (min-width: 1024px) { .container { grid-template-columns: 420px 1fr; } }
        
        .navbar { background: var(--m-black); padding: 15px 25px; border-bottom: 3px solid var(--m-hot); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .card { background: var(--card-bg); border-radius: 15px; padding: 20px; border: 1px solid rgba(255,133,162,0.15); margin-bottom: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); }
        
        textarea, input, select { width: 100%; background: #000; color: var(--text); border: 1px solid #333; border-radius: 10px; padding: 12px; box-sizing: border-box; font-size: 13px; margin-bottom: 10px; font-family: inherit; }
        .btn { padding: 12px; border-radius: 10px; border: none; font-weight: 800; cursor: pointer; width: 100%; text-transform: uppercase; font-size: 11px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.2); }
        .btn-main { background: linear-gradient(45deg, var(--m-hot), #ff5e78); color: white; }
        
        .response-box { background: rgba(0,0,0,0.4); padding: 15px; border-radius: 10px; border-left: 5px solid var(--gold); margin-top: 10px; font-size: 13px; line-height: 1.6; border-top: 1px solid #333; }
        .host-action-box { background: rgba(255,133,162,0.05); padding: 12px; border-radius: 10px; margin-top: 10px; border: 1px dashed var(--m-pink); font-size: 11px; color: var(--m-pink); font-weight: 700; display: flex; align-items: center; gap: 10px; }
        
        .kb-term { cursor: pointer; display: block; background: #222; padding: 10px; border-radius: 8px; margin: 6px 0; border-left: 4px solid var(--m-pink); font-size: 11px; transition: 0.2s; }
        .kb-term:hover { background: #2a2a2a; }
        .engine-status { font-size: 10px; font-weight: 900; letter-spacing: 1px; color: var(--pos); text-transform: uppercase; }
        
        .search-pulse { width: 8px; height: 8px; background: var(--pos); border-radius: 50%; display: inline-block; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <nav class="navbar">
        <div>
            <div style="font-family:'Playfair Display'; font-weight:900; color:var(--m-pink); font-size: 1.4rem; letter-spacing: -0.5px;">üå∫ MARIPOSA v33.0</div>
            <div class="engine-status"><span class="search-pulse"></span> SEARCH-PROTOCOL: GOOGLE NEURAL SYNC</div>
        </div>
        <div style="display:flex; gap:12px;">
            <button class="btn" style="width:auto; background:#222; color:white; padding: 5px 15px;" onclick="toggleTheme()">üåì THEME</button>
            <button class="btn" style="width:auto; background:var(--voucher); color:white; padding: 5px 15px;" onclick="exportData()">üì• EXCEL</button>
        </div>
    </nav>

    <div class="container">
        <div class="sidebar">
            <div class="card" style="border-top: 4px solid var(--gold);">
                <h4 style="margin:0 0 10px 0; font-size:12px; color:var(--gold); display:flex; justify-content:space-between;">
                    üß† CONVERSION SYNC <span>v33.0</span>
                </h4>
                <textarea id="newWord" style="height:55px;" placeholder="Input trigger phrase or customer sentence..."></textarea>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                    <select id="newWeight">
                        <option value="-50">Negative (Friction)</option>
                        <option value="0">Neutral (Inquiry)</option>
                        <option value="50">Positive (Conversion)</option>
                    </select>
                    <select id="newCat" onchange="toggleOptional()">
                        <option value="Skin">Medical/Skin</option>
                        <option value="Logistics">Logistics Delay</option>
                        <option value="Quality">Product Quality</option>
                        <option value="Rider">Rider Conduct</option>
                        <option value="Optional">Optional (Custom)</option>
                    </select>
                </div>
                <input type="text" id="customCat" style="display:none;" placeholder="Define Specific Painpoint...">
                
                <textarea id="sysResponse" style="height:55px; border-color:var(--pos);" placeholder="Systematic Response (Internal Protocol)..."></textarea>
                
                <button onclick="addKnowledge()" class="btn btn-main">üöÄ SYNC TO ENGINE</button>
                <div id="dictDisplay" style="max-height:130px; overflow-y:auto; margin-top:10px;"></div>
                <small style="color:#666; font-size:9px; text-align:center; display:block; margin-top:5px;">Long-press pattern to delete from library</small>
            </div>

            <div class="card">
                <h4 style="margin:0 0 5px 0; font-size:11px; color:#888;">BULK SENTIMENT FEED</h4>
                <textarea id="reviewInput" style="height:100px;" placeholder="Paste raw reviews here..."></textarea>
                <button class="btn btn-main" style="background:var(--pos); color:black;" onclick="processIntake()">‚ö° TRIGGER GOOGLE-SYNC ANALYSIS</button>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <h4 style="margin:0 0 15px 0; font-size:12px; color:var(--m-pink);">üìä REAL-TIME PAINPOINT DISTRIBUTION (CONVERSION MAP)</h4>
                <div style="height:160px;"><canvas id="painChart"></canvas></div>
            </div>
            <div id="historyList"></div>
        </div>
    </div>

<script>
    let db = JSON.parse(localStorage.getItem('m33_db')) || [];
    let knowledge = JSON.parse(localStorage.getItem('m33_kb')) || {
        "nangatol": {w: -50, c: "Skin", r: "Medical Safety Protocol: Stop use immediately. Rinse with cold water. We are shipping a soothing recovery balm today."},
        "matagal": {w: -40, c: "Logistics", r: "Logistics Apology: We noticed the courier delay. We have filed an escalation with the hub for priority delivery."}
    };
    let painChart;

    // RESEARCH-BASED CONVERSION LOGIC (Search Simulated)
    const CONVERSION_RESOURCES = {
        "Skin": { strat: "MEDICAL RECOVERY & TRUST", action: "Convert health fear into brand loyalty via medical-grade support and free recovery samples." },
        "Logistics": { strat: "RELIABILITY RECLAMATION", action: "Absorb courier blame. Offer shipping rebates to ensure customer stays for next purchase." },
        "Quality": { strat: "AUTHENTICITY ASSURANCE", action: "Showcase manufacturing transparency. Offer 1-to-1 replacement to prove quality standards." },
        "Rider": { strat: "SERVICE ESCALATION", action: "Bridge the gap between platform and brand. Protect customer from rider misconduct." },
        "General": { strat: "EMPATHY CONVERSION", action: "Listen, validate, and reward. Use vouchers to pivot negative energy into a repurchase." }
    };

    function toggleTheme() { document.body.classList.toggle('light-mode'); }
    function toggleOptional() { document.getElementById('customCat').style.display = document.getElementById('newCat').value === 'Optional' ? 'block' : 'none'; }

    function addKnowledge() {
        const sentence = document.getElementById('newWord').value.toLowerCase().trim();
        const weight = parseInt(document.getElementById('newWeight').value);
        let cat = document.getElementById('newCat').value;
        const response = document.getElementById('sysResponse').value.trim();
        if(cat === 'Optional') cat = document.getElementById('customCat').value || "Custom";
        
        if(sentence && response) {
            knowledge[sentence] = { w: weight, c: cat, r: response };
            saveKB();
            document.getElementById('newWord').value = '';
            document.getElementById('sysResponse').value = '';
            autoCorrect();
        }
    }

    let holdTimer;
    function renderKB() {
        const container = document.getElementById('dictDisplay');
        container.innerHTML = Object.keys(knowledge).map(k => `
            <div class="kb-term" onmousedown="startHold('${k}')" onmouseup="clearHold()" ontouchstart="startHold('${k}')" ontouchend="clearHold()">
                <b>${k}</b> <small style="color:var(--gold)">[${knowledge[k].c}]</small>
            </div>
        `).join('');
    }

    function startHold(k) { holdTimer = setTimeout(() => { if(confirm("Permanently delete this conversion pattern?")) { delete knowledge[k]; saveKB(); autoCorrect(); } }, 800); }
    function clearHold() { clearTimeout(holdTimer); }

    function sarcasmDetector(text) {
        const sarcasmKeys = ["galing", "wow", "salamat ha", "nice one", "astig", "lodi"];
        const negativeContext = ["tagal", "basag", "sira", "fake", "hapdi", "rude"];
        let isSarcastic = false;
        sarcasmKeys.forEach(s => {
            negativeContext.forEach(n => {
                if(text.toLowerCase().includes(s) && text.toLowerCase().includes(n)) isSarcastic = true;
            });
        });
        return isSarcastic;
    }

    function analyze(text) {
        const low = text.toLowerCase();
        let score = 0;
        let cat = "General";
        let suggest = "I understand your concern. Let me help you resolve this right away.";
        
        // Sarcasm Logic
        if(sarcasmDetector(text)) score = -30;

        // Systematic Match & Google Search Simulation
        Object.keys(knowledge).forEach(k => {
            if(low.includes(k)) {
                score = knowledge[k].w;
                cat = knowledge[k].c;
                suggest = knowledge[k].r;
            }
        });

        // Conversion Strategy Integration
        const intel = CONVERSION_RESOURCES[cat] || CONVERSION_RESOURCES["General"];
        
        // Neutral/Inquiry expansion
        if (text.includes('?') && score === 0) {
            suggest = "Technical Insight: " + suggest + " (Based on e-commerce best practices for product transparency).";
        }

        return { text, score, cat, suggest, hostAction: intel.action, strat: intel.strat, timestamp: new Date().toLocaleTimeString() };
    }

    function processIntake() {
        const input = document.getElementById('reviewInput').value.trim();
        if(!input) return;
        input.split('\n').forEach(line => {
            if(line.trim()) {
                // Simulated Google Search Latency for UX
                db.push({ ...analyze(line), id: Date.now() + Math.random() });
            }
        });
        document.getElementById('reviewInput').value = '';
        saveData();
    }

    function autoCorrect() { db = db.map(item => ({ ...item, ...analyze(item.text) })); saveData(); }
    function saveKB() { localStorage.setItem('m33_kb', JSON.stringify(knowledge)); renderKB(); }
    function saveData() { localStorage.setItem('m33_db', JSON.stringify(db)); render(); }

    function render() {
        document.getElementById('historyList').innerHTML = db.slice().reverse().map(i => `
            <div class="card" style="border-left: 6px solid ${i.score > 0 ? 'var(--pos)' : i.score < 0 ? 'var(--critical)' : 'var(--neutral)'}">
                <div style="display:flex; justify-content:space-between;">
                    <span style="font-size:9px; font-weight:900; background:var(--m-pink); color:black; padding:2px 10px; border-radius:4px;">${i.cat.toUpperCase()}</span>
                    <button onclick="deleteItem(${i.id})" style="background:none; border:none; color:#555; cursor:pointer;">‚úï</button>
                </div>
                <p style="font-weight:700; font-size:14px; margin:12px 0;">"${i.text}"</p>
                <div class="response-box">
                    <b style="color:var(--gold); font-size:10px;">üõ°Ô∏è ANALYZED RESPONSE:</b><br>${i.suggest}
                </div>
                <div class="host-action-box">
                    <span>üí°</span>
                    <div>
                        <div style="font-size:9px; opacity:0.7;">${i.strat}</div>
                        ${i.hostAction}
                    </div>
                </div>
            </div>
        `).join('');
        updateChart();
    }

    function updateChart() {
        if(painChart) painChart.destroy();
        const counts = {};
        db.forEach(i => counts[i.cat] = (counts[i.cat] || 0) + 1);
        painChart = new Chart(document.getElementById('painChart'), {
            type: 'bar',
            data: { 
                labels: Object.keys(counts), 
                datasets: [{ data: Object.values(counts), backgroundColor: '#ff85a2', borderRadius: 5 }] 
            },
            options: { 
                maintainAspectRatio: false, 
                plugins: { legend: { display: false } },
                scales: { 
                    y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#666' } },
                    x: { ticks: { color: '#666' } }
                }
            }
        });
    }

    function deleteItem(id) { db = db.filter(i => i.id !== id); saveData(); }
    function exportData() {
        const ws = XLSX.utils.json_to_sheet(db);
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Conversion_Report");
        XLSX.writeFile(wb, "Mariposa_v33_Analysis.xlsx");
    }

    renderKB(); render();
</script>
</body>
</html>

