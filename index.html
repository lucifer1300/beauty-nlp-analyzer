<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARIPOSA SKINCARE NLP v40</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;600;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #0a0a0a; --card: #141414; --text: #ffffff;
            --pink: #ff85a2; --hot: #d63384; --alert: #ff4757;
            --font: 'Inter', sans-serif;
        }
        [data-theme="light"] {
            --bg: #f8f9fa; --card: #ffffff; --text: #121212;
        }
        body { background: var(--bg); color: var(--text); font-family: var(--font); margin: 0; padding: 0; transition: 0.3s; overflow-x: hidden; }
        
        /* SAFETY SHIELD MODE */
        body.safety-alert-mode { background: #2c0b0e !important; }
        body.safety-alert-mode .navbar { border-bottom: 4px solid var(--alert); }
        
        .navbar { padding: 15px 25px; border-bottom: 2px solid var(--pink); display: flex; justify-content: space-between; align-items: center; background: var(--card); sticky: top; z-index: 100; }
        .logo { font-weight: 900; font-size: 1.4rem; color: var(--pink); letter-spacing: -1px; }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media(max-width: 850px) { .container { grid-template-columns: 1fr; } } /* Auto-fit Screen */

        .card { background: var(--card); padding: 25px; border-radius: 16px; border: 1px solid rgba(255,133,162,0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.3); position: relative; }
        
        textarea, input { width: 100%; padding: 15px; margin-bottom: 12px; border-radius: 10px; border: 1px solid #333; background: #000; color: #fff; font-family: inherit; box-sizing: border-box; font-size: 1rem; }
        [data-theme="light"] input, [data-theme="light"] textarea { background: #f0f0f0; color: #000; border: 1px solid #ccc; }

        button { cursor: pointer; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; transition: 0.2s; border: none; padding: 14px; border-radius: 10px; }
        .btn-primary { background: var(--pink); color: #000; width: 100%; }
        .btn-primary:hover { background: var(--hot); color: #fff; transform: translateY(-2px); }
        .btn-danger { background: #333; color: #ff8a8a; font-size: 0.75rem; width: auto; padding: 8px 15px; margin-left: 5px; }
        
        .metric-box { display: flex; gap: 10px; margin-bottom: 20px; }
        .metric { flex: 1; background: rgba(255,255,255,0.05); padding: 15px; text-align: center; border-radius: 12px; }
        .metric span { font-size: 1.5rem; font-weight: 900; color: var(--pink); }

        .strategy-box { border-left: 4px solid var(--pink); padding: 15px; background: rgba(255,133,162,0.05); border-radius: 0 12px 12px 0; margin-top: 15px; }
        .alert-badge { background: var(--alert); color: white; padding: 8px 15px; border-radius: 30px; font-weight: 900; font-size: 0.8rem; animation: pulse 1.5s infinite; display: inline-block; margin-bottom: 15px; }
        
        .voucher-tag { background: #3b82f6; color: white; padding: 5px 10px; border-radius: 6px; font-size: 0.85rem; font-weight: 900; display: inline-block; margin-top: 10px; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        .activity-item { padding: 12px; border-bottom: 1px solid #222; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; }
        .activity-item:last-child { border-bottom: none; }
    </style>
</head>
<body data-theme="dark">

<nav class="navbar">
    <div class="logo">üå∫ MARIPOSA SKINCARE NLP</div>
    <div style="display:flex; gap:10px; align-items:center;">
        <input type="text" id="serverId" placeholder="SERVER ID" style="width: 110px; margin:0; padding:8px; text-align:center;">
        <button onclick="toggleTheme()" style="background:none; border:1px solid var(--pink); color:var(--pink); padding:8px 12px;">üåó</button>
    </div>
</nav>

<div class="container">
    <div class="column">
        <div class="card">
            <h3 style="color:var(--pink); margin:0 0 15px 0;">üìù SENTIMENT ENGINE</h3>
            <textarea id="reviewInput" rows="5" placeholder="Paste Taglish reviews (e.g., 'Nangatol ako at namula ang face ko...')"></textarea>
            
            <div style="display:flex; gap:10px;">
                <button class="btn-primary" onclick="processSentiment()">‚ö° ANALYZE & CONVERT</button>
            </div>
            <button class="btn-danger" style="margin-top:10px; width:100%;" onclick="document.getElementById('reviewInput').value=''">CLEAR INPUT</button>

            <div id="resultPanel" style="display:none; margin-top:25px; border-top:1px solid #333; padding-top:20px;">
                <div id="safetyShield"></div>
                <h4 id="resCategory" style="margin:0; text-transform:uppercase; color:var(--pink); font-size:0.8rem;"></h4>
                <p id="resTranslation" style="font-style:italic; opacity:0.8; margin:10px 0;"></p>
                
                <div class="strategy-box">
                    <strong style="font-size:0.75rem; color:var(--hot);">STRATEGY ACTION:</strong>
                    <p id="resStrategy" style="margin:5px 0; line-height:1.4;"></p>
                    <div id="resVoucher"></div>
                </div>
            </div>
        </div>

        <div class="card" style="margin-top:20px;">
            <h4 style="margin:0 0 10px 0;">üë§ USER PROFILE MEMORY (RAG)</h4>
            <input type="text" id="userConstraints" placeholder="Constraints: Rosacea, Allergy to Alcohol..." value="Skin: Sensitive, Allergy: Fragrance">
            <p style="font-size:0.75rem; opacity:0.6; margin:0;">Persistent metadata used to filter dermatological recommendations.</p>
        </div>
    </div>

    <div class="column">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0;">üìä DASHBOARD</h3>
                <div>
                    <button class="btn-danger" onclick="exportToExcel()">EXPORT</button>
                    <button class="btn-danger" onclick="wipeHistory()">WIPE</button>
                </div>
            </div>

            <div class="metric-box" style="margin-top:20px;">
                <div class="metric"><small>POS</small><br><span id="statPos">0</span></div>
                <div class="metric"><small>NEU</small><br><span id="statNeu">0</span></div>
                <div class="metric"><small>NEG</small><br><span id="statNeg">0</span></div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; height:220px;">
                <div><canvas id="pieChart"></canvas></div>
                <div><canvas id="barChart"></canvas></div>
            </div>
        </div>

        <div class="card" style="margin-top:20px;">
            <h4 style="margin:0 0 10px 0;">üïí RECENT PROJECT ACTIVITY</h4>
            <div id="activityFeed" style="max-height: 200px; overflow-y: auto;"></div>
        </div>
    </div>
</div>

<script>
    // --- 1. CONFIGURATION & DATASET (The "Brain") ---
    const TAGLISH_DICTIONARY = {
        "hapdi": "stinging", "nangatol": "itchy", "namula": "redness",
        "hulas": "melted_makeup", "budol": "impulse_buy", "tagal": "slow_delivery",
        "basag": "broken", "peke": "fake", "bango": "scented", "mahal": "expensive"
    };

    const STRATEGY_MAP = {
        "Skin": "CLINICAL TRIAGE: Stop use. Suggest cold compress. Offer refund + soap-free cleanser voucher.",
        "Logistics": "LOGISTICS RECOVERY: Apologize for delay. Research says 10% voucher restores trust after shipping friction.",
        "Quality": "QUALITY ASSURANCE: 1-to-1 replacement via express shipping. Request batch ID for R&D.",
        "Budol": "RETENTION UPSELL: Customer values 'Budol'. Suggest 'Holy Grail' combo for next purchase.",
        "General": "CUSTOMER CARE: Personalize response with Taglish empathy."
    };

    let pieChart, barChart;
    let serverId = localStorage.getItem('mariposa_id') || Math.random().toString(36).substring(2, 10).toUpperCase();
    document.getElementById('serverId').value = serverId;

    // --- 2. THEME ENGINE ---
    function toggleTheme() {
        const current = document.body.getAttribute('data-theme');
        document.body.setAttribute('data-theme', current === 'dark' ? 'light' : 'dark');
    }

    // --- 3. NLP LOGIC ---
    function translate(text) {
        let eng = text.toLowerCase();
        Object.keys(TAGLISH_DICTIONARY).forEach(key => {
            eng = eng.replace(new RegExp(key, 'g'), TAGLISH_DICTIONARY[key]);
        });
        return eng;
    }

    function processSentiment() {
        const rawText = document.getElementById('reviewInput').value;
        if(!rawText) return;

        const englishText = translate(rawText);
        
        // Accurate Sentiment Detection (Keyword based for Client-side)
        let score = 0;
        const negWords = ['stinging', 'itchy', 'redness', 'slow', 'broken', 'fake', 'bad', 'hapdi', 'nangatol'];
        const posWords = ['good', 'nice', 'effective', 'bango', 'sulit', 'love'];
        
        negWords.forEach(w => { if(englishText.includes(w)) score -= 1.5; });
        posWords.forEach(w => { if(englishText.includes(w)) score += 1.0; });

        // Category Detection
        let category = "General";
        if(englishText.match(/skin|itchy|redness|face|stinging|hapdi|namula/)) category = "Skin";
        else if(englishText.match(/ship|deliver|tagal|wait|rider/)) category = "Logistics";
        else if(englishText.match(/broken|fake|seal|basag/)) category = "Quality";
        else if(englishText.match(/budol|sulit|worth/)) category = "Budol";

        // Safety Shield
        const isSafety = englishText.match(/itchy|stinging|redness|burn|pain|nangatol|hapdi|namula/);
        
        // Save Data
        const entry = {
            id: Date.now(),
            text: rawText,
            eng: englishText,
            cat: category,
            score: score,
            safety: isSafety,
            strategy: STRATEGY_MAP[category],
            voucher: score < -1 ? `MARIPOSA-${Math.random().toString(36).substring(2,6).toUpperCase()}` : null,
            date: new Date().toLocaleString()
        };

        saveToDB(entry);
        updateUI(entry);
    }

    // --- 4. DATABASE & UI ---
    function saveToDB(entry) {
        let history = JSON.parse(localStorage.getItem(`mariposa_db_${serverId}`)) || [];
        history.push(entry);
        localStorage.setItem(`mariposa_db_${serverId}`, JSON.stringify(history));
        refreshDashboard();
    }

    function updateUI(data) {
        document.getElementById('resultPanel').style.display = 'block';
        document.getElementById('resCategory').innerText = `${data.cat} Sentiment`;
        document.getElementById('resTranslation').innerText = `Translation: "${data.eng}"`;
        document.getElementById('resStrategy').innerText = data.strategy;
        
        // Safety Shield Alert
        if(data.safety) {
            document.body.classList.add('safety-alert-mode');
            document.getElementById('safetyShield').innerHTML = `<div class="alert-badge">‚ö†Ô∏è HIGH PRIORITY: CLINICAL TRIAGE TRIGGERED</div>`;
        } else {
            document.body.classList.remove('safety-alert-mode');
            document.getElementById('safetyShield').innerHTML = '';
        }

        document.getElementById('resVoucher').innerHTML = data.voucher ? `<div class="voucher-tag">üéÅ RECOVERY VOUCHER: ${data.voucher}</div>` : '';
    }

    function refreshDashboard() {
        const history = JSON.parse(localStorage.getItem(`mariposa_db_${serverId}`)) || [];
        const stats = { pos: 0, neu: 0, neg: 0 };
        const cats = { Skin: 0, Logistics: 0, Quality: 0, Budol: 0, General: 0 };

        history.forEach(item => {
            if(item.score > 0) stats.pos++;
            else if(item.score < 0) stats.neg++;
            else stats.neu++;
            cats[item.cat]++;
        });

        document.getElementById('statPos').innerText = stats.pos;
        document.getElementById('statNeu').innerText = stats.neu;
        document.getElementById('statNeg').innerText = stats.neg;

        renderCharts(stats, cats);
        renderActivity(history);
    }

    function renderCharts(stats, cats) {
        const pieCtx = document.getElementById('pieChart').getContext('2d');
        const barCtx = document.getElementById('barChart').getContext('2d');

        if(pieChart) pieChart.destroy();
        if(barChart) barChart.destroy();

        pieChart = new Chart(pieCtx, {
            type: 'doughnut',
            data: {
                labels: ['Skin', 'Logistics', 'Quality', 'Budol'],
                datasets: [{
                    data: [cats.Skin, cats.Logistics, cats.Quality, cats.Budol],
                    backgroundColor: ['#ff4757', '#3b82f6', '#f1c40f', '#ff85a2'],
                    borderWidth: 0
                }]
            },
            options: { plugins: { legend: { display: false } }, maintainAspectRatio: false }
        });

        barChart = new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: ['Pos', 'Neu', 'Neg'],
                datasets: [{
                    data: [stats.pos, stats.neu, stats.neg],
                    backgroundColor: ['#2ed573', '#747d8c', '#ff4757']
                }]
            },
            options: { plugins: { legend: { display: false } }, maintainAspectRatio: false }
        });
    }

    function renderActivity(history) {
        const feed = document.getElementById('activityFeed');
        feed.innerHTML = history.reverse().slice(0, 10).map(h => `
            <div class="activity-item">
                <span>${h.safety ? 'üî¥' : '‚ö´'} ${h.text.substring(0,30)}...</span>
                <small style="opacity:0.5">${h.cat}</small>
            </div>
        `).join('');
    }

    function wipeHistory() {
        if(confirm("Wipe all data for this Project ID?")) {
            localStorage.removeItem(`mariposa_db_${serverId}`);
            refreshDashboard();
            document.body.classList.remove('safety-alert-mode');
        }
    }

    function exportToExcel() {
        const history = JSON.parse(localStorage.getItem(`mariposa_db_${serverId}`)) || [];
        const ws = XLSX.utils.json_to_sheet(history);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "SentimentReport");
        XLSX.writeFile(wb, `Mariposa_Report_${serverId}.xlsx`);
    }

    // Initialize
    refreshDashboard();
    document.getElementById('serverId').addEventListener('change', (e) => {
        serverId = e.target.value.toUpperCase();
        localStorage.setItem('mariposa_id', serverId);
        refreshDashboard();
    });
</script>

</body>
</html>

