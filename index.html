<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D.Z. Mariposa NLP - v60 THE VAULT</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --mariposa-pink: #ff85a2; --mariposa-hot: #d63384; --mariposa-black: #0a0a0a;
            --mariposa-dark-grey: #161616; --white: #ffffff; --critical: #ff4757; 
            --pos: #2ed573; --voucher-blue: #3b82f6; --intel-gold: #f1c40f;
            --logistics-purple: #8e44ad; --crisis-orange: #ff7f50; --ai-glow: #00f2ff;
        }
        
        body { font-family: 'Inter', sans-serif; background: var(--mariposa-black); margin: 0; color: var(--white); overflow-x: hidden; }
        .container { width: 95%; max-width: 1600px; margin: 10px auto; padding: 10px; }
        
        .navbar { background: #000; padding: 15px 25px; border-bottom: 2px solid var(--mariposa-hot); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }

        .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 1200px) { .dashboard-grid { grid-template-columns: 420px 1fr; } }

        .card { background: var(--mariposa-dark-grey); border-radius: 12px; padding: 20px; border: 1px solid rgba(255,133,162,0.1); position: relative; margin-bottom: 20px; }
        
        /* Heatmap Grid (v30) */
        .heatmap-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 10px; }
        .heatmap-cell { height: 45px; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; background: #000; border: 1px solid #222; }
        .h-label { font-size: 8px; color: #666; text-transform: uppercase; }

        .btn { padding: 12px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; text-transform: uppercase; font-size: 10px; }
        .btn-main { background: var(--mariposa-hot); color: white; width: 100%; margin-top: 10px; }
        .btn-ai { background: linear-gradient(45deg, #00c6ff, #0072ff); color: white; }
        .btn-clear { background: var(--critical); color: white; font-size: 8px; padding: 3px 8px; border-radius: 4px; }

        /* Prototypes (v30) */
        .tip-box { font-size: 11px; border-radius: 5px; padding: 10px; margin-top: 10px; border: 1px solid; }
        .clinical-tip { background: rgba(255, 71, 87, 0.1); border-color: var(--critical); color: #ff9f9f; }
        .logistics-tip { background: rgba(142, 68, 173, 0.1); border-color: var(--logistics-purple); color: #d7bde2; }

        /* Dict Tags (v40) */
        .dict-tag { display: inline-flex; align-items: center; background: #222; border: 1px solid #444; padding: 5px 10px; border-radius: 5px; margin: 3px; font-size: 11px; cursor: pointer; user-select: none; }
        
        textarea { width: 100%; height: 100px; background: #000; color: #fff; border: 1px solid #333; border-radius: 8px; padding: 12px; box-sizing: border-box; resize: none; }
        .chart-container { height: 180px; position: relative; }
        #crisisOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: none; padding: 40px; overflow-y: auto; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div>
            <div style="font-family:'Playfair Display'; font-weight:900; color:var(--mariposa-pink); font-size: 1.4rem;">üå∫ MARIPOSA v60 OMNI-VAULT</div>
            <div id="liveClock" style="font-size: 11px; color: var(--pos); font-family: monospace;"></div>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn" onclick="document.getElementById('crisisOverlay').style.display='block'" style="background:var(--crisis-orange); color:white;">üìã CRISIS HUB</button>
            <button class="btn" onclick="exportData()" style="background:#fff; color:#000;">üì• FULL EXCEL</button>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-grid">
            <div class="sidebar">
                <div class="card">
                    <h4 style="margin:0; color:var(--mariposa-pink); font-size:11px;">üïí REVIEW HEATMAP</h4>
                    <div class="heatmap-grid" id="heatmapGrid">
                        <div class="heatmap-cell" id="h-night">0<span class="h-label">Night</span></div>
                        <div class="heatmap-cell" id="h-morning">0<span class="h-label">Morn</span></div>
                        <div class="heatmap-cell" id="h-afternoon">0<span class="h-label">Aft</span></div>
                        <div class="heatmap-cell" id="h-evening">0<span class="h-label">Eve</span></div>
                    </div>
                </div>

                <div class="card" style="border-top: 4px solid var(--voucher-blue);">
                    <h4 style="margin:0 0 10px 0; color:var(--voucher-blue); font-size:11px;">üìä ACTIVE LIABILITY</h4>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                        <div style="background:#000; padding:10px; border-radius:8px; text-align:center;">
                            <span style="font-size:20px; font-weight:900; color:var(--voucher-blue);" id="totalVouchers">0</span><br><span style="font-size:8px; color:#666;">VOUCHERS</span>
                        </div>
                        <div style="background:#000; padding:10px; border-radius:8px; text-align:center;">
                            <span style="font-size:20px; font-weight:900; color:var(--pos);" id="estExposure">‚Ç±0</span><br><span style="font-size:8px; color:#666;">RISK</span>
                        </div>
                    </div>
                    <div style="max-height:150px; overflow-y:auto;"><table style="width:100%; font-size:10px;" id="voucherTable"></table></div>
                </div>

                <div class="card">
                    <h4 style="margin:0 0 10px 0; color:var(--intel-gold); font-size:11px;">üìñ VOCABULARY SYNC</h4>
                    <input type="text" id="dictSearch" onkeyup="renderDict()" placeholder="Search dictionary..." style="margin-bottom:8px; background:#000; border:1px solid #333; color:#fff; font-size:10px; padding:5px; width:100%;">
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <input type="text" id="newWord" placeholder="Add word..." style="background:#000; border:1px solid #333; color:#fff; font-size:10px; width:100%;">
                        <button class="btn" onclick="addToDict()" style="background:var(--intel-gold); color:black; padding:0 15px;">ADD</button>
                    </div>
                    <div id="dictList" style="max-height:150px; overflow-y:auto; border:1px solid #222; padding:5px;"></div>
                </div>
            </div>

            <div class="main-content">
                <div class="card" style="border-left: 8px solid var(--mariposa-hot);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h2 style="margin:0; font-family:'Playfair Display'; color:var(--mariposa-pink);">NLP Intake</h2>
                        <div id="sentimentEmoji" style="font-size:40px;">üòê</div>
                    </div>
                    <textarea id="reviewInput" placeholder="Paste Tagalog/English reviews..."></textarea>
                    <button class="btn btn-main" onclick="processAnalysis()">‚ö° RUN OMNI ANALYSIS</button>
                    <button class="btn" style="background:transparent; color:#444; width:100%; margin-top:5px;" onclick="clearAllData()">Wipe All Records</button>
                </div>

                <div class="card">
                    <h4 style="margin:0; color:var(--mariposa-pink); font-size:11px;">üìà SENTIMENT TREND (v30 RESTORED)</h4>
                    <div class="chart-container"><canvas id="lineChart"></canvas></div>
                </div>

                <div id="historyList"></div>
            </div>
        </div>
    </div>

    <div id="crisisOverlay">
        <h1 style="color:var(--crisis-orange); font-family:'Playfair Display';">WEEKLY CRISIS & CONVERSION HUB</h1>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <div class="card"><h3>Managerial Tasks</h3><div id="taskList" style="font-size:12px;"></div></div>
            <div class="card"><h3>Conversion Strategies</h3><ul id="strategies" style="font-size:13px; line-height:1.8;"></ul></div>
        </div>
        <button class="btn" onclick="document.getElementById('crisisOverlay').style.display='none'" style="background:#fff; color:#000; margin-top:20px;">BACK TO DASHBOARD</button>
    </div>

<script>
    let db = JSON.parse(localStorage.getItem('mariposa_v60_db')) || [];
    let vouchers = JSON.parse(localStorage.getItem('mariposa_v60_vouchers')) || [];
    let dictionary = JSON.parse(localStorage.getItem('mariposa_v60_dict')) || [
        {word: 'masarap', sent: 'pos'}, {word: 'hiyang', sent: 'pos'}, {word: 'hapdi', sent: 'neg'}
    ];
    let lineChart;

    // Dictionary Management (v40 Long Press)
    let pressTimer;
    function startPress(word) { pressTimer = window.setTimeout(() => { if(confirm(`Delete "${word}"?`)) { dictionary = dictionary.filter(d => d.word !== word); saveDict(); } }, 750); }
    function clearPress() { clearTimeout(pressTimer); }
    function saveDict() { localStorage.setItem('mariposa_v60_dict', JSON.stringify(dictionary)); renderDict(); }
    function addToDict() {
        const word = document.getElementById('newWord').value.toLowerCase().trim();
        if(word && !dictionary.find(d => d.word === word)) { dictionary.push({word, sent: 'pos'}); document.getElementById('newWord').value = ''; saveDict(); }
    }
    function renderDict() {
        const s = document.getElementById('dictSearch').value.toLowerCase();
        document.getElementById('dictList').innerHTML = dictionary.filter(d => d.word.includes(s)).map(d => `
            <div class="dict-tag" onmousedown="startPress('${d.word}')" onmouseup="clearPress()" onmouseleave="clearPress()" ontouchstart="startPress('${d.word}')" ontouchend="clearPress()">${d.word}</div>`).join('');
    }

    // AI & Analysis
    function generateAIReply(id) {
        const item = db.find(i => i.id === id);
        let reply = item.score > 0 ? "Salamat po sa tiwala! Dasurb mo ang glow! ‚ú®" : "Pasensya na po. DM us your Order ID para ma-refund or replace namin agad.";
        if(item.isClinical) reply = "üö® STOP USE IMMEDIATELY. Rinse with water. DM us for a full medical refund.";
        item.aiDraft = reply;
        saveData();
    }

    function processAnalysis() {
        const text = document.getElementById('reviewInput').value.trim();
        if(!text) return;
        const low = text.toLowerCase();
        let score = low.includes('masarap') ? 6 : 0;
        dictionary.forEach(d => { if(low.includes(d.word)) score += (d.sent === 'pos' ? 4 : -5); });
        
        const isClin = /hapdi|rash|sunog|irritation|pimple|nangatol/i.test(low);
        const isLog = /rider|late|shipping|basag|tapon|leak/i.test(low);
        
        db.push({
            id: Date.now(), text, score,
            sentiment: score > 0 ? "Positive" : (score < 0 ? "Negative" : "Neutral"),
            isClinical: isClin, isLogistics: isLog,
            timestamp: new Date().toLocaleString(), vIssued: false, aiDraft: null
        });
        document.getElementById('reviewInput').value = "";
        saveData();
    }

    function issueVoucher(id) {
        const item = db.find(i => i.id === id);
        item.vIssued = true;
        vouchers.push({ id: Date.now(), pId: id, code: 'MAR-'+Math.floor(Math.random()*9999), amt: item.isClinical ? 100 : 50 });
        saveData();
    }

    function clearVoucher(vid) { vouchers = vouchers.filter(v => v.id !== vid); saveData(); }

    function render() {
        document.getElementById('historyList').innerHTML = db.slice().reverse().map(i => `
            <div class="card" style="border-left: 6px solid ${i.score > 0 ? 'var(--pos)' : (i.score < 0 ? 'var(--critical)' : 'gray')}">
                <span style="font-size:10px;">${i.sentiment.toUpperCase()}</span>
                <p style="font-size:14px; margin:10px 0;">"${i.text}"</p>
                
                ${i.isClinical ? `<div class="tip-box clinical-tip"><b>üè• PROTOCOL:</b> Stop use. Rinse with lukewarm water. Apply cool compress.</div>` : ''}
                ${i.isLogistics ? `<div class="tip-box logistics-tip"><b>üöö PROTOCOL:</b> File dispute with courier. Offer Priority Reshipment.</div>` : ''}

                <div style="display:flex; gap:8px; margin-top:15px;">
                    <button class="btn btn-ai" onclick="generateAIReply(${i.id})">ü™Ñ AI REPLY</button>
                    ${(i.score < 0 && !i.vIssued) ? `<button class="btn" style="background:var(--voucher-blue); color:white;" onclick="issueVoucher(${i.id})">üé´ VOUCHER</button>` : ''}
                    <button class="btn" style="background:#222;" onclick="deleteItem(${i.id})">üóëÔ∏è</button>
                </div>
                ${i.aiDraft ? `<div style="background:#000; padding:10px; margin-top:10px; border:1px dashed var(--ai-glow); font-size:12px; color:var(--ai-glow);">${i.aiDraft}</div>` : ''}
            </div>`).join('');
        
        updateStats();
        updateCharts();
        updateCrisis();
    }

    function updateStats() {
        document.getElementById('totalVouchers').innerText = vouchers.length;
        document.getElementById('estExposure').innerText = "‚Ç±" + vouchers.reduce((s, v) => s + v.amt, 0);
        document.getElementById('voucherTable').innerHTML = vouchers.map(v => `
            <tr style="border-bottom:1px solid #222;"><td style="padding:5px;">${v.code}</td><td style="text-align:right;"><button class="btn-clear" onclick="clearVoucher(${v.id})">CLEAR</button></td></tr>`).join('');
        
        // Heatmap v30 logic
        const slots = { Night:0, Morning:0, Afternoon:0, Evening:0 };
        db.forEach(e => {
            const h = new Date(e.id).getHours();
            let s = h < 6 ? "Night" : h < 12 ? "Morning" : h < 18 ? "Afternoon" : "Evening";
            slots[s]++;
        });
        Object.keys(slots).forEach(s => { const el = document.getElementById(`h-${s.toLowerCase()}`); if(el) el.innerHTML = `${slots[s]}<span class="h-label">${s}</span>`; });
        
        const last = db[db.length-1];
        if(last) document.getElementById('sentimentEmoji').innerText = last.score > 0 ? "üòç" : (last.score < 0 ? "üòî" : "üòê");
    }

    function updateCharts() {
        if(lineChart) lineChart.destroy();
        const slice = db.slice(-15);
        lineChart = new Chart(document.getElementById('lineChart'), {
            type: 'line', data: { labels: slice.map(i => i.timestamp.split(',')[1]), datasets: [{ data: slice.map(i => i.score), borderColor: '#ff85a2', tension: 0.3, fill: true, backgroundColor: 'rgba(255, 133, 162, 0.1)' }] },
            options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    function updateCrisis() {
        const negs = db.filter(i => i.score < 0);
        document.getElementById('taskList').innerHTML = negs.map(n => `<div style="border-bottom:1px solid #333; padding:5px;">Task: Contact customer re: ${n.isClinical ? 'Reaction' : 'Logistics'}</div>`).join('');
        document.getElementById('strategies').innerHTML = `<li>Response < 2hrs increases retention by 88%</li><li>Acknowledge mistakes publicly, solve in DMs</li><li>Logistics vouchers convert 40% of angry users</li>`;
    }

    function saveData() { localStorage.setItem('mariposa_v60_db', JSON.stringify(db)); localStorage.setItem('mariposa_v60_vouchers', JSON.stringify(vouchers)); render(); }
    function deleteItem(id) { db = db.filter(i => i.id !== id); saveData(); }
    function clearAllData() { if(confirm("Wipe everything?")) { localStorage.clear(); location.reload(); } }
    function exportData() { const ws = XLSX.utils.json_to_sheet(db); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "MasterData"); XLSX.writeFile(wb, "Mariposa_Vault_v60.xlsx"); }

    setInterval(() => { document.getElementById('liveClock').innerText = new Date().toLocaleString(); }, 1000);
    renderDict();
    saveData();
</script>
</body>
</html>
