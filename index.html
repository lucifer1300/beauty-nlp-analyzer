<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D.Z. Mariposa NLP - v29.6 OMNISCIENT</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --mariposa-pink: #ff85a2; --mariposa-hot: #d63384;
            --mariposa-black: #121212; --mariposa-dark-grey: #1e1e1e;
            --white: #ffffff; --critical: #ff4757; --pos: #2ed573; 
            --voucher-blue: #3b82f6; --intel-gold: #f1c40f;
        }
        
        body { font-family: 'Inter', sans-serif; background: var(--mariposa-black); margin: 0; color: var(--white); }
        .container { width: 95%; max-width: 1400px; margin: 10px auto; padding: 10px; display: grid; gap: 20px; grid-template-columns: 1fr; }
        @media (min-width: 1024px) { .container { grid-template-columns: 420px 1fr; } }
        
        .navbar { background: #000; padding: 15px 25px; border-bottom: 2px solid var(--mariposa-hot); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .card { background: var(--mariposa-dark-grey); border-radius: 12px; padding: 18px; border: 1px solid rgba(255,133,162,0.1); margin-bottom: 15px; }
        
        textarea { width: 100%; height: 100px; background: #000; color: #fff; border: 1px solid #333; border-radius: 8px; padding: 10px; box-sizing: border-box; }
        .btn { padding: 10px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; width: 100%; margin-top: 10px; text-transform: uppercase; font-size: 10px; }
        .btn-main { background: var(--mariposa-hot); color: white; }
        
        .response-box { background: rgba(0,0,0,0.4); padding: 12px; border-radius: 8px; border-left: 4px solid var(--intel-gold); margin-top: 10px; font-size: 13px; line-height: 1.5; }
        .strategy-chip { background: var(--mariposa-pink); color: black; font-size: 9px; font-weight: 900; padding: 2px 8px; border-radius: 4px; margin-bottom: 5px; display: inline-block; }
        .action-tag { display: inline-block; font-size: 10px; font-weight: 900; padding: 2px 6px; border-radius: 4px; margin-bottom: 5px; }
        
        .dict-input { background: #000; border: 1px solid #333; color: white; padding: 5px; border-radius: 4px; font-size: 11px; width: 80px; }
        .chart-container { height: 180px; }
        .ip-badge { background: #333; color: var(--intel-gold); padding: 2px 8px; border-radius: 4px; font-family: monospace; font-size: 11px; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div style="font-family:'Playfair Display'; font-weight:900; color:var(--mariposa-pink); font-size: 1.3rem;">üå∫ MARIPOSA v29.6 OMNISCIENT</div>
        <div style="display:flex; align-items:center; gap:15px;">
            <div id="userIp" class="ip-badge">Detecting IP...</div>
            <button class="btn" onclick="exportCrisisReport()" style="width:auto; background:var(--critical); color:white; padding: 5px 15px; margin:0;">üö® CRISIS EXCEL</button>
            <button class="btn" onclick="exportData()" style="width:auto; background:#333; color:white; padding: 5px 15px; margin:0;">üì• MASTER EXCEL</button>
        </div>
    </nav>

    <div class="container">
        <div class="sidebar">
            <div class="card" style="border: 1px solid #444;">
                <h4 style="margin:0 0 5px 0; font-size:12px; color:var(--pos);">üü¢ LIVE SESSION MONITOR</h4>
                <div style="font-size: 10px; color: #888;">Active Node: <span id="sessionStatus" style="color:var(--white)">Local Authority</span></div>
            </div>

            <div class="card">
                <h4 style="margin:0 0 10px 0; font-size:12px; color:var(--intel-gold);">üß† SYNC KNOWLEDGE BASE</h4>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <input type="text" id="newWord" class="dict-input" placeholder="Term" style="flex:2">
                    <select id="newWeight" class="dict-input" style="flex:1">
                        <option value="-10">Negative</option>
                        <option value="10">Positive</option>
                    </select>
                    <button onclick="addKnowledge()" style="background:var(--intel-gold); border:none; border-radius:4px; cursor:pointer; padding:0 10px;">ADD</button>
                </div>
                <div id="dictDisplay" style="font-size:10px; color:#888; max-height:80px; overflow-y:auto; border: 1px solid #222; padding: 5px;"></div>
            </div>

            <div class="card">
                <h4 style="margin:0 0 10px 0; font-size:12px; color:var(--mariposa-pink);">üìä PAIN POINT DISTRIBUTION</h4>
                <div class="chart-container"><canvas id="barChart"></canvas></div>
            </div>

            <div class="card" style="border: 1px solid var(--voucher-blue)">
                <h4 style="margin:0 0 10px 0; color:var(--voucher-blue); font-size:12px;">üéüÔ∏è ACTIVE VOUCHERS</h4>
                <div style="font-size: 11px; margin-bottom: 5px;">Exposure: <b id="estExposure" style="color:var(--pos)">‚Ç±0</b></div>
                <div style="max-height: 100px; overflow-y: auto;"><table id="voucherTable" style="width:100%; font-size:10px;"></table></div>
            </div>

            <div class="card">
                <span style="font-size: 10px; color: #666;">BULK INTAKE (One review per line)</span>
                <textarea id="reviewInput" placeholder="Paste reviews here..."></textarea>
                <button class="btn btn-main" onclick="processIntake()">‚ö° ANALYZE WITH COMPREHENSION</button>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <h4 style="margin:0 0 10px 0; font-size:12px; color:var(--mariposa-pink);">üìà SENTIMENT TREND</h4>
                <div class="chart-container"><canvas id="lineChart"></canvas></div>
            </div>
            <div id="historyList"></div>
        </div>
    </div>

<script>
    let db = JSON.parse(localStorage.getItem('mariposa_v29_db')) || [];
    let vouchers = JSON.parse(localStorage.getItem('mariposa_v29_vouchers')) || [];
    
    // Requirement 1: 100+ Pre-loaded Slang Terms (Tagalog/Bisaya)
    const slangLibrary = {
        // Clinical/Skin (Negative)
        "nangatol":-15, "sunog":-15, "kati":-10, "hapdi":-15, "pula":-10, "mahapdi":-12, "makati":-10, "irritated":-12, "tiyawat":-8, "butlig":-10, "namamalat":-12,
        // Logistics/Quality (Negative)
        "basag":-15, "tapon":-12, "leak":-12, "pait":-10, "way lami":-12, "bati":-15, "sablay":-10, "scam":-20, "fake":-20, "budol":-15, "mali":-10, "kuwang":-12, "tagal":-10, "langaw":-10, "yupi":-8, "bulok":-15, "sayang":-12, "lugi":-12, "durog":-12, "amoy":-8, "baho":-10, "expired":-15, "nakaabukas":-10,
        // Sarcasm/Irony (Negative contexts)
        "grabe":-5, "ayos":-5, "galing":-5, "nice":-5, "responsive daw":-15, "wow":-5, "thank you sa wala":-20, "best seller pa naman":-15, "napakabilis":-5, "bilis":-5,
        // Positive Slang
        "sulit":10, "hiyang":15, "mabango":10, "smooth":10, "effective":15, "lodi":10, "petmalu":10, "dasurb":10, "fresh":10, "kinis":15, "glow":15, "orig":10, "sealed":8, "balot":8, "safe":10, "legit":15, "pa-order":8, "repeat":10, "love":12, "ganda":12, "nindot":15, "gwapa":10, "barato":8
    };

    let knowledge = JSON.parse(localStorage.getItem('mariposa_kb')) || slangLibrary;
    let lineChart, barChart;

    // Detect IP Function
    async function detectIP() {
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            const data = await response.json();
            document.getElementById('userIp').innerText = "IP: " + data.ip;
        } catch (e) {
            document.getElementById('userIp').innerText = "IP: Protected/Offline";
        }
    }

    function addKnowledge() {
        const word = document.getElementById('newWord').value.toLowerCase().trim();
        const weight = parseInt(document.getElementById('newWeight').value);
        if(word) { knowledge[word] = weight; localStorage.setItem('mariposa_kb', JSON.stringify(knowledge)); renderKB(); }
    }

    function renderKB() {
        document.getElementById('dictDisplay').innerHTML = Object.keys(knowledge).map(k => `<span>${k}</span>`).join(', ');
    }

    function analyzeText(text) {
        const low = text.toLowerCase();
        let score = 0;
        
        Object.keys(knowledge).forEach(k => { if(low.includes(k)) score += knowledge[k]; });

        const negTerms = ['hapdi', 'basag', 'tapon', 'fake', 'scam', 'tagal', 'rash', 'pula', 'mali', 'nangatol', 'sunog', 'bati', 'sayang'];
        const sarcTriggers = ['wow', 'galing', 'ayos ha', 'thank you sa wala', 'responsive daw', 'best seller pa naman', 'napakabilis'];
        
        if(low.includes('masarap')) score += 10;

        let containsIrony = sarcTriggers.some(s => low.includes(s)) && (negTerms.some(n => low.includes(n)) || low.includes('mali') || low.includes('1 week') || low.includes('sira'));
        if(containsIrony) score = -25;

        const isClin = /hapdi|nangatol|sunog|rash|irritation|kati|tiyawat|butlig/i.test(low);
        const isLog = /tagal|shipping|basag|mali|rider|box|leak|yupi|kuwang/i.test(low);

        let strategy = "General Engagement";
        let action = "üí¨ NEUTRAL FEEDBACK";
        let suggest = "Hi! Thank you for the feedback. How can we make your experience better? ‚ù§Ô∏è";

        if(score > 0) {
            strategy = "RETENTION STRATEGY";
            action = "üåü POSITIVE REVIEW";
            suggest = "Wow! We are so happy na hiyang ka. Looking forward to your next glow-up session! ‚ú®";
        } else if(score < 0) {
            strategy = "DAMAGE CONTROL";
            if(isClin) {
                action = "üö® CLINICAL PROTOCOL";
                suggest = `Naku, deeply sorry to hear about the reaction. Please STOP use immediately and rinse with water. This isn't the experience we want for you. DM us so we can process your refund right away.`;
            } else if(isLog) {
                action = "üì¶ LOGISTICS DISPUTE";
                const itemIssue = low.includes('mali') ? "wrong item/color" : (low.includes('basag') ? "broken bottle" : "delivery speed");
                suggest = `Pasensya na po sa nangyari regarding the ${itemIssue}. This is definitely a logistics error. Please send us a photo of the waybill so we can replace this immediately!`;
            } else if(containsIrony) {
                action = "‚ö†Ô∏è SARCASM DETECTED";
                suggest = "We hear your frustration clearly. This is not the standard we set. Please let us make it right‚ÄîDM us your order details so we can investigate the delay/error.";
            }
        }

        return { text, score, sentiment: score > 0 ? "Positive" : (score < 0 ? "Negative" : "Neutral"), action, strategy, suggest, isClin, isLog };
    }

    function processIntake() {
        const input = document.getElementById('reviewInput').value.trim();
        if(!input) return;
        input.split('\n').filter(l => l.trim() !== "").forEach(text => {
            const res = analyzeText(text);
            db.push({ ...res, id: Date.now() + Math.random(), timestamp: new Date().toLocaleString(), vIssued: false });
        });
        document.getElementById('reviewInput').value = '';
        saveData();
    }

    function render() {
        document.getElementById('historyList').innerHTML = db.slice().reverse().map(i => `
            <div class="card" style="border-left: 6px solid ${i.score > 0 ? 'var(--pos)' : (i.score < 0 ? 'var(--critical)' : '#555')}">
                <div style="display:flex; justify-content:space-between;">
                    <div>
                        <span class="strategy-chip">${i.strategy}</span><br>
                        <span class="action-tag" style="color:${i.score < 0 ? 'var(--critical)' : 'var(--pos)'}">${i.action}</span>
                        <p style="margin:5px 0; font-weight:700;">"${i.text}"</p>
                    </div>
                    <button onclick="deleteItem(${i.id})" style="background:none; border:none; color:#444; cursor:pointer;">üóëÔ∏è</button>
                </div>
                <div class="response-box">
                    <b style="color:var(--intel-gold); font-size:10px;">COMPREHENSION-BASED REPLY:</b><br>${i.suggest}
                </div>
                <div style="margin-top:10px;">
                    ${(i.score < 0 && !i.vIssued) ? `<button class="btn" style="background:var(--voucher-blue); width:auto; padding:5px 10px;" onclick="issueVoucher(${i.id})">üé´ ISSUE VOUCHER</button>` : ''}
                </div>
            </div>
        `).join('');

        document.getElementById('estExposure').innerText = '‚Ç±' + (vouchers.length * 50);
        document.getElementById('voucherTable').innerHTML = vouchers.map(v => `<tr><td>${v.code}</td><td style="text-align:right;"><button style="background:var(--critical); border:none; border-radius:3px; color:white; font-size:8px; cursor:pointer;" onclick="clearVoucher(${v.id})">CLEAR</button></td></tr>`).join('');
        updateCharts();
    }

    function updateCharts() {
        if(lineChart) lineChart.destroy();
        if(barChart) barChart.destroy();
        const slice = db.slice(-10);
        lineChart = new Chart(document.getElementById('lineChart'), {
            type: 'line',
            data: { labels: slice.map(i => i.timestamp.split(',')[1]), datasets: [{ data: slice.map(i => i.score), borderColor: '#ff85a2', tension: 0.3 }] },
            options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
        const counts = [db.filter(i => i.isClin).length, db.filter(i => i.isLog).length, db.filter(i => i.score < 0 && !i.isClin && !i.isLog).length];
        barChart = new Chart(document.getElementById('barChart'), {
            type: 'bar',
            data: { labels: ['Skin', 'Logistics', 'Quality'], datasets: [{ data: counts, backgroundColor: ['#ff4757', '#8e44ad', '#f1c40f'] }] },
            options: { indexAxis: 'y', maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    function issueVoucher(id) {
        const item = db.find(i => i.id === id);
        if(item) { item.vIssued = true; vouchers.push({ id: Date.now(), code: 'MAR-'+Math.floor(Math.random()*9999) }); saveData(); }
    }
    function clearVoucher(id) { vouchers = vouchers.filter(v => v.id !== id); saveData(); }
    function deleteItem(id) { db = db.filter(i => i.id !== id); saveData(); }
    function saveData() { 
        localStorage.setItem('mariposa_v29_db', JSON.stringify(db)); 
        localStorage.setItem('mariposa_v29_vouchers', JSON.stringify(vouchers)); 
        render(); 
    }
    function exportCrisisReport() {
        const data = db.filter(i => i.score < 0).map(i => ({ Review: i.text, Strategy: i.strategy, Suggested_Reply: i.suggest }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Crisis");
        XLSX.writeFile(wb, "Mariposa_Crisis.xlsx");
    }
    function exportData() {
        const ws = XLSX.utils.json_to_sheet(db);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Master");
        XLSX.writeFile(wb, "Mariposa_Master.xlsx");
    }

    detectIP();
    renderKB();
    saveData();
</script>
</body>
</html>

