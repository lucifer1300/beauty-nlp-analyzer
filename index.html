<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mariposa Titanium v6.3</title>
    <style>
        :root {
            --bg: #0f172a; --panel: #1e293b; --border: #334155;
            --text: #f8fafc; --text-muted: #94a3b8;
            --primary: #3b82f6; --secondary: #64748b;
            --accent: #f59e0b; --danger: #ef4444; --danger-bg: rgba(239, 68, 68, 0.1);
            --success: #10b981;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 20px; font-size: 14px; }
        
        /* Layout Grid */
        .grid { display: grid; grid-template-columns: 280px 1fr; gap: 20px; height: 95vh; }
        .sidebar { display: flex; flex-direction: column; gap: 20px; }
        .main { display: flex; flex-direction: column; gap: 20px; overflow: hidden; }

        /* Cards */
        .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 15px; }
        .stat-card { text-align: center; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; }
        .stat-num { font-size: 1.5rem; font-weight: 800; display: block; }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

        /* Typography */
        h2 { margin: 0 0 15px 0; font-size: 1.1rem; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        
        /* Forms & Buttons */
        textarea, input, select { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 10px; border-radius: 6px; resize: none; }
        textarea:focus, input:focus { outline: 1px solid var(--primary); border-color: var(--primary); }
        
        .btn { border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.8rem; transition: 0.2s; width: 100%; text-align: center; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-row { display: flex; gap: 10px; margin-top: 10px; }

        /* Data Table */
        .feed-container { flex: 1; overflow-y: auto; border: 1px solid var(--border); border-radius: 12px; background: var(--panel); }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; background: rgba(0,0,0,0.3); color: var(--text-muted); font-size: 0.75rem; position: sticky; top: 0; backdrop-filter: blur(5px); }
        td { padding: 12px; border-bottom: 1px solid var(--border); vertical-align: top; }
        tr:hover { background: rgba(255,255,255,0.02); }

        /* Badges & Strategy */
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; display: inline-block; margin-right: 4px; }
        .badge-red { background: rgba(239, 68, 68, 0.2); color: #fca5a5; border: 1px solid var(--danger); }
        .badge-blue { background: rgba(59, 130, 246, 0.2); color: #93c5fd; border: 1px solid var(--primary); }
        .badge-gray { background: #334155; color: #cbd5e1; }
        
        .strategy-box { background: rgba(0,0,0,0.2); padding: 8px; border-radius: 6px; border-left: 3px solid var(--accent); font-size: 0.85rem; color: #e2e8f0; line-height: 1.4; }
        .strategy-label { display: block; font-size: 0.65rem; color: var(--accent); font-weight: 800; margin-bottom: 2px; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(4px); }
        .modal-overlay.open { display: flex; }
        .modal-card { background: var(--panel); width: 500px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.5); overflow: hidden; }
        .modal-header { padding: 15px; background: rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }

        /* Toggles */
        .toggle-switch { display: flex; align-items: center; gap: 10px; font-size: 0.8rem; cursor: pointer; color: var(--text-muted); }
        .toggle-switch.active { color: var(--accent); }
    </style>
</head>
<body>

<div class="grid">
    <div class="sidebar">
        <div class="card">
            <h1 style="font-size:1.2rem; margin:0; color:var(--primary);">ü¶ã Mariposa <span style="font-weight:300">Titanium</span></h1>
            <div style="font-size:0.7rem; color:var(--text-muted); margin-top:5px;">Version 6.3 ‚Ä¢ Team ID: <span id="teamIdDisplay">...</span></div>
        </div>

        <div class="card">
            <h2>üìä Real-time Analytics</h2>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                <div class="stat-card"><span class="stat-num" style="color:var(--text)" id="stat-total">0</span><span class="stat-label">Total</span></div>
                <div class="stat-card"><span class="stat-num" style="color:var(--danger)" id="stat-critical">0</span><span class="stat-label">High Risk</span></div>
                <div class="stat-card"><span class="stat-num" style="color:var(--accent)" id="stat-neg">0%</span><span class="stat-label">Negativity</span></div>
                <div class="stat-card"><span class="stat-num" style="color:var(--success)" id="stat-hiyang">0</span><span class="stat-label">"Hiyang"</span></div>
            </div>
            <div id="viz-bars"></div>
        </div>

        <div class="card">
            <h2>‚ö° Control Center</h2>
            <button class="btn btn-primary" onclick="app.ui.toggleModal('importModal')" style="margin-bottom:10px;">üì• Import Feedback</button>
            <div class="btn-row">
                <button class="btn btn-secondary" onclick="app.io.exportCSV()">üìÑ Export CSV</button>
                <button class="btn btn-secondary" onclick="app.io.exportJSON()">üíæ Backup</button>
            </div>
            <div class="btn-row">
                 <button class="btn btn-secondary" style="border:1px solid var(--danger); background:transparent; color:var(--danger);" onclick="app.db.wipe()">üóë Wipe Data</button>
            </div>
        </div>

        <div class="card" style="padding:10px;">
            <div class="toggle-switch" id="archiveToggle" onclick="app.ui.toggleArchiveView()">
                <div style="width:10px; height:10px; background:currentColor; border-radius:50%;"></div>
                <span>View Archived (Trash)</span>
            </div>
        </div>
    </div>

    <div class="main">
        <div style="display:flex; gap:10px;">
            <input type="text" id="globalSearch" placeholder="üîç Search feedback, IDs, or categories..." onkeyup="app.ui.renderFeed()">
        </div>
        
        <div class="feed-container">
            <table>
                <thead>
                    <tr>
                        <th width="120">ID / Origin</th>
                        <th>Analysis & Context</th>
                        <th width="35%">AI Strategy</th>
                        <th width="120">Actions</th>
                    </tr>
                </thead>
                <tbody id="feedBody">
                    </tbody>
            </table>
        </div>
        <div id="viz-cloud" style="height:60px; overflow:hidden; opacity:0.5; font-size:0.8rem; white-space:nowrap;"></div>
    </div>
</div>

<div id="importModal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-header">
            <span style="font-weight:700">üì• Import Batch Data</span>
            <button class="btn btn-secondary" style="width:auto; padding:2px 8px;" onclick="app.ui.toggleModal('importModal')">‚úï</button>
        </div>
        <div style="padding:20px;">
            <textarea id="importText" rows="10" placeholder="Paste customer feedback here (one per line)..."></textarea>
            <div class="btn-row">
                <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">üìÇ Load JSON File</button>
                <input type="file" id="fileInput" hidden onchange="app.io.importJSON(this)">
                <button class="btn btn-primary" onclick="app.core.processBatch()">üöÄ Analyze Batch</button>
            </div>
        </div>
    </div>
</div>

<div id="teachModal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-header">
            <span style="font-weight:700">üéì Teach Titanium AI</span>
            <button class="btn btn-secondary" style="width:auto; padding:2px 8px;" onclick="app.ui.toggleModal('teachModal')">‚úï</button>
        </div>
        <div style="padding: 25px;">
            <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:15px;">
                Define a word or phrase that the AI misunderstood. This will add a permanent rule.
            </p>
            
            <label style="font-size:0.8rem; font-weight:700;">Word/Phrase to Learn</label>
            <input type="text" id="teachWordInput" style="margin-bottom:15px;" placeholder="e.g., awit, luh, goods">

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                <div>
                    <label style="font-size:0.8rem; font-weight:700;">Sentiment</label>
                    <select id="teachSentInput">
                        <option value="Positive">Positive</option>
                        <option value="Negative">Negative</option>
                        <option value="Neutral">Neutral</option>
                    </select>
                </div>
                <div>
                    <label style="font-size:0.8rem; font-weight:700;">Category</label>
                    <select id="teachCatInput">
                        <option value="Quality">Quality</option>
                        <option value="Logistics">Logistics</option>
                        <option value="Clinical">Clinical</option>
                        <option value="Service">Service</option>
                    </select>
                </div>
            </div>

            <label style="font-size:0.8rem; font-weight:700;">Risk Level</label>
            <select id="teachRiskInput" style="margin-bottom:20px;">
                <option value="Low">Low (Standard)</option>
                <option value="Mid">Mid (Caution)</option>
                <option value="High">High (Critical Alert)</option>
            </select>

            <button class="btn btn-primary" onclick="app.ui.confirmTeach()">üíæ Save Rule & Re-Analyze</button>
        </div>
    </div>
</div>

<script>
/**
 * MARIPOSA TITANIUM ENGINE v6.3
 */
const AppConfig = { storeKey: "MP_TITANIUM_V6", rulesKey: "MP_RULES_V6", teamKey: "MP_TEAM_ID" };

const app = {
    utils: {
        genID: () => 'R-' + Math.random().toString(36).substr(2, 6).toUpperCase(),
        getTeamID: () => {
            let id = localStorage.getItem(AppConfig.teamKey);
            if (!id) { id = 'NODE-' + Math.floor(Math.random()*10000); localStorage.setItem(AppConfig.teamKey, id); }
            return id;
        },
        maskPII: (text) => text.replace(/(\+63|0)9\d{9}/g, '[PHONE-MASKED]').replace(/[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}/g, '[EMAIL-MASKED]')
    },

    nlp: {
        customRules: {}, 
        loadRules: () => { const stored = localStorage.getItem(AppConfig.rulesKey); if(stored) app.nlp.customRules = JSON.parse(stored); },
        saveRule: (word, sentiment, category, risk) => {
            const key = word.toLowerCase().trim();
            let score = 0;
            if(sentiment === 'Positive') score = 4;
            if(sentiment === 'Negative') score = -4;
            app.nlp.customRules[key] = { s: score, c: category, risk: risk, isCustom: true };
            localStorage.setItem(AppConfig.rulesKey, JSON.stringify(app.nlp.customRules));
            alert(`üß† AI Learned: "${key}" is now ${sentiment}/${category}.`);
            app.core.reprocessAll();
        },
        stem: (word) => {
            if(word.length < 4) return word;
            let stem = word;
            if(stem.startsWith('pinaka')) stem = stem.slice(6);
            else if(stem.startsWith('naka') || stem.startsWith('nag') || stem.startsWith('mag')) stem = stem.slice(3);
            else if(stem.startsWith('um') || stem.startsWith('ma') || stem.startsWith('pa') || stem.startsWith('ka')) stem = stem.slice(2);
            stem = stem.replace(/um|in/g, '');
            if(stem.endsWith('han') || stem.endsWith('hin')) stem = stem.slice(0, -3);
            else if(stem.endsWith('an') || stem.endsWith('in') || stem.endsWith('ng')) stem = stem.slice(0, -2);
            return stem.split('-')[0];
        },
        lexicon: {
            'effective':{s:3,c:'Quality'},'ganda':{s:3,c:'Quality'},'kinis':{s:4,c:'Quality'},'puti':{s:2,c:'Quality'},'lambot':{s:3,c:'Quality'},
            'bango':{s:2,c:'Quality'},'hiyang':{s:5,c:'Quality'},'legit':{s:4,c:'Quality'},'bilis':{s:3,c:'Logistics'},'secure':{s:2,c:'Packaging'},
            'bait':{s:3,c:'Service'},'love':{s:4,c:'Quality'},'fake':{s:-5,c:'Trust',risk:'High'},'scam':{s:-5,c:'Trust',risk:'High'},
            'expired':{s:-5,c:'Quality',risk:'High'},'baho':{s:-3,c:'Quality'},'tagal':{s:-3,c:'Logistics'},'bagal':{s:-3,c:'Logistics'},
            'yupi':{s:-2,c:'Packaging'},'basag':{s:-4,c:'Packaging'},'tapon':{s:-4,c:'Packaging'},'bastos':{s:-4,c:'Service'},'sungit':{s:-3,c:'Service'},
            'wrong':{s:-3,c:'Logistics'},'kulang':{s:-3,c:'Logistics'},'hapdi':{s:-4,c:'Clinical',risk:'Mid',advice:'Rinse with cold water.'},
            'kati':{s:-3,c:'Clinical',risk:'Mid',advice:'Observe.'},'namaga':{s:-5,c:'Clinical',risk:'High',advice:'Medical attention needed.'},
            'sugat':{s:-5,c:'Clinical',risk:'High',advice:'Stop use.'},'burn':{s:-5,c:'Clinical',risk:'High',advice:'Chemical burn alert.'},
            'breakout':{s:-3,c:'Clinical',risk:'Mid',advice:'Pause 3 days.'}
        },
        negators: ['hindi','di','not','wag','huwag','dont','wala','ayaw','no','never'],
        intensifiers: ['sobra','grabe','super','napaka','very','too'],
        tokenize: (text) => text.toLowerCase().replace(/[^a-z0-9\s]/g, ' ').split(/\s+/).filter(w => w.length > 0)
    },

    core: {
        analyze: (rawText) => {
            const maskedText = app.utils.maskPII(rawText);
            const tokens = app.nlp.tokenize(maskedText);
            let score = 0, category = 'General', risk = 'Low', detectedKeywords = [], advice = null, isClinical = false;

            for (let i = 0; i < tokens.length; i++) {
                const word = tokens[i];
                const stem = app.nlp.stem(word);
                const prev = i > 0 ? tokens[i-1] : "";
                const isNegated = app.nlp.negators.includes(prev);
                const isIntense = app.nlp.intensifiers.includes(prev);
                let multiplier = isNegated ? -1 : 1;
                if (isIntense) multiplier *= 1.5;

                let term = app.nlp.customRules[word] || app.nlp.customRules[stem] || app.nlp.lexicon[word] || app.nlp.lexicon[stem];
                if (term) {
                    score += term.s * multiplier;
                    detectedKeywords.push(word);
                    if (term.c === 'Clinical') { category = 'Clinical'; isClinical = true; if(term.advice) advice = term.advice; }
                    else if (!isClinical && term.c !== 'General') category = term.c;
                    if (term.risk === 'High') risk = 'High';
                    else if (term.risk === 'Mid' && risk !== 'High') risk = 'Mid';
                }
            }

            let sentiment = score > 1 ? 'Positive' : (score < -1 ? 'Negative' : 'Neutral');
            let strategy = app.core.generateStrategy(sentiment, category, risk, advice);

            return {
                id: app.utils.genID(), origin: app.utils.getTeamID(), date: new Date().toISOString(),
                text: maskedText, tokens: detectedKeywords, score: score.toFixed(1),
                sentiment: sentiment, category: category, risk: risk, advice: advice, strategy: strategy, archived: false
            };
        },
        generateStrategy: (sent, cat, risk, advice) => {
            if (risk === 'High') return `üö® <b>CRITICAL:</b> Immediate Stop Use. ${advice || 'Escalate.'}`;
            if (cat === 'Clinical') return `ü©∫ <b>Support:</b> "Sorry to hear that. ${advice || 'Rest skin.'}"`;
            if (cat === 'Logistics' && sent === 'Negative') return `üöö <b>Logistics:</b> Check courier. Issue Voucher.`;
            if (cat === 'Quality' && sent === 'Negative') return `üì¶ <b>Refund:</b> Ask for proof. Replace.`;
            if (sent === 'Positive') return `‚≠ê <b>Engage:</b> Thank enthusiastically!`;
            return `üí¨ <b>Standard:</b> Acknowledge & Ask.`;
        },
        processBatch: () => {
            const raw = document.getElementById('importText').value;
            if(!raw.trim()) return;
            raw.split('\n').filter(l => l.trim().length > 3).forEach(l => app.db.add(app.core.analyze(l)));
            document.getElementById('importText').value = '';
            app.ui.toggleModal('importModal');
            app.ui.renderFeed();
        },
        reprocessAll: () => {
            app.db.data = app.db.data.map(i => {
                let n = app.core.analyze(i.text);
                return { ...n, id: i.id, date: i.date, origin: i.origin, archived: i.archived };
            });
            app.db.save();
            app.ui.renderFeed();
        },
        actions: {
            sendVoucher: (id) => alert(`üéü Voucher sent to #${id}`),
            cancelOrder: (id) => { if(confirm('CANCEL order?')) alert(`üö´ Order #${id} Cancelled.`); },
            refundOrder: (id) => { if(confirm('Issue Refund?')) alert(`üí∏ Refunded #${id}`); }
        }
    },

    db: {
        data: [],
        init: () => {
            app.nlp.loadRules();
            const stored = localStorage.getItem(AppConfig.storeKey);
            if (stored) app.db.data = JSON.parse(stored);
            app.ui.renderFeed();
            document.getElementById('teamIdDisplay').innerText = app.utils.getTeamID();
        },
        add: (record) => { app.db.data.unshift(record); app.db.save(); },
        toggleArchive: (id) => {
            const item = app.db.data.find(i => i.id === id);
            if(item) { 
                item.archived = !item.archived; // Toggle status
                app.db.save(); 
                app.ui.renderFeed(); 
            }
        },
        save: () => { localStorage.setItem(AppConfig.storeKey, JSON.stringify(app.db.data)); app.ui.updateStats(); },
        wipe: () => { if(confirm("‚ö† DELETE ALL DATA?")) { app.db.data = []; app.db.save(); app.ui.renderFeed(); } }
    },

    ui: {
        showArchived: false,
        toggleModal: (id) => document.getElementById(id).classList.toggle('open'),
        toggleArchiveView: () => {
            app.ui.showArchived = !app.ui.showArchived;
            document.getElementById('archiveToggle').classList.toggle('active');
            app.ui.renderFeed();
        },
        openTeachModal: (word) => { document.getElementById('teachWordInput').value = word || ''; app.ui.toggleModal('teachModal'); },
        confirmTeach: () => {
            const w = document.getElementById('teachWordInput').value, s = document.getElementById('teachSentInput').value;
            const c = document.getElementById('teachCatInput').value, r = document.getElementById('teachRiskInput').value;
            if(!w) return alert("Enter a word");
            app.nlp.saveRule(w, s, c, r);
            app.ui.toggleModal('teachModal');
        },
        renderFeed: () => {
            const container = document.getElementById('feedBody');
            const search = document.getElementById('globalSearch').value.toLowerCase();
            container.innerHTML = '';

            app.db.data.forEach(item => {
                // Archive Logic: If ShowArchived is ON, show only archived. If OFF, show only active.
                if (app.ui.showArchived && !item.archived) return;
                if (!app.ui.showArchived && item.archived) return;
                
                if (search && !item.text.toLowerCase().includes(search) && !item.id.toLowerCase().includes(search)) return;

                let rowClass = item.risk === 'High' ? 'style="background:var(--danger-bg)"' : '';
                let riskBadge = item.risk !== 'Low' ? `<span class="badge badge-red">${item.risk} RISK</span>` : '';
                let tokensHtml = item.tokens.map(t => app.nlp.customRules[t] ? `<span style="color:var(--accent);font-weight:bold">${t}*</span>` : t).join(', ');

                // BUTTONS LOGIC
                let actionBtns = '';
                if(app.ui.showArchived) {
                    // Restore Button only
                    actionBtns = `<button class="btn btn-primary" onclick="app.db.toggleArchive('${item.id}')">‚ôª Restore</button>`;
                } else {
                    // Standard Actions
                    if (item.risk === 'High') {
                        actionBtns += `<button class="btn btn-danger" style="margin-bottom:4px" onclick="app.core.actions.cancelOrder('${item.id}')">üö´ Cancel</button>`;
                        actionBtns += `<button class="btn btn-secondary" style="margin-bottom:4px" onclick="app.core.actions.refundOrder('${item.id}')">üí∏ Refund</button>`;
                    } else if (item.sentiment === 'Negative' && (item.category === 'Logistics' || item.category === 'Service')) {
                        actionBtns += `<button class="btn btn-secondary" style="background:#475569; margin-bottom:4px" onclick="app.core.actions.sendVoucher('${item.id}')">üéü Voucher</button>`;
                    }
                    actionBtns += `<button class="btn btn-primary" style="margin-top:4px" onclick="app.ui.openTeachModal('${item.tokens[0] || ''}')">üéì Teach</button>`;
                    actionBtns += `<button class="btn btn-secondary" style="margin-top:4px" onclick="app.db.toggleArchive('${item.id}')">üìÇ Archive</button>`;
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td ${rowClass}><strong>${item.id}</strong><div style="font-size:0.7rem;opacity:0.6">${item.origin === app.utils.getTeamID() ? 'ME' : 'TEAM'}</div></td>
                    <td ${rowClass}><div style="margin-bottom:6px">"${item.text}"</div>${riskBadge} <span class="badge badge-blue">${item.category}</span> <span class="badge badge-gray">${item.sentiment}</span><div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px">Keys: ${tokensHtml}</div></td>
                    <td ${rowClass}><div class="strategy-box"><span class="strategy-label">STRATEGY</span>${item.strategy}</div></td>
                    <td ${rowClass}>${actionBtns}</td>
                `;
                container.appendChild(tr);
            });
            app.ui.updateStats();
            app.viz.drawBars();
        },
        updateStats: () => {
            let stats = { high:0, neg:0, total:0, hiyang:0 };
            app.db.data.forEach(i => {
                if(i.archived) return;
                stats.total++;
                if(i.risk === 'High') stats.high++;
                if(i.sentiment === 'Negative') stats.neg++;
                if(i.tokens.includes('hiyang')) stats.hiyang++;
            });
            document.getElementById('stat-total').innerText = stats.total;
            document.getElementById('stat-critical').innerText = stats.high;
            document.getElementById('stat-hiyang').innerText = stats.hiyang;
            document.getElementById('stat-neg').innerText = (stats.total > 0 ? Math.round((stats.neg / stats.total) * 100) : 0) + "%";
        }
    },
    viz: {
        drawBars: () => {
            const container = document.getElementById('viz-bars');
            let counts = {};
            app.db.data.forEach(i => { if(!i.archived) counts[i.category] = (counts[i.category] || 0) + 1; });
            let html = '', max = Math.max(...Object.values(counts), 1);
            Object.keys(counts).sort((a,b) => counts[b] - counts[a]).forEach(cat => {
                let pct = (counts[cat] / max) * 100;
                let color = cat === 'Clinical' ? 'var(--danger)' : 'var(--primary)';
                html += `<div style="display:flex;align-items:center;margin-bottom:5px;font-size:0.8rem;"><div style="width:80px;">${cat}</div><div style="flex:1;background:var(--border);height:6px;border-radius:3px;"><div style="width:${pct}%;height:100%;background:${color}"></div></div><div style="width:30px;text-align:right">${counts[cat]}</div></div>`;
            });
            container.innerHTML = html;
        },
        drawCloud: () => {
             // Simple placeholder cloud
             const container = document.getElementById('viz-cloud');
             let tokens = {};
             app.db.data.forEach(i => { if(!i.archived) i.tokens.forEach(t => tokens[t] = (tokens[t] || 0) + 1); });
             container.innerHTML = Object.keys(tokens).slice(0,15).map(w => `<span style="margin:0 5px">${w}</span>`).join('');
        }
    },
    io: {
        exportJSON: () => {
            const blob = new Blob([JSON.stringify(app.db.data)], {type: "application/json"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Titanium_Data_${app.utils.getTeamID()}.json`; a.click();
        },
        importJSON: (input) => {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const incoming = JSON.parse(e.target.result);
                    incoming.forEach(n => { if(!app.db.data.find(e => e.id === n.id)) app.db.data.push(n); });
                    app.db.save(); alert(`Merged data successfully.`); app.ui.renderFeed();
                } catch(err) { alert("Invalid JSON"); }
            };
            reader.readAsText(file);
        },
        exportCSV: () => {
            let csv = "ID,Text,Category,Risk\n" + app.db.data.filter(i=>!i.archived).map(i => `${i.id},"${i.text.replace(/"/g,'""')}",${i.category},${i.risk}`).join('\n');
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv],{type:"text/csv"})); a.download = "Report.csv"; a.click();
        }
    }
};

window.onload = () => app.db.init();
</script>
</body>
</html>

