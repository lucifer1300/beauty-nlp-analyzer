<div class="control-center" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
    <button onclick="processBulkSentiments()" class="btn-main" style="background: var(--pink); border:none; padding:10px 15px; border-radius:5px; cursor:pointer; color:white;">ðŸ“¥ Bulk Import (500+)</button>
    <button onclick="exportReport()" class="btn-main" style="background: var(--neon-blue); border:none; padding:10px 15px; border-radius:5px; cursor:pointer; color:white;">ðŸ“Š Export CSV Report</button>
    <button onclick="shareProject()" class="btn-main" style="background: #2ed573; border:none; padding:10px 15px; border-radius:5px; cursor:pointer; color:white;">ðŸ”— Share Project ID</button>
    <button onclick="switchProject()" class="btn-main" style="background: #ffa502; border:none; padding:10px 15px; border-radius:5px; cursor:pointer; color:white;">ðŸ”„ Switch Project</button>
    <div id="projectBadge" style="padding: 8px 12px; border: 1px solid var(--pink); border-radius: 5px; color: var(--pink); font-family: 'Courier New', monospace; font-weight: bold; font-size: 0.9rem;">
        ID: <span id="currentProjectId">---</span>
    </div>
</div>

<script>
    // --- CORE COLLABORATION & ID LOGIC ---
    let serverId = initProjectID();

    function initProjectID() {
        const urlParams = new URLSearchParams(window.location.search);
        const sharedId = urlParams.get('project'); 
        const localId = localStorage.getItem('mariposa_active_id');
        let finalId = sharedId || localId || ('MP-' + Math.random().toString(36).substr(2, 9).toUpperCase());
        
        localStorage.setItem('mariposa_active_id', finalId);
        // Sync URL with the ID
        window.history.replaceState({}, document.title, window.location.pathname + "?project=" + finalId);
        return finalId;
    }

    // --- ACCURACY-ENHANCED NEURAL LOGIC (Optimized for 500+ Bulk Analysis) ---
    function analyzeText(text) {
        // Deep Normalization & Typos Correction
        let normalized = text.toLowerCase().trim();
        const transMap = { 
            "mabango": "pleasant scent", "mahapdi": "stings burning", "sulit": "value", 
            "maganda": "excellent", "budol": "scam", "fake": "counterfeit",
            "effective": "works well", "recomended": "recommended" 
        };
        Object.keys(transMap).forEach(key => normalized = normalized.replace(new RegExp(`\\b${key}\\b`, 'g'), transMap[key]));

        // Weighted Sentiment Scoring
        const lexicon = {
            "holy grail": 5, "pigmented": 4, "glass skin": 4, "glow": 3, "dupe": 3,
            "cakey": -5, "breakout": -5, "oxidized": -4, "patchy": -4, "greasy": -3, 
            "stings": -4, "scam": -5, "authentic": 4, "waste": -4, "leaking": -4
        };
        
        let score = 0;
        const words = normalized.split(/\s+/);
        let isNegated = false;

        words.forEach((word, index) => {
            const clean = word.replace(/[.,!]/g, '');
            // Negation Detection (Flips sentiment)
            if (['not', 'never', 'no', 'isnt', 'dont', "n't", "barely"].some(n => clean.includes(n))) {
                isNegated = true;
                return;
            }

            let wordScore = 0;
            for (let term in lexicon) {
                if (normalized.includes(term) && index === words.indexOf(term.split(' ')[0])) wordScore = lexicon[term];
            }
            if (['love', 'good', 'great', 'fast', 'best'].includes(clean)) wordScore = 2;
            if (['bad', 'slow', 'worst', 'rude', 'late'].includes(clean)) wordScore = -2;

            if (isNegated && wordScore !== 0) {
                wordScore = wordScore * -1.5; 
                isNegated = false; 
            }
            score += wordScore;
        });

        // Business Categorization
        let category = "Quality";
        if (normalized.match(/delivery|rider|shipping|received|courier|parcel|box/)) category = "Logistics";
        if (normalized.match(/skin|face|acne|breakout|rash|sting|irritation|pore/)) category = "Skin";
        if (normalized.match(/attitude|polite|rude|shouted|rider|driver|chat/)) category = "Riders' Conduct";

        let sentiment = score > 1.5 ? "Positive" : (score < -1 ? "Negative" : "Neutral");
        
        // Strategic Recovery Logic
        const strategyMap = {
            "Negative_Skin": "ðŸš¨ RECOVERY: Potential Allergic Reaction. Action: Stop use advice + Full Refund.",
            "Negative_Quality": "ðŸ›  RECOVERY: Quality Audit. Action: Offer replacement + 25% Discount Voucher.",
            "Negative_Logistics": "ðŸ“¦ RECOVERY: Shipping Escalation. Action: Refund shipping fee + Priority on next order.",
            "Positive_Quality": "âœ¨ CONVERSION: Loyal Customer. Action: Invite to Affiliate Program / Request Video Review.",
            "Neutral_Quality": "ðŸ’¡ RETENTION: Usage Guide needed. Action: Send 'Best Results' infographic."
        };

        return { 
            sentiment, category, score, 
            translated: normalized, 
            strategy: strategyMap[`${sentiment}_${category}`] || "Monitor Engagement.",
            response: sentiment === "Negative" ? "We sincerely apologize. We've prepared a recovery solution for you!" : "Thank you for the support! âœ¨"
        };
    }

    // --- BULK TOOLS & EXPORT ---
    function processBulkSentiments() {
        const rawInput = prompt("PASTE BULK SENTIMENTS (Up to 500 lines):");
        if (!rawInput) return;

        const lines = rawInput.split('\n').filter(l => l.trim().length > 3);
        const history = JSON.parse(localStorage.getItem(`db_${serverId}`)) || [];
        
        lines.slice(0, 500).forEach(text => {
            const result = analyzeText(text);
            history.push({
                text, sentiment: result.sentiment, category: result.category,
                score: result.score, translated: result.translated,
                strategy: result.strategy, response: result.response,
                timestamp: new Date().toLocaleString(), vouchered: false
            });
        });

        localStorage.setItem(`db_${serverId}`, JSON.stringify(history));
        refreshDashboard();
        alert(`Success! Analyzed ${Math.min(lines.length, 500)} items in Project ${serverId}`);
    }

    function exportReport() {
        const history = JSON.parse(localStorage.getItem(`db_${serverId}`)) || [];
        if (!history.length) return alert("No data to export.");

        let csv = "Timestamp,Original Text,Cleaned Text,Category,Sentiment,Score,Action Strategy\n";
        history.forEach(r => {
            csv += `"${r.timestamp}","${r.text.replace(/"/g,'') }","${r.translated.replace(/"/g,'') }","${r.category}","${r.sentiment}","${r.score}","${r.strategy}"\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('href', url);
        a.setAttribute('download', `Analysis_Report_${serverId}.csv`);
        a.click();
    }

    function shareProject() {
        const url = window.location.origin + window.location.pathname + '?project=' + serverId;
        navigator.clipboard.writeText(url);
        alert("ðŸ”— Project Link Copied! Share this with your team to collaborate.");
    }

    function switchProject() {
        const id = prompt("Enter Project ID to load/create:");
        if (id) {
            localStorage.setItem('mariposa_active_id', id.toUpperCase().trim());
            window.location.href = window.location.origin + window.location.pathname + '?project=' + id.toUpperCase().trim();
        }
    }

    // --- DASHBOARD RENDERER ---
    function refreshDashboard() {
        const idDisplay = document.getElementById('currentProjectId');
        if(idDisplay) idDisplay.innerText = serverId;

        const history = JSON.parse(localStorage.getItem(`db_${serverId}`)) || [];
        const rBody = document.getElementById('resultsBody');
        if(!rBody) return;

        rBody.innerHTML = '';
        let counts = { "Skin": 0, "Logistics": 0, "Riders' Conduct": 0, "Quality": 0 };

        history.slice().reverse().forEach((item) => {
            if(counts[item.category] !== undefined) counts[item.category]++;
            const border = item.sentiment === 'Negative' ? '#ff4757' : (item.sentiment === 'Positive' ? '#2ed573' : '#f1c40f');

            rBody.innerHTML += `
                <div class="card" style="border-left: 6px solid ${border}; padding: 15px; background: rgba(255,255,255,0.03); margin-bottom: 15px; border-radius: 8px;">
                    <div style="display:flex; justify-content:space-between; font-size: 0.75rem; opacity: 0.7;">
                        <span><b>${item.sentiment.toUpperCase()}</b> | ${item.category}</span>
                        <span>${item.timestamp}</span>
                    </div>
                    <p style="margin: 10px 0; font-size: 0.95rem;">"${item.text}"</p>
                    <div style="background: rgba(0,0,0,0.25); padding: 10px; border-radius: 5px; border-left: 3px solid var(--pink);">
                        <small style="color: var(--pink); font-weight: bold;">HOST STRATEGY:</small><br>
                        <span style="font-size: 0.85rem;">${item.strategy}</span>
                    </div>
                </div>`;
        });
        
        // Sync stats with your existing UI counters
        Object.keys(counts).forEach(key => {
            const elId = `stat${key.split("'")[0].replace(/\s/g, '')}`;
            const el = document.getElementById(elId);
            if(el) el.innerText = counts[key];
        });
    }

    window.onload = refreshDashboard;
</script>

