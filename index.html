<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARIPOSA v35.7 - HYBRID NEURAL MASTER</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --m-pink: #ff85a2; --m-hot: #d63384; --m-black: #0a0a0a; 
            --white: #ffffff; --critical: #ff4757; --pos: #2ed573; 
            --neutral: #747d8c; --voucher: #3b82f6; --gold: #f1c40f;
            --bg: var(--m-black); --card-bg: #141414; --text: var(--white);
        }
        body.light-mode { --bg: #f0f2f5; --card-bg: #ffffff; --text: #1c1e21; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; color: var(--text); transition: 0.3s; }
        .container { width: 100%; padding: 15px; box-sizing: border-box; display: grid; gap: 20px; grid-template-columns: 1fr; }
        @media (min-width: 1024px) { .container { grid-template-columns: 450px 1fr; } }
        
        .navbar { background: var(--m-black); padding: 15px 25px; border-bottom: 3px solid var(--m-hot); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .card { background: var(--card-bg); border-radius: 15px; padding: 20px; border: 1px solid rgba(255,133,162,0.15); margin-bottom: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        
        textarea, input, select { width: 100%; background: #000; color: var(--text); border: 1px solid #333; border-radius: 10px; padding: 12px; box-sizing: border-box; font-size: 13px; margin-bottom: 10px; font-family: inherit; }
        .btn { padding: 12px; border-radius: 10px; border: none; font-weight: 800; cursor: pointer; width: 100%; text-transform: uppercase; font-size: 11px; transition: 0.2s; }
        .btn-main { background: linear-gradient(45deg, var(--m-hot), #ff5e78); color: white; }
        
        .response-box { background: rgba(0,0,0,0.4); padding: 15px; border-radius: 10px; border-left: 5px solid var(--gold); margin-top: 10px; font-size: 13px; }
        .host-action-box { background: rgba(255,133,162,0.05); padding: 12px; border-radius: 10px; margin-top: 10px; border: 1px dashed var(--m-pink); font-size: 11px; color: var(--m-pink); }
        
        .kb-term { cursor: pointer; display: block; background: #222; padding: 10px; border-radius: 8px; margin: 6px 0; border-left: 4px solid var(--m-pink); font-size: 11px; }
        .weight-badge { font-size: 10px; font-weight: 900; padding: 2px 5px; border-radius: 4px; background: #333; color: var(--gold); }
        .audit-tag { background: var(--critical); color: white; font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: 900; margin-left: 5px; }

        /* HEATMAP STYLING */
        .heatmap-container { margin-top: 10px; }
        .heatmap-grid { display: grid; grid-template-columns: repeat(24, 1fr); gap: 2px; background: #000; padding: 5px; border-radius: 8px; border: 1px solid #222; }
        .hour-cell { height: 25px; border-radius: 3px; background: #1a1a1a; transition: 0.3s; position: relative; cursor: help; }
        .hour-cell:hover::after { content: attr(data-label); position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: #fff; color: #000; padding: 4px 8px; border-radius: 4px; font-size: 10px; white-space: nowrap; z-index: 100; font-weight: 800; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div>
            <div style="font-family:'Playfair Display'; font-weight:900; color:var(--m-pink); font-size: 1.4rem;">üå∫ MARIPOSA v35.7</div>
            <div style="font-size: 10px; color: var(--pos); font-weight: 900;">‚óè CONTEXTUAL HYBRID ENGINE + HEATMAP</div>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn" style="width:auto; background:#222; color:white; padding: 5px 15px;" onclick="toggleTheme()">üåì UI THEME</button>
            <button class="btn" style="width:auto; background:var(--voucher); color:white; padding: 5px 15px;" onclick="exportData()">üì• MASTER EXCEL</button>
        </div>
    </nav>

    <div class="container">
        <div class="sidebar">
            <div class="card" style="border-top: 4px solid var(--gold);">
                <h4 style="margin:0 0 10px 0; font-size:12px; color:var(--gold);">üß† SENTENCE SYNC (PERMANENT VAULT)</h4>
                <textarea id="newWord" style="height:55px;" placeholder="Phrase (e.g., 'maganda')"></textarea>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                    <select id="newWeight">
                        <option value="-50">Negative (-50)</option>
                        <option value="0">Neutral (0)</option>
                        <option value="50">Positive (+50)</option>
                    </select>
                    <select id="newCat" onchange="toggleOptional()">
                        <option value="Skin">Skin/Clinical</option>
                        <option value="Logistics">Logistics</option>
                        <option value="Rider">Rider Problem</option>
                        <option value="Optional">Optional (Custom)</option>
                    </select>
                </div>
                <input type="text" id="customCat" style="display:none;" placeholder="Define Specific pain point...">
                <textarea id="sysResponse" style="height:55px; border-color:var(--pos);" placeholder="Systematic Response for this term..."></textarea>
                <button onclick="addKnowledge()" class="btn btn-main">üöÄ SYNC TO NEURAL VAULT</button>
                <div id="dictDisplay" style="max-height:150px; overflow-y:auto; margin-top:10px;"></div>
                <small style="color:#666; font-size:9px; text-align:center; display:block; margin-top:5px;">Long-press pattern to delete</small>
            </div>

            <div class="card">
                <h4 style="margin:0 0 5px 0; font-size:11px; color:#888;">BULK DATA INTAKE</h4>
                <textarea id="reviewInput" style="height:100px;" placeholder="Paste customer reviews for analysis..."></textarea>
                <button class="btn btn-main" style="background:var(--pos); color:black;" onclick="processIntake()">‚ö° TRIGGER CONTEXTUAL ANALYSIS</button>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <h4 style="margin:0 0 10px 0; font-size:12px; color:var(--m-pink);">üìä PAINPOINT DISTRIBUTION</h4>
                <div style="height:150px;"><canvas id="painChart"></canvas></div>
            </div>

            <div class="card">
                <h4 style="margin:0 0 10px 0; font-size:12px; color:var(--m-pink);">üå°Ô∏è SENTIMENT HEATMAP (HOURLY INTENSITY)</h4>
                <div id="heatmap" class="heatmap-grid"></div>
                <div style="display:flex; justify-content:space-between; margin-top:8px; font-size:9px; color:#666; font-weight:800;">
                    <span>12 AM</span><span>6 AM</span><span>12 PM</span><span>6 PM</span><span>11 PM</span>
                </div>
            </div>

            <div id="historyList"></div>
        </div>
    </div>

<script>
    // DATA PERSISTENCE
    let db = JSON.parse(localStorage.getItem('m357_db')) || [];
    let knowledge = JSON.parse(localStorage.getItem('m357_kb')) || {
        "maganda": {w: 50, c: "General", r: "Glad you liked it! Use daily for best results."},
        "hapdi": {w: -50, c: "Skin", r: "Safety Protocol: Stop use immediately and rinse with cool water."}
    };
    let painChart;

    const RESEARCH_STRATS = {
        "Skin": { strat: "CLINICAL REDEMPTION", action: "Convert fear to loyalty via medical-grade education." },
        "Logistics": { strat: "RELIABILITY RECOVERY", action: "Absorb courier blame. Offer shipping rebate." },
        "Rider": { strat: "SERVICE ESCALATION", action: "Formal hub complaint + 'Peace Offering' voucher." },
        "Uncertain": { strat: "MANUAL AUDIT", action: "Teach the engine this new phrase for future accuracy." },
        "General": { strat: "NEUTRAL CONVERSION", action: "Provide technical specs to drive sale." }
    };

    function toggleTheme() { document.body.classList.toggle('light-mode'); }
    function toggleOptional() { document.getElementById('customCat').style.display = document.getElementById('newCat').value === 'Optional' ? 'block' : 'none'; }

    // üïµÔ∏è CONTEXTUAL WEIGHTING & NEURAL LOGIC
    function analyze(text) {
        const words = text.toLowerCase().split(/\s+/);
        let finalScore = 0;
        let finalCat = "Uncertain";
        let finalSuggest = "Reviewing sentiment patterns...";
        let found = false;

        const negators = ["hindi", "not", "wala", "ayoko", "never", "failed"];
        const intensifiers = ["sobra", "very", "grabe", "super", "malala", "masyado"];

        Object.keys(knowledge).forEach(k => {
            if (text.toLowerCase().includes(k)) {
                let weight = knowledge[k].w;
                let mult = 1;

                // Context Search (Negative/Intensity)
                words.forEach((w, i) => {
                    if (w.includes(k) || k.includes(w)) {
                        for (let j = Math.max(0, i-2); j < i; j++) {
                            if (negators.includes(words[j])) mult *= -1;
                            if (intensifiers.includes(words[j])) mult *= 1.5;
                        }
                    }
                });

                finalScore = weight * mult;
                finalCat = knowledge[k].c;
                finalSuggest = knowledge[k].r;
                found = true;
            }
        });

        // Sarcasm Check
        if (["wow", "salamat ha", "nice"].some(p => text.toLowerCase().includes(p)) && 
            ["basag", "tagal", "hapdi", "mali"].some(n => text.toLowerCase().includes(n))) {
            finalScore = -65;
            finalCat = "Logistics";
            finalSuggest = "SARCASM DETECTED: Acknowledge the failure immediately. Skip the 'Thank You'.";
        }

        const intel = RESEARCH_STRATS[finalCat] || RESEARCH_STRATS["General"];
        return { 
            text, 
            score: Math.round(finalScore), 
            cat: finalCat, 
            suggest: finalSuggest, 
            hostAction: intel.action, 
            strat: intel.strat, 
            found,
            hour: new Date().getHours() // Capture hour for Heatmap
        };
    }

    function addKnowledge() {
        const sentence = document.getElementById('newWord').value.toLowerCase().trim();
        const weight = parseInt(document.getElementById('newWeight').value);
        let cat = document.getElementById('newCat').value;
        if(cat === 'Optional') cat = document.getElementById('customCat').value || "Custom";
        if(sentence && document.getElementById('sysResponse').value) {
            knowledge[sentence] = { w: weight, c: cat, r: document.getElementById('sysResponse').value };
            save();
            document.getElementById('newWord').value = '';
            document.getElementById('sysResponse').value = '';
        }
    }

    function processIntake() {
        const input = document.getElementById('reviewInput').value.trim();
        input.split('\n').forEach(line => {
            if(line.trim()) db.push({ ...analyze(line), id: Date.now() + Math.random() });
        });
        document.getElementById('reviewInput').value = '';
        save();
    }

    function save() {
        localStorage.setItem('m357_db', JSON.stringify(db));
        localStorage.setItem('m357_kb', JSON.stringify(knowledge));
        render();
    }

    function renderHeatmap() {
        const grid = document.getElementById('heatmap');
        grid.innerHTML = '';
        const scores = Array(24).fill(0);
        const counts = Array(24).fill(0);

        db.forEach(i => {
            scores[i.hour] += i.score;
            counts[i.hour]++;
        });

        for (let h = 0; h < 24; h++) {
            const avg = counts[h] ? scores[h] / counts[h] : 0;
            const cell = document.createElement('div');
            cell.className = 'hour-cell';
            
            let color = '#1a1a1a';
            if (avg < -10) color = `rgba(255, 71, 87, ${Math.min(1, Math.abs(avg)/80)})`;
            else if (avg > 10) color = `rgba(46, 213, 115, ${Math.min(1, avg/80)})`;
            
            cell.style.background = color;
            cell.setAttribute('data-label', `${h}:00 | Avg Score: ${Math.round(avg)}`);
            grid.appendChild(cell);
        }
    }

    function render() {
        document.getElementById('dictDisplay').innerHTML = Object.keys(knowledge).map(k => `
            <div class="kb-term" onmousedown="startHold('${k}')" onmouseup="clearHold()">
                <b>${k}</b> <span class="weight-badge">${knowledge[k].w}</span>
            </div>
        `).join('');

        document.getElementById('historyList').innerHTML = db.slice().reverse().map(i => `
            <div class="card" style="border-left: 6px solid ${i.score > 0 ? 'var(--pos)' : i.score < 0 ? 'var(--critical)' : 'var(--neutral)'}">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <span style="font-size:9px; font-weight:900; background:var(--m-pink); color:black; padding:2px 8px; border-radius:4px;">${i.cat.toUpperCase()}</span>
                        ${!i.found ? '<span class="audit-tag">AUDIT REQ</span>' : ''}
                    </div>
                    <span class="weight-badge">WT: ${i.score}</span>
                </div>
                <p style="font-weight:700; margin:10px 0;">"${i.text}"</p>
                <div class="response-box"><b>üìã SYSTEMATIC REPLY:</b><br>${i.suggest}</div>
                <div class="host-action-box">üí° STRATEGY: ${i.hostAction}</div>
                <button onclick="deleteItem(${i.id})" style="background:none; border:none; color:#444; font-size:9px; margin-top:5px; cursor:pointer;">Delete Entry</button>
            </div>
        `).join('');
        
        renderHeatmap();
        updateChart();
    }

    function updateChart() {
        if(painChart) painChart.destroy();
        const counts = {};
        db.forEach(i => counts[i.cat] = (counts[i.cat] || 0) + 1);
        painChart = new Chart(document.getElementById('painChart'), {
            type: 'bar',
            data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts), backgroundColor: '#ff85a2', borderRadius: 5 }] },
            options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#222' } } } }
        });
    }

    let holdTimer;
    function startHold(k) { holdTimer = setTimeout(() => { if(confirm("Permanently delete this pattern?")) { delete knowledge[k]; save(); } }, 800); }
    function clearHold() { clearTimeout(holdTimer); }
    function deleteItem(id) { db = db.filter(i => i.id !== id); save(); }
    function exportData() {
        const ws = XLSX.utils.json_to_sheet(db);
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Report");
        XLSX.writeFile(wb, "Mariposa_v357_Master.xlsx");
    }

    render();
</script>
</body>
</html>

